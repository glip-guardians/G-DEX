<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>G-DEX — GLIP</title>

  <!-- PWA (optional) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="G_DEX_icon.png">
  <link rel="apple-touch-icon" href="G_DEX_icon.png">
  <meta name="theme-color" content="#ffffff" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --stroke:rgba(0,0,0,.08);
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --text:#0f172a;
      --muted:rgba(15, 23, 42, .65);
      --blue:#3b82f6;
      --green:#10b981;
      --red:#ef4444;
      --radius:20px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(900px 380px at 10% -10%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(900px 380px at 100% 0%, rgba(16,185,129,.18), transparent 65%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:20px 14px 80px;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:99;
      backdrop-filter: blur(10px);
      background: rgba(244,246,251,.75);
      border-bottom:1px solid var(--stroke);
      padding:10px 14px;
    }
    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .brand img{
      width:34px;height:34px;border-radius:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      background:#fff;
      object-fit:cover;
    }
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: #fff;
      border-radius: 999px;
      padding: 12px 14px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      transition: transform .08s ease, opacity .2s ease;
      user-select:none;
      color:var(--text);
    }
    .btn:active{transform: scale(.98)}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .btn.primary{
      border-color: rgba(59,130,246,.25);
      background: linear-gradient(180deg, rgba(59,130,246,.16), rgba(59,130,246,.08));
      color:#0b2a66;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width:920px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .pill img{width:22px;height:22px;border-radius:999px; object-fit:cover}
    .inputbox{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background:#fff;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      padding:12px;
    }
    .inputhead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .amountrow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    input.amount{
      width:100%;
      font-size:30px;
      font-weight:800;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      min-width:0;
      -webkit-appearance:none;
      appearance:none;
      padding:0;
      line-height:1.1;
    }
    /* ✅ 모바일 숫자 입력 안정화 */
    input.amount{
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    .mini{
      font-size:12px;
      color:var(--muted);
    }
    .swapmid{
      display:flex;
      justify-content:center;
      margin:12px 0;
    }
    .circlebtn{
      width:44px;height:44px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
      cursor:pointer;
      font-size:18px;
    }
    .circlebtn:active{transform:scale(.98)}
    .line{
      height:1px;
      background:var(--stroke);
      margin:12px 0;
    }
    .sliprow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sliprow input{
      width:90px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      outline:none;
      font-weight:800;
    }
    .status{
      margin-top:10px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: #fff;
      padding:12px;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      word-break:break-word;
    }
    .status.ok{border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.06)}
    .status.err{border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.06); color:#7f1d1d}
    .status.warn{border-color: rgba(59,130,246,.25); background: rgba(59,130,246,.06)}
    .bigcta{
      width:100%;
      padding:16px 14px;
      border-radius: 18px;
      border:1px solid rgba(59,130,246,.25);
      background: linear-gradient(180deg, rgba(59,130,246,.14), rgba(59,130,246,.06));
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(59,130,246,.18);
    }
    .bigcta:active{transform:scale(.99)}
    .bigcta[disabled]{opacity:.6; cursor:not-allowed}
    .tinyhint{font-size:12px;color:var(--muted); margin-top:8px}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>

  <!-- ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="G_DEX_icon.png" alt="G-DEX">
        <div>G-DEX</div>
      </div>
      <button id="btnConnect" class="btn primary">Connect</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>Swap</h2>
        <div class="muted" style="font-size:13px; margin-bottom:12px;">
          Mobile-safe swap flow (no hard timeout failure)
        </div>

        <!-- SELL -->
        <div class="inputbox">
          <div class="inputhead">
            <div id="sellBalLabel">Bal: —</div>
            <div class="row" style="gap:8px;">
              <button id="btnMax" class="btn" style="padding:10px 12px;">MAX</button>
              <div id="sellTokenPill" class="pill">
                <img id="sellTokenIcon" src="https://assets.coingecko.com/coins/images/325/large/Tether.png" alt="">
                <span id="sellTokenSym">USDT</span>
              </div>
            </div>
          </div>
          <div class="amountrow">
            <input id="sellAmount" class="amount" inputmode="decimal" autocomplete="off" autocorrect="off" spellcheck="false" placeholder="0" />
          </div>
        </div>

        <div class="swapmid">
          <button id="btnFlip" class="circlebtn" title="Flip">⇅</button>
        </div>

        <!-- BUY -->
        <div class="inputbox">
          <div class="inputhead">
            <div id="buyBalLabel">Bal: —</div>
            <div class="row" style="gap:8px;">
              <div id="buyTokenPill" class="pill">
                <img id="buyTokenIcon" src="GLIP.png" alt="">
                <span id="buyTokenSym">GLIP</span>
              </div>
            </div>
          </div>
          <div class="amountrow">
            <input id="buyAmount" class="amount" inputmode="decimal" autocomplete="off" autocorrect="off" spellcheck="false" placeholder="0" disabled />
          </div>
        </div>

        <div class="line"></div>

        <div class="row">
          <div class="sliprow">
            <div style="font-weight:800;">Slippage</div>
            <input id="slippage" value="3" />
            <div style="font-weight:900;">%</div>
          </div>
          <div class="mini" id="feeHint">Flat fee: 0.00003 ETH</div>
        </div>

        <div style="margin-top:14px;">
          <button id="btnSwap" class="bigcta" disabled>Swap</button>
          <div class="tinyhint" id="modeHint"></div>
          <div id="statusBox" class="status">Not connected.</div>
        </div>
      </div>

      <div class="card">
        <h2>Notes</h2>
        <div class="muted" style="font-size:13px; line-height:1.5;">
          • If there is <b>NO tx hash</b>, it failed before sending (callStatic/estimateGas).<br/>
          • Make sure you are on <b>Ethereum Mainnet</b>.<br/>
          • For proxy swaps, ensure you have enough ETH for <b>flat fee + gas</b>.<br/>
          • Proxy mode spender = <b>Proxy Router</b>, Direct mode spender = <b>Sushi Router</b>.<br/>
          • If liquidity is thin, try higher slippage (10%~35%).<br/><br/>
          ✅ This build removes “wallet confirmation timeout = hard fail” so mobile won’t freeze.
        </div>
        <div style="margin-top:12px;" class="status warn">
          If you are on mobile and confirmations don’t open, use <b>MetaMask in-app browser</b>.
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   ✅ CONFIG (너 환경에 맞게)
   ========================= */

// ✅ MUST: 네 GLIP 토큰 주소로 바꿔야 함
const GLIP_TOKEN = "0x0000000000000000000000000000000000000000"; // TODO: set GLIP token address

// ✅ USDT (Mainnet)
const USDT_TOKEN = "0xdAC17F958D2ee523a2206206994597C13D831ec7";

// ✅ SushiSwap V2 Router (Mainnet)
const SUSHI_ROUTER = "0xd9e1cE17f2641f24aE83637ab66a2cca9C378B9F";

// ✅ 너가 쓰는 Proxy Router (대화 로그에 보였던 주소들 중 하나로 기본 설정)
// - 이전 에러 로그 to: 0x198C5B84... / 0xEc4fAF9F...
// 실제 운영에 쓰는 주소로 확정해서 하나만 쓰는 게 좋음.
const PROXY_ROUTER = "0x198C5B84dB9B1139092EDd9D56bE25653fEAC13D";

// ✅ proxy flat fee (네 설계대로)
const FLAT_FEE_ETH = "0.00003";

// ✅ safe gas (대략)
const SAFE_GAS_PROXY  = 520000;
const SAFE_GAS_DIRECT = 320000;

// ✅ wallet confirm watchdog (모바일에서 45초는 너무 짧음)
const WALLET_WARN_MS = 90000;

// chain id
const MAINNET_CHAIN_ID = 1;

/* =========================
   ✅ Minimal ABIs
   ========================= */
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];

const SUSHI_ROUTER_ABI = [
  "function WETH() view returns (address)",
  "function getAmountsOut(uint256 amountIn, address[] memory path) view returns (uint256[] memory amounts)",
  "function swapExactTokensForTokens(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) returns (uint256[] memory amounts)",
  "function swapExactETHForTokens(uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) payable returns (uint256[] memory amounts)",
  "function swapExactTokensForETH(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) returns (uint256[] memory amounts)"
];

// ⚠️ Proxy Router ABI는 네 컨트랙트 시그니처에 맞춰야 함.
// 아래는 “너가 기존에 쓰던 형태”가 다양한데, 여기서는 가장 흔한 형태 3가지를 준비해두고
// 존재하는 함수로 자동 선택(try/catch)하는 방식으로 보냄.
const PROXY_ROUTER_ABI = [
  // style A
  "function swapExactTokensForTokens(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) payable returns (uint256[] memory amounts)",
  "function swapExactETHForTokens(uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) payable returns (uint256[] memory amounts)",
  "function swapExactTokensForETH(uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) payable returns (uint256[] memory amounts)",

  // style B (tokenInParam)
  "function swapExactTokensForTokensSupportingFeeOnTransferTokens(address tokenIn,uint256 amountIn,uint256 amountOutMin,address[] calldata path,address to,uint256 deadline) payable",
];

/* =========================
   ✅ State
   ========================= */
let provider, signer, user;
let sell = { sym:"USDT", addr:USDT_TOKEN, icon:"https://assets.coingecko.com/coins/images/325/large/Tether.png", decimals:6 };
let buy  = { sym:"GLIP", addr:GLIP_TOKEN, icon:"GLIP.png", decimals:18 };

let isBusy = false;
let directMode = false; // 필요시 토글 가능 (여기선 자동 선택 느낌으로 표시만)

const $ = (id)=>document.getElementById(id);

/* =========================
   ✅ Helpers
   ========================= */
function setStatus(html, kind=""){
  const el = $("statusBox");
  el.className = "status" + (kind ? " " + kind : "");
  el.innerHTML = html;
}

function isMobile(){
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function isMetaMaskInApp(){
  return /MetaMaskMobile/i.test(navigator.userAgent) ||
         (window.ethereum && window.ethereum.isMetaMask && isMobile());
}

function openMetaMaskDeepLink(){
  // opens current URL in MetaMask (mobile)
  const url = location.href.replace(/^https?:\/\//, "");
  const deeplink = "https://metamask.app.link/dapp/" + url;
  window.location.href = deeplink;
}

function fmt(bn, dec, max=6){
  if(!bn) return "0";
  const s = ethers.utils.formatUnits(bn, dec);
  // trim
  const [i,f=""] = s.split(".");
  if(!f) return i;
  return i + "." + f.slice(0, max);
}

async function sendWithWatchdog(sendPromise, ms, onWarn){
  let done = false;
  const t = setTimeout(()=>{
    if(done) return;
    try{ onWarn && onWarn(); }catch(e){}
    // ✅ NO reject/throw here. This is the key for mobile "timeout freeze" fix.
  }, ms);

  try{
    const tx = await sendPromise;
    done = true;
    clearTimeout(t);
    return tx;
  }catch(e){
    done = true;
    clearTimeout(t);
    throw e;
  }
}

function parseAmount(str){
  const v = (str||"").trim().replace(/,/g,"");
  if(!v) return null;
  if(!/^\d*\.?\d*$/.test(v)) return null;
  return v;
}

function deadlineUnix(){
  return Math.floor(Date.now()/1000) + 60*20;
}

function clampSlippage(){
  const raw = parseFloat(($("slippage").value||"").trim());
  if(!isFinite(raw) || raw <= 0) return 1;
  if(raw > 99) return 99;
  return raw;
}

/* =========================
   ✅ UI bind
   ========================= */
function bindUI(){
  $("btnConnect").addEventListener("click", connect);
  $("btnFlip").addEventListener("click", flipTokens);
  $("btnMax").addEventListener("click", fillMax);
  $("sellAmount").addEventListener("input", ()=>{
    // keep buy preview blank until quote (optional)
    $("buyAmount").value = "";
    if(user) quote().catch(()=>{});
  });
  $("slippage").addEventListener("change", ()=>{ if(user) quote().catch(()=>{}); });
  $("btnSwap").addEventListener("click", ()=>{ executeSwap().catch(console.error); });

  $("modeHint").innerHTML =
    `Mode: <b>${directMode ? "Direct (Sushi Router)" : "Proxy (G-DEX Router)"}</b>`;
}

function syncTokenUI(){
  $("sellTokenSym").textContent = sell.sym;
  $("buyTokenSym").textContent  = buy.sym;
  $("sellTokenIcon").src = sell.icon;
  $("buyTokenIcon").src  = buy.icon;
  $("feeHint").textContent = "Flat fee: " + FLAT_FEE_ETH + " ETH";
  $("modeHint").innerHTML =
    `Mode: <b>${directMode ? "Direct (Sushi Router)" : "Proxy (G-DEX Router)"}</b>`;
}

async function flipTokens(){
  const tmp = sell; sell = buy; buy = tmp;
  syncTokenUI();
  $("sellAmount").value = "";
  $("buyAmount").value = "";
  if(user) await refreshBalances();
}

async function fillMax(){
  if(!user) return;
  try{
    const bal = await getBalanceOf(sell, user);
    // MAX는 수수료/가스 고려가 복잡하므로 여기선 토큰/USDT는 전액, ETH는 일부 남김 처리를 넣을 수 있음.
    $("sellAmount").value = fmt(bal, sell.decimals, sell.decimals===6 ? 6 : 6);
    await quote();
  }catch(e){}
}

/* =========================
   ✅ Wallet / Chain
   ========================= */
async function connect(){
  try{
    if(!window.ethereum){
      setStatus("No wallet detected. Install MetaMask.", "err");
      return;
    }

    // ✅ 모바일이면 MetaMask 인앱 브라우저 유도(권장)
    if(isMobile() && !isMetaMaskInApp()){
      setStatus(
        "Mobile swap requires <b>MetaMask in-app browser</b>.<br>Redirecting…",
        "warn"
      );
      setTimeout(openMetaMaskDeepLink, 350);
      return;
    }

    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    user = await signer.getAddress();

    // chain check
    const net = await provider.getNetwork();
    if(net.chainId !== MAINNET_CHAIN_ID){
      setStatus("Wrong network. Please switch to <b>Ethereum Mainnet</b>.", "err");
      $("btnSwap").disabled = true;
      return;
    }

    $("btnConnect").textContent = "Connected";
    $("btnConnect").disabled = true;

    // load decimals
    await hydrateTokenMeta();

    await refreshBalances();
    $("btnSwap").disabled = false;
    setStatus("Connected. Enter amount to swap.", "ok");

    // listeners
    window.ethereum.on?.("chainChanged", ()=>location.reload());
    window.ethereum.on?.("accountsChanged", ()=>location.reload());

  }catch(e){
    setStatus("Connect failed: " + (e?.message || String(e)), "err");
  }
}

async function hydrateTokenMeta(){
  try{
    // USDT
    const usdt = new ethers.Contract(USDT_TOKEN, ERC20_ABI, provider);
    sell.decimals = await usdt.decimals().catch(()=>6);
  }catch(e){}
  try{
    // GLIP
    if(buy.addr && buy.addr !== "0x0000000000000000000000000000000000000000"){
      const glip = new ethers.Contract(buy.addr, ERC20_ABI, provider);
      buy.decimals = await glip.decimals().catch(()=>18);
    } else {
      buy.decimals = 18;
    }
  }catch(e){}
}

/* =========================
   ✅ Balances
   ========================= */
async function getBalanceOf(token, who){
  if(token.sym === "ETH"){
    return await provider.getBalance(who);
  }
  const c = new ethers.Contract(token.addr, ERC20_ABI, provider);
  return await c.balanceOf(who);
}

async function refreshBalances(){
  if(!user) return;
  const sellBal = await getBalanceOf(sell, user).catch(()=>null);
  const buyBal  = await getBalanceOf(buy, user).catch(()=>null);
  $("sellBalLabel").textContent = "Bal: " + (sellBal ? fmt(sellBal, sell.decimals, 6) : "—") + " " + sell.sym;
  $("buyBalLabel").textContent  = "Bal: " + (buyBal  ? fmt(buyBal,  buy.decimals,  6) : "—") + " " + buy.sym;
}

/* =========================
   ✅ Quote (optional preview)
   ========================= */
async function quote(){
  const amtStr = parseAmount($("sellAmount").value);
  if(!amtStr) { $("buyAmount").value = ""; return; }
  if(!provider) return;

  // path: sell -> buy (simple 2 hop)
  const path = [sell.addr, buy.addr];

  // cannot quote if GLIP addr not set
  if(path[1] === "0x0000000000000000000000000000000000000000"){
    $("buyAmount").value = "";
    setStatus("Set <b>GLIP_TOKEN</b> address in config first.", "warn");
    return;
  }

  const router = new ethers.Contract(SUSHI_ROUTER, SUSHI_ROUTER_ABI, provider);
  const amountIn = ethers.utils.parseUnits(amtStr, sell.decimals);

  try{
    const amounts = await router.getAmountsOut(amountIn, path);
    const out = amounts[amounts.length - 1];
    $("buyAmount").value = fmt(out, buy.decimals, 6);
  }catch(e){
    $("buyAmount").value = "";
    // quote 실패는 흔함(유동성 얇거나 path 불가)
  }
}

/* =========================
   ✅ Approve helper
   ========================= */
async function ensureAllowance(token, spender, amountBN){
  if(token.sym === "ETH") return;

  const c = new ethers.Contract(token.addr, ERC20_ABI, signer);
  const allowance = await c.allowance(user, spender);
  if(allowance.gte(amountBN)) return;

  setStatus(`Approving ${token.sym}… Please confirm in wallet.`, "warn");

  const tx = await sendWithWatchdog(
    c.approve(spender, ethers.constants.MaxUint256),
    WALLET_WARN_MS,
    ()=>{
      setStatus(
        "Waiting for MetaMask confirmation…<br>" +
        "If no popup: open MetaMask → Activity / Pending requests.",
        "warn"
      );
    }
  );

  setStatus(`Approve sent: <code>${tx.hash}</code><br>Waiting…`, "warn");
  await tx.wait();
  setStatus(`Approve confirmed.`, "ok");
}

/* =========================
   ✅ Swap (핵심: 모바일 timeout freeze 제거)
   ========================= */
async function executeSwap(){
  if(isBusy) return;
  if(!user) return;

  const amtStr = parseAmount($("sellAmount").value);
  if(!amtStr){ setStatus("Enter amount.", "err"); return; }

  // chain check
  const net = await provider.getNetwork();
  if(net.chainId !== MAINNET_CHAIN_ID){
    setStatus("Wrong network. Switch to Ethereum Mainnet.", "err");
    return;
  }

  if(buy.addr === "0x0000000000000000000000000000000000000000"){
    setStatus("Config error: set GLIP_TOKEN address.", "err");
    return;
  }

  isBusy = true;
  $("btnSwap").disabled = true;

  try{
    const sl = clampSlippage();
    const amountIn = ethers.utils.parseUnits(amtStr, sell.decimals);

    // path
    const path = [sell.addr, buy.addr];
    const to = user;
    const deadline = deadlineUnix();

    // outMin (try via getAmountsOut; if fail, fallback to 0)
    let outMin = ethers.constants.Zero;
    try{
      const routerRead = new ethers.Contract(SUSHI_ROUTER, SUSHI_ROUTER_ABI, provider);
      const amounts = await routerRead.getAmountsOut(amountIn, path);
      const out = amounts[amounts.length-1];
      // outMin = out * (1 - slippage)
      outMin = out.mul(10000 - Math.floor(sl*100)).div(10000);
    }catch(e){
      // liquidity thin or quote fail
      outMin = ethers.constants.Zero;
    }

    // choose spender based on mode
    const spender = directMode ? SUSHI_ROUTER : PROXY_ROUTER;

    // approve if needed
    await ensureAllowance(sell, spender, amountIn);

    setStatus("Processing…", "warn");

    let tx;
    if(directMode){
      // DIRECT: Sushi router
      const router = new ethers.Contract(SUSHI_ROUTER, SUSHI_ROUTER_ABI, signer);

      // Only token->token in this minimal build
      const sendPromise = router.swapExactTokensForTokens(
        amountIn,
        outMin,
        path,
        to,
        deadline,
        { gasLimit: SAFE_GAS_DIRECT }
      );

      tx = await sendWithWatchdog(sendPromise, WALLET_WARN_MS, ()=>{
        // ✅ 핵심: 타임아웃에 실패(reject)하지 않고 UI만 풀어줌
        isBusy = false;
        $("btnSwap").disabled = false;
        setStatus(
          "Waiting for MetaMask confirmation…<br>" +
          "If no popup: open MetaMask → Activity (Pending) and check the request.<br>" +
          "You can try again if nothing appears.",
          "warn"
        );
      });

    } else {
      // PROXY: G-DEX router
      const pr = new ethers.Contract(PROXY_ROUTER, PROXY_ROUTER_ABI, signer);

      // flat fee
      const feeValue = ethers.utils.parseEther(FLAT_FEE_ETH);

      // send using best-available function
      let sendPromise;

      // 1) try standard swapExactTokensForTokens (payable)
      try{
        sendPromise = pr.swapExactTokensForTokens(
          amountIn,
          outMin,
          path,
          to,
          deadline,
          { value: feeValue, gasLimit: SAFE_GAS_PROXY }
        );
      }catch(e){
        sendPromise = null;
      }

      // 2) fallback: SupportingFeeOnTransferTokens(tokenIn, ...)
      if(!sendPromise){
        sendPromise = pr.swapExactTokensForTokensSupportingFeeOnTransferTokens(
          sell.addr,
          amountIn,
          outMin,
          path,
          to,
          deadline,
          { value: feeValue, gasLimit: SAFE_GAS_PROXY }
        );
      }

      tx = await sendWithWatchdog(sendPromise, WALLET_WARN_MS, ()=>{
        // ✅ 핵심: 모바일 “확인창 늦음”을 실패로 처리하지 않음
        isBusy = false;
        $("btnSwap").disabled = false;
        setStatus(
          "Waiting for MetaMask confirmation…<br>" +
          "If no popup: open MetaMask → Activity (Pending) and check the request.<br>" +
          "Tip: on mobile, keep MetaMask in foreground during confirm.",
          "warn"
        );
      });
    }

    if(!tx || !tx.hash){
      // 워치독이 UI를 풀었지만 tx가 아직 없는 케이스 가능
      // tx가 생기면 아래로 이어지게 되고, 안 생기면 여기서 종료
      // (사용자가 다시 시도 가능)
      return;
    }

    setStatus(
      `Swap transaction sent!<br>` +
      `TX: <code>${tx.hash}</code><br>` +
      `Etherscan: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noreferrer">Open</a>`,
      "ok"
    );

    await tx.wait();

    setStatus(
      `Swap confirmed ✅<br>` +
      `TX: <code>${tx.hash}</code><br>` +
      `Etherscan: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noreferrer">Open</a>`,
      "ok"
    );

    $("sellAmount").value = "";
    $("buyAmount").value = "";
    await refreshBalances();

  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);

    // gas estimation revert 등 흔한 케이스 안내
    if(/UNPREDICTABLE_GAS_LIMIT|cannot estimate gas|estimateGas/i.test(msg)){
      setStatus(
        "Gas estimation failed (revert).<br>" +
        "• Try higher slippage (10%~35%) if liquidity is thin.<br>" +
        "• Ensure Mainnet & enough ETH for flat fee + gas.<br>" +
        "• If no tx hash, it failed before sending.",
        "err"
      );
    } else if(/user rejected|denied|rejected/i.test(msg)){
      setStatus("User rejected in wallet.", "err");
    } else {
      setStatus("Swap failed: " + msg, "err");
    }
  } finally {
    isBusy = false;
    $("btnSwap").disabled = false;
  }
}

/* =========================
   ✅ Init
   ========================= */
(function init(){
  bindUI();
  syncTokenUI();
  // service worker optional
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js").catch(()=>{});
    });
  }
})();
</script>
</body>
</html>
