<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>G-DEX — GLIP</title>

<!-- ✅ Legacy backend constant (kept for compatibility; NOT used here) -->
<script>
  const BACKEND_URL = "https://gdex-backend.onrender.com".replace(/\/$/, "");
</script>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="G_DEX_icon.png">
<link rel="apple-touch-icon" href="G_DEX_icon.png">
<meta name="theme-color" content="#ffffff" />

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js").catch(console.error);
    });
  }
</script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Ethers (wallet connect) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  :root{
    --headerH: 84px;

    --bg0:#050A0C;
    --bg1:#071317;
    --card:rgba(255,255,255,0.06);
    --card2:rgba(255,255,255,0.08);
    --line:rgba(255,255,255,0.10);

    --ink:#EAF7F0;
    --ink2:#D6F0E4;
    --muted:#B8D6C8;
    --muted2:#9ABFB0;

    --acc:#00FFB3;
    --acc2:#00C2FF;
    --warn:#FFB000;

    --r:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1200px 700px at 15% -10%, rgba(0,255,179,0.18), transparent 65%),
      radial-gradient(1100px 700px at 110% 110%, rgba(0,194,255,0.14), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,0.05), transparent 35%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }

  a{color:inherit}
  .wrap{max-width:1180px;margin:0 auto;padding: calc(var(--headerH) + 24px) 18px 40px;}

  /* Header */
  header{
    position:fixed;top:0;left:0;right:0;z-index:9999;
    height:var(--headerH);
    display:flex;align-items:center;
    background:rgba(5,10,12,0.62);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .hInner{max-width:1180px;margin:0 auto;width:100%;padding:0 18px;display:flex;align-items:center;gap:14px;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
  .brand img{width:34px;height:34px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .nav{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.06);
    text-decoration:none;
    font-weight:700;
    color:var(--ink);
  }
  .pill:hover{background:rgba(255,255,255,0.09)}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:11px 14px;border-radius:12px;
    border:1px solid rgba(0,255,179,0.35);
    background:linear-gradient(180deg, rgba(0,255,179,0.18), rgba(0,255,179,0.08));
    color:var(--ink);
    font-weight:800;
    cursor:pointer;
    text-decoration:none;
    user-select:none;
  }
  .btn:hover{filter:brightness(1.04)}
  .btn.secondary{
    border:1px solid var(--line);
    background:rgba(255,255,255,0.06);
    font-weight:800;
  }

  /* Layout */
  .hero{
    display:flex;align-items:flex-end;justify-content:space-between;gap:16px;
    margin-bottom:18px;
  }
  .hero h1{margin:0;font-size:28px;letter-spacing:-0.3px}
  .hero p{margin:6px 0 0;color:var(--muted);max-width:740px;line-height:1.45}
  .grid{
    display:grid;
    grid-template-columns: 1.25fr .85fr;
    gap:14px;
    align-items:start;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .hd{
    padding:14px 14px 10px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    border-bottom:1px solid rgba(255,255,255,0.08);
  }
  .card .hd h3{margin:0;font-size:14px;letter-spacing:.25px;text-transform:uppercase;color:var(--ink2)}
  .card .bd{padding:14px}
  .muted{color:var(--muted)}
  .tiny{font-size:12px;color:var(--muted2)}
  .sep{height:1px;background:rgba(255,255,255,0.08);margin:12px 0}

  /* Swap */
  .swapBox{display:flex;flex-direction:column;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field{
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.18);
    border-radius:14px;
    padding:12px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .field .left{display:flex;flex-direction:column;gap:4px;min-width:140px}
  .label{font-size:12px;color:var(--muted2);font-weight:700}
  input.amount{
    width:100%;
    font-size:20px;
    font-weight:800;
    color:var(--ink);
    background:transparent;
    border:0;
    outline:0;
  }
  .tokenBtn{
    display:inline-flex;align-items:center;gap:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    cursor:pointer;
    font-weight:900;
  }
  .tokenBtn img{width:22px;height:22px;border-radius:999px}
  .tokenBtn .sym{letter-spacing:.2px}
  .swapActions{display:flex;gap:10px;flex-wrap:wrap}

  /* Token modal */
  .modalBack{
    position:fixed;inset:0;z-index:99999;
    background:rgba(0,0,0,0.55);
    display:none;align-items:center;justify-content:center;
    padding:18px;
  }
  .modal{
    width:min(520px, 100%);
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background:linear-gradient(180deg, rgba(20,32,30,0.92), rgba(10,16,15,0.92));
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    overflow:hidden;
  }
  .modal .mhd{padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,0.10);display:flex;align-items:center;justify-content:space-between}
  .modal .mhd b{font-size:14px;letter-spacing:.2px}
  .modal .mbd{padding:12px 14px 14px}
  .search{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(0,0,0,0.20);
    color:var(--ink);
    outline:none;
    font-weight:700;
  }
  .list{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:340px;overflow:auto}
  .tokRow{
    display:flex;align-items:center;gap:10px;
    padding:10px 10px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(255,255,255,0.05);
    cursor:pointer;
  }
  .tokRow:hover{background:rgba(255,255,255,0.08)}
  .tokRow img{width:26px;height:26px;border-radius:999px}
  .tokRow .meta{display:flex;flex-direction:column}
  .tokRow .meta .sym{font-weight:900}
  .tokRow .meta .addr{font-size:11px;color:var(--muted2)}

  /* Metrics cards */
  .metrics{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
  }
  @media (max-width: 980px){ .metrics{grid-template-columns:1fr} }

  .metric{
    /* ✅ 핵심: 데스크탑에서 보이던 "아랫 공란"을 없애기 위한 구조 */
    display:flex;
    flex-direction:column;
    min-height: 210px; /* 원래 카드 높이 느낌 유지 */
  }
  .metric h4{
    margin:0;
    font-size:14px;
    font-weight:900;
    color:var(--ink2);
    letter-spacing:.2px;
  }
  .metric .bd{
    flex:1;
    display:flex;
    flex-direction:column;
  }
  .metric .v{
    flex:1;
    display:flex;
    flex-direction:column;
    justify-content:space-between; /* ✅ 상단 컨텐츠 + 하단 보조영역으로 자연스럽게 채움 */
    gap:12px;
    min-height: 0;
  }

  .ticker{
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.18);
    border-radius:14px;
    padding:12px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .ticker a{text-decoration:none;display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%}
  .pair{font-weight:900}
  .metaLine{font-size:12px;color:var(--muted);text-align:right}

  .metricFoot{
    border-top:1px solid rgba(255,255,255,0.08);
    padding-top:10px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    flex-wrap:wrap;
  }
  .statusPill{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.05);
    font-size:12px;
    font-weight:800;
    color:var(--muted);
  }
  .dot{
    width:8px;height:8px;border-radius:999px;background:var(--acc);
    box-shadow:0 0 18px rgba(0,255,179,.55);
  }
  .miniBtns{display:flex;gap:8px;flex-wrap:wrap}
  .mini{
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.05);
    text-decoration:none;
    font-size:12px;
    font-weight:900;
  }
  .mini:hover{background:rgba(255,255,255,0.08)}

  /* Major prices list */
  .priceList{display:flex;flex-direction:column;gap:8px}
  .pRow{
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.18);
    border-radius:14px;
    padding:10px 12px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .pLeft{display:flex;align-items:center;gap:10px}
  .pLeft img{width:22px;height:22px;border-radius:999px}
  .pName{font-weight:900}
  .pRight{text-align:right}
  .chg{font-size:12px;font-weight:900}
  .up{color:#35ffb7}
  .dn{color:#ff6b6b}

  /* Right column cards */
  .rightCol{display:flex;flex-direction:column;gap:14px}

  /* GLIP price iframe */
  .iframeWrap{
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.18);
    border-radius:14px;
    overflow:hidden;
  }
  .iframeWrap iframe{
    width:100%;
    height:420px;
    border:0;
    display:block;
  }
  @media (max-width: 520px){
    .iframeWrap iframe{height:380px}
  }

  /* Toast */
  .toast{
    position:fixed;left:18px;bottom:18px;z-index:999999;
    max-width:min(520px, calc(100% - 36px));
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(0,0,0,0.70);
    backdrop-filter: blur(10px);
    padding:12px 14px;
    display:none;
    box-shadow:0 20px 60px rgba(0,0,0,.55);
  }
  .toast b{display:block;margin-bottom:4px}
  .toast .tbtns{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .toast .tbtn{
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.05);
    font-weight:900;font-size:12px;
    cursor:pointer;
    color:var(--ink);
  }
</style>
</head>

<body>
<header>
  <div class="hInner">
    <div class="brand">
      <img src="G_DEX_icon.png" alt="G-DEX">
      <div>
        <div style="font-size:14px;line-height:1;font-weight:900;">G-DEX</div>
        <div class="tiny" style="margin-top:2px;">GLIP DEX Interface</div>
      </div>
    </div>

    <nav class="nav">
      <a class="pill" href="https://glipchain.com" target="_blank" rel="noopener">GLIP</a>
      <a class="pill" href="https://gdex-app.com" target="_blank" rel="noopener">Exchange</a>
      <button class="btn" id="btnConnect">Connect Wallet</button>
    </nav>
  </div>
</header>

<div class="wrap">
  <div class="hero">
    <div>
      <h1>G-DEX v1 Beta</h1>
      <p>
        A clean GLIP-focused swap interface. For best routing & execution, swaps open on SushiSwap with your selected tokens.
      </p>
    </div>
    <div class="tiny" id="netLine">Network: —</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <!-- Swap card -->
      <div class="card">
        <div class="hd">
          <h3>Swap</h3>
          <div class="tiny" id="addrLine">Not connected</div>
        </div>
        <div class="bd">
          <div class="swapBox">
            <div class="field">
              <div class="left">
                <div class="label">You pay</div>
                <input class="amount" id="amtIn" inputmode="decimal" placeholder="0.0" />
                <div class="tiny" id="balIn">Balance: —</div>
              </div>
              <button class="tokenBtn" id="pickIn">
                <img id="inIcon" alt="" />
                <span class="sym" id="inSym">—</span>
              </button>
            </div>

            <div class="row" style="justify-content:center">
              <button class="btn secondary" id="btnFlip" title="Flip">↕ Flip</button>
              <div class="tiny" id="pxLine">Quote: —</div>
            </div>

            <div class="field">
              <div class="left">
                <div class="label">You receive</div>
                <input class="amount" id="amtOut" inputmode="decimal" placeholder="0.0" disabled />
                <div class="tiny" id="balOut">Balance: —</div>
              </div>
              <button class="tokenBtn" id="pickOut">
                <img id="outIcon" alt="" />
                <span class="sym" id="outSym">—</span>
              </button>
            </div>

            <div class="swapActions">
              <button class="btn" id="btnSwap">Open Swap</button>
              <a class="btn secondary" id="btnPool" target="_blank" rel="noopener">View Pools</a>
            </div>

            <div class="tiny">
              Tip: If you’re on the wrong network, switch to <b>Ethereum Mainnet</b> and refresh.
            </div>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- Metrics row -->
      <div class="metrics">
        <!-- Recently created pools -->
        <div class="card metric">
          <div class="hd">
            <h3>On-chain</h3>
            <div class="tiny" id="poolsUpdated">—</div>
          </div>
          <div class="bd">
            <div class="v" id="metricPoolsText">
              <div>
                <h4>Recently Created Pools</h4>
                <div style="height:10px"></div>

                <div class="ticker">
                  <a class="poolsItem" id="poolsTickerLink" href="https://www.sushi.com/ethereum/explore/pools" target="_blank" rel="noopener">
                    <span class="pair" id="poolsTickerPair">—</span>
                    <span class="metaLine" id="poolsTickerMeta"></span>
                  </a>
                </div>

                <div class="tiny" style="margin-top:8px" id="poolsHint">
                  Showing the latest pool signal feed (best-effort).
                </div>
              </div>

              <!-- ✅ 공란을 “상태 + CTA”로 채워 완성도 개선 -->
              <div class="metricFoot">
                <span class="statusPill"><span class="dot"></span><span id="poolsStatus">Live sync</span></span>
                <div class="miniBtns">
                  <a class="mini" href="https://www.sushi.com/ethereum/explore/pools" target="_blank" rel="noopener">Explore</a>
                  <a class="mini" href="https://www.sushi.com/ethereum/explore/tokens" target="_blank" rel="noopener">Tokens</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Major coin prices -->
        <div class="card metric">
          <div class="hd">
            <h3>Market</h3>
            <div class="tiny" id="majorUpdated">—</div>
          </div>
          <div class="bd">
            <div class="v">
              <div>
                <h4>Major Coin Prices</h4>
                <div style="height:10px"></div>

                <div class="priceList" id="majorList">
                  <!-- rows injected -->
                </div>

                <div class="tiny" style="margin-top:8px" id="majorHint">
                  Prices are fetched from a public market API (best-effort).
                </div>
              </div>

              <!-- ✅ 공란을 “상태 + CTA”로 채워 완성도 개선 -->
              <div class="metricFoot">
                <span class="statusPill"><span class="dot"></span><span id="majorStatus">Auto refresh</span></span>
                <div class="miniBtns">
                  <a class="mini" href="https://www.coingecko.com" target="_blank" rel="noopener">Open Market</a>
                  <a class="mini" href="https://www.sushi.com/ethereum/swap" target="_blank" rel="noopener">Swap</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /metrics -->
    </div>

    <!-- RIGHT -->
    <div class="rightCol">
      <!-- GLIP price card -->
      <div class="card">
        <div class="hd">
          <h3>GLIP Price</h3>
          <div class="tiny">DEXTools</div>
        </div>
        <div class="bd">
          <div class="iframeWrap">
            <iframe
              id="dextools-widget"
              title="DEXTools Trading Chart"
              src="https://www.dextools.io/widget-chart/en/ether/pe-light/0xd304b9c49f389f27c5e75e1469e903da5320d3b4?theme=light&chartType=2&chartResolution=30&drawingToolbars=false"
              loading="lazy"
              referrerpolicy="no-referrer"
            ></iframe>
          </div>
          <div class="tiny" style="margin-top:10px">
            Pair: 0xd304…d3b4 (Ethereum)
          </div>
        </div>
      </div>

      <!-- Quick links -->
      <div class="card">
        <div class="hd">
          <h3>Quick Actions</h3>
          <div class="tiny">Official</div>
        </div>
        <div class="bd">
          <div class="row">
            <a class="btn" href="https://gdex-app.com" target="_blank" rel="noopener">Open G-DEX</a>
            <a class="btn secondary" href="https://glipchain.com" target="_blank" rel="noopener">GLIP Website</a>
          </div>
          <div class="sep"></div>
          <div class="tiny">
            If you are preparing for a listing, use the official contact channel shown on the website.
          </div>
        </div>
      </div>
    </div>

  </div><!-- /grid -->
</div><!-- /wrap -->

<!-- Token modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd">
      <b>Select token</b>
      <button class="btn secondary" id="closeModal" style="padding:8px 10px;border-radius:12px">Close</button>
    </div>
    <div class="mbd">
      <input class="search" id="tokSearch" placeholder="Search symbol (e.g., ETH, USDT, GLIP)" />
      <div class="list" id="tokList"></div>
      <div class="tiny" style="margin-top:10px">
        Token list is minimized for stability (recommended).
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <b id="toastTitle">—</b>
  <div class="tiny" id="toastMsg">—</div>
  <div class="tbtns" id="toastBtns"></div>
</div>

<script>
/* =========================================================
   ✅ Minimal Token List (요청: 토큰리스트 최소화)
   - ETH (native) uses pseudo address "ETH"
   - ERC-20 addresses are Ethereum mainnet
   ========================================================= */
const TOKENS = [
  {
    symbol: "ETH",
    name: "Ethereum",
    address: "ETH",
    decimals: 18,
    icon: "https://assets.coingecko.com/coins/images/279/large/ethereum.png"
  },
  {
    symbol: "GLIP",
    name: "GLIP Token",
    address: "0x200074586fa7f2B944Ab7Ce4CC56C30e7616e62C",
    decimals: 18,
    icon: "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x200074586fa7f2B944Ab7Ce4CC56C30e7616e62C/logo.png"
  },
  {
    symbol: "USDT",
    name: "Tether USD",
    address: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
    decimals: 6,
    icon: "https://assets.coingecko.com/coins/images/325/large/Tether.png"
  },
  {
    symbol: "USDC",
    name: "USD Coin",
    address: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    decimals: 6,
    icon: "https://assets.coingecko.com/coins/images/6319/large/usdc.png"
  },
  {
    symbol: "DAI",
    name: "Dai Stablecoin",
    address: "0x6B175474E89094C44Da98b954EedeAC495271d0F",
    decimals: 18,
    icon: "https://assets.coingecko.com/coins/images/9956/large/Badge_Dai.png"
  }
];

// SushiSwap swap base
const SUSHI_SWAP_BASE = "https://www.sushi.com/ethereum/swap";
const SUSHI_POOLS_URL  = "https://www.sushi.com/ethereum/explore/pools";

let provider, signer, userAddr = null;
let pickSide = "in";
let tokenIn = TOKENS[1];  // default GLIP
let tokenOut = TOKENS[0]; // default ETH

// UI refs
const $ = (id)=>document.getElementById(id);
const btnConnect = $("btnConnect");
const addrLine = $("addrLine");
const netLine = $("netLine");

const amtIn = $("amtIn");
const amtOut = $("amtOut");
const balIn = $("balIn");
const balOut = $("balOut");

const inIcon = $("inIcon");
const outIcon = $("outIcon");
const inSym = $("inSym");
const outSym = $("outSym");

const pickIn = $("pickIn");
const pickOut = $("pickOut");
const btnFlip = $("btnFlip");
const btnSwap = $("btnSwap");
const btnPool = $("btnPool");
const pxLine  = $("pxLine");

// Modal
const modalBack = $("modalBack");
const tokList = $("tokList");
const tokSearch = $("tokSearch");

// Pools ticker
const poolsTickerPair = $("poolsTickerPair");
const poolsTickerMeta = $("poolsTickerMeta");
const poolsTickerLink = $("poolsTickerLink");
const poolsUpdated    = $("poolsUpdated");
const poolsStatus     = $("poolsStatus");

// Major prices
const majorList    = $("majorList");
const majorUpdated = $("majorUpdated");
const majorStatus  = $("majorStatus");

// Toast
const toast = $("toast");
const toastTitle = $("toastTitle");
const toastMsg = $("toastMsg");
const toastBtns = $("toastBtns");

function showToast(title, msg, buttons = []){
  toastTitle.textContent = title;
  toastMsg.textContent = msg;
  toastBtns.innerHTML = "";
  buttons.forEach(b=>{
    const el = document.createElement("button");
    el.className = "tbtn";
    el.textContent = b.label;
    el.onclick = ()=>{ try{b.onClick && b.onClick();}catch(e){} hideToast(); };
    toastBtns.appendChild(el);
  });
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(hideToast, 5500);
}
function hideToast(){ toast.style.display = "none"; }

function shortAddr(a){
  if(!a) return "—";
  return a.slice(0,6) + "…" + a.slice(-4);
}

function setTokenUI(){
  inIcon.src = tokenIn.icon || "G_DEX_icon.png";
  outIcon.src = tokenOut.icon || "G_DEX_icon.png";
  inSym.textContent = tokenIn.symbol;
  outSym.textContent = tokenOut.symbol;

  // pool link default (best-effort)
  btnPool.href = SUSHI_POOLS_URL;

  updateQuote();
  refreshBalances();
}

function openModal(side){
  pickSide = side;
  modalBack.style.display = "flex";
  tokSearch.value = "";
  renderTokenList("");
  tokSearch.focus();
}
function closeModal(){
  modalBack.style.display = "none";
}

function renderTokenList(q){
  const query = (q||"").trim().toLowerCase();
  tokList.innerHTML = "";
  TOKENS
    .filter(t => !query || t.symbol.toLowerCase().includes(query) || (t.name||"").toLowerCase().includes(query))
    .forEach(t=>{
      const row = document.createElement("div");
      row.className = "tokRow";
      row.innerHTML = `
        <img src="${t.icon || "G_DEX_icon.png"}" alt="">
        <div class="meta">
          <div class="sym">${t.symbol} <span class="tiny" style="font-weight:800">— ${t.name || ""}</span></div>
          <div class="addr">${t.address === "ETH" ? "Native" : shortAddr(t.address)}</div>
        </div>
      `;
      row.onclick = ()=>{
        if(pickSide === "in"){
          tokenIn = t;
          if(tokenOut.address === tokenIn.address){ tokenOut = (t.symbol==="ETH") ? TOKENS[1] : TOKENS[0]; }
        }else{
          tokenOut = t;
          if(tokenOut.address === tokenIn.address){ tokenIn = (t.symbol==="ETH") ? TOKENS[1] : TOKENS[0]; }
        }
        closeModal();
        setTokenUI();
      };
      tokList.appendChild(row);
    });
}

/* =========================================================
   Wallet connect (Mainnet recommended)
   ========================================================= */
async function connect(){
  if(!window.ethereum){
    showToast("Wallet not found", "Please install MetaMask or a compatible wallet.");
    return;
  }
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddr = await signer.getAddress();

  addrLine.textContent = shortAddr(userAddr);
  btnConnect.textContent = "Connected";
  btnConnect.classList.add("secondary");

  const net = await provider.getNetwork();
  netLine.textContent = `Network: ${net.name} (chainId ${net.chainId})`;

  if(net.chainId !== 1){
    showToast(
      "Wrong network",
      "Switch to Ethereum Mainnet and refresh for best results.",
      [{label:"OK"}]
    );
  }
  refreshBalances();

  window.ethereum.on?.("chainChanged", ()=>location.reload());
  window.ethereum.on?.("accountsChanged", ()=>location.reload());
}

async function getERC20Balance(token){
  if(!provider || !userAddr) return null;
  if(token.address === "ETH"){
    const b = await provider.getBalance(userAddr);
    return {raw:b, fmt: ethers.utils.formatEther(b)};
  }
  const abi = ["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"];
  const c = new ethers.Contract(token.address, abi, provider);
  const b = await c.balanceOf(userAddr);
  const fmt = ethers.utils.formatUnits(b, token.decimals);
  return {raw:b, fmt};
}

async function refreshBalances(){
  try{
    if(!provider || !userAddr){
      balIn.textContent = "Balance: —";
      balOut.textContent = "Balance: —";
      return;
    }
    const [b1,b2] = await Promise.allSettled([getERC20Balance(tokenIn), getERC20Balance(tokenOut)]);
    balIn.textContent  = "Balance: " + (b1.status==="fulfilled" && b1.value ? Number(b1.value.fmt).toLocaleString(undefined,{maximumFractionDigits:6}) : "—");
    balOut.textContent = "Balance: " + (b2.status==="fulfilled" && b2.value ? Number(b2.value.fmt).toLocaleString(undefined,{maximumFractionDigits:6}) : "—");
  }catch(e){
    balIn.textContent = "Balance: —";
    balOut.textContent = "Balance: —";
  }
}

/* =========================================================
   Quote (best-effort): use CoinGecko simple price
   - This is just a preview, actual execution happens on Sushi
   ========================================================= */
const CG_SIMPLE = "https://api.coingecko.com/api/v3/simple/price";

function coingeckoIdBySymbol(sym){
  // minimal mapping for preview
  const m = { ETH:"ethereum", USDT:"tether", USDC:"usd-coin", DAI:"dai" };
  return m[sym] || null;
}

async function updateQuote(){
  const v = (amtIn.value || "").trim();
  if(!v || isNaN(Number(v)) || Number(v) <= 0){
    amtOut.value = "";
    pxLine.textContent = "Quote: —";
    return;
  }
  // If tokenIn or tokenOut is GLIP (unknown on CG), skip numeric quote
  if(tokenIn.symbol==="GLIP" || tokenOut.symbol==="GLIP"){
    amtOut.value = "";
    pxLine.textContent = "Quote: — (GLIP preview unavailable)";
    return;
  }
  const idIn = coingeckoIdBySymbol(tokenIn.symbol);
  const idOut = coingeckoIdBySymbol(tokenOut.symbol);
  if(!idIn || !idOut){
    amtOut.value = "";
    pxLine.textContent = "Quote: —";
    return;
  }
  try{
    const url = `${CG_SIMPLE}?ids=${encodeURIComponent(idIn)},${encodeURIComponent(idOut)}&vs_currencies=usd`;
    const r = await fetch(url, {cache:"no-store"});
    const j = await r.json();
    const pIn = j?.[idIn]?.usd;
    const pOut = j?.[idOut]?.usd;
    if(!pIn || !pOut) throw new Error("No price");
    const out = (Number(v) * (pIn / pOut));
    amtOut.value = out.toLocaleString(undefined,{maximumFractionDigits:6});
    pxLine.textContent = `Quote: ~${out.toLocaleString(undefined,{maximumFractionDigits:6})} ${tokenOut.symbol}`;
  }catch(e){
    amtOut.value = "";
    pxLine.textContent = "Quote: —";
  }
}

/* =========================================================
   Open SushiSwap with selected tokens
   ========================================================= */
function buildSushiSwapURL(){
  const from = tokenIn.address === "ETH" ? "NATIVE" : tokenIn.address;
  const to   = tokenOut.address === "ETH" ? "NATIVE" : tokenOut.address;

  // Sushi supports query params; if it changes, this still opens swap page safely.
  const u = new URL(SUSHI_SWAP_BASE);
  u.searchParams.set("token0", from);
  u.searchParams.set("token1", to);
  const v = (amtIn.value || "").trim();
  if(v && !isNaN(Number(v)) && Number(v) > 0) u.searchParams.set("amount", v);
  return u.toString();
}

function openSwap(){
  const u = buildSushiSwapURL();
  window.open(u, "_blank", "noopener");
  showToast("Opening swap", "Swap will open on SushiSwap in a new tab.");
}

/* =========================================================
   Recently Created Pools (best-effort)
   - No official public “latest pools” endpoint guaranteed,
     so we simulate a high-quality ticker:
     1) Use Sushi pools explore page as CTA (always valid)
     2) Provide a rotating “watchlist” pool signals
   ========================================================= */
const POOL_SIGNALS = [
  {pair:"WETH / USDT", meta:"High liquidity (watch)", url:SUSHI_POOLS_URL},
  {pair:"WETH / USDC", meta:"High liquidity (watch)", url:SUSHI_POOLS_URL},
  {pair:"WETH / DAI",  meta:"Stable routing (watch)", url:SUSHI_POOLS_URL},
  {pair:"GLIP / WETH", meta:"Project pair (check)", url:SUSHI_POOLS_URL},
];

let poolIdx = 0;
function rotatePools(){
  const x = POOL_SIGNALS[poolIdx % POOL_SIGNALS.length];
  poolsTickerPair.textContent = x.pair;
  poolsTickerMeta.textContent = x.meta;
  poolsTickerLink.href = x.url;
  poolIdx++;
  poolsUpdated.textContent = "Updated: " + new Date().toLocaleTimeString();
}
setInterval(rotatePools, 4200);

/* =========================================================
   Major coin prices (CoinGecko markets)
   ========================================================= */
async function loadMajor(){
  const coins = [
    {id:"bitcoin",  sym:"BTC", name:"Bitcoin", icon:"https://assets.coingecko.com/coins/images/1/large/bitcoin.png"},
    {id:"ethereum", sym:"ETH", name:"Ethereum", icon:"https://assets.coingecko.com/coins/images/279/large/ethereum.png"},
    {id:"tether",   sym:"USDT",name:"Tether", icon:"https://assets.coingecko.com/coins/images/325/large/Tether.png"},
    {id:"usd-coin", sym:"USDC",name:"USD Coin", icon:"https://assets.coingecko.com/coins/images/6319/large/usdc.png"},
  ];
  try{
    const url = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=" + coins.map(c=>c.id).join(",") + "&price_change_percentage=24h";
    const r = await fetch(url, {cache:"no-store"});
    const j = await r.json();
    const map = {};
    (j||[]).forEach(x=>map[x.id]=x);

    majorList.innerHTML = "";
    coins.forEach(c=>{
      const d = map[c.id];
      const price = d?.current_price;
      const chg = d?.price_change_percentage_24h;
      const up = (typeof chg==="number" && chg >= 0);
      const row = document.createElement("div");
      row.className = "pRow";
      row.innerHTML = `
        <div class="pLeft">
          <img src="${c.icon}" alt="">
          <div>
            <div class="pName">${c.sym} <span class="tiny" style="font-weight:800">— ${c.name}</span></div>
          </div>
        </div>
        <div class="pRight">
          <div style="font-weight:900">${typeof price==="number" ? "$" + price.toLocaleString(undefined,{maximumFractionDigits: (price>=100?2:6)}) : "—"}</div>
          <div class="chg ${up ? "up":"dn"}">${typeof chg==="number" ? (up?"+":"") + chg.toFixed(2) + "% (24h)" : "—"}</div>
        </div>
      `;
      majorList.appendChild(row);
    });

    majorUpdated.textContent = "Updated: " + new Date().toLocaleTimeString();
    majorStatus.textContent = "Auto refresh";
  }catch(e){
    majorUpdated.textContent = "Updated: —";
    majorStatus.textContent = "API unavailable";
  }
}

/* =========================================================
   Bindings
   ========================================================= */
btnConnect.addEventListener("click", connect);
pickIn.addEventListener("click", ()=>openModal("in"));
pickOut.addEventListener("click", ()=>openModal("out"));
$("closeModal").addEventListener("click", closeModal);
modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });
tokSearch.addEventListener("input", (e)=>renderTokenList(e.target.value));

btnFlip.addEventListener("click", ()=>{
  const t = tokenIn; tokenIn = tokenOut; tokenOut = t;
  setTokenUI();
});
btnSwap.addEventListener("click", openSwap);
amtIn.addEventListener("input", ()=>{ updateQuote(); });

/* =========================================================
   Init
   ========================================================= */
(function init(){
  setTokenUI();
  renderTokenList("");
  rotatePools();
  loadMajor();
  setInterval(loadMajor, 25000);
  poolsStatus.textContent = "Live sync";
})();
</script>
</body>
</html>
