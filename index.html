<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>G-DEX — GLIP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020c0a;
      --panel:#071b16;
      --panel-soft:#0b2520;
      --accent:#19e59c;
      --accent-soft:rgba(25,229,156,0.16);
      --text:#f4fff9;
      --muted:#a6c5b6;
      --danger:#ff5c7a;
      --radius-lg:24px;
      --radius-md:14px;
      --shadow-soft:0 18px 40px rgba(0,0,0,0.55);
      --input-bg:#051612;
      --border:#1a3f35;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;padding:0;
      font-family:"Plus Jakarta Sans",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at -20% -20%,#21ffb699 0,transparent 50%),
                 radial-gradient(circle at 120% 130%,#15b89c80 0,transparent 55%),
                 #020c0a;
      color:var(--text);
      min-height:100vh;
    }
    body{
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:32px 16px 48px;
    }
    .shell{
      width:min(1040px,100%);
      max-width:1040px;
    }
    /* top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:24px;
    }
    .logo-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-circle{
      width:34px;height:34px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%,#64ffd0 0,#00b894 40%,#00453b 80%);
      box-shadow:0 0 16px rgba(0,255,200,0.5);
      display:flex;align-items:center;justify-content:center;
      font-family:"Sora",system-ui;
      font-weight:800;
      font-size:17px;
      letter-spacing:0.02em;
    }
    .logo-text-main{
      font-family:"Sora",system-ui;
      font-weight:700;
      font-size:20px;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .logo-text-sub{
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.14em;
      text-transform:uppercase;
      margin-top:2px;
    }
    .wallet-pill{
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(4,16,13,0.9);
      border-radius:999px;
      border:1px solid rgba(109,198,166,0.3);
      padding:6px 10px 6px 6px;
      box-shadow:0 8px 28px rgba(0,0,0,0.6);
    }
    .wallet-dot{
      width:10px;height:10px;border-radius:999px;
      background:#ffba24;
      box-shadow:0 0 12px rgba(255,186,36,0.8);
    }
    .wallet-addr{
      font-size:12px;
      color:var(--muted);
      max-width:132px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .btn-connect{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
      background:linear-gradient(135deg,#35ffb4,#0fd58e);
      color:#02100b;
      cursor:pointer;
    }
    .btn-connect:disabled{
      opacity:.7;cursor:default;
    }

    /* main layout */
    .grid{
      display:grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
      gap:20px;
    }
    @media(max-width:840px){
      body{padding-top:20px;}
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:linear-gradient(145deg,rgba(5,28,22,0.96),rgba(7,35,29,0.96));
      border-radius:var(--radius-lg);
      border:1px solid rgba(72,132,110,0.7);
      box-shadow:var(--shadow-soft);
      padding:18px 18px 20px;
    }

    .card h2, .card h3{
      margin:0 0 12px;
      font-family:"Sora",system-ui;
      letter-spacing:0.04em;
      text-transform:uppercase;
      font-size:17px;
    }

    .swap-card{
      position:relative;
      overflow:hidden;
    }
    .swap-card::before{
      content:"";
      position:absolute;
      inset:-50%;
      background:
        radial-gradient(circle at 0 0,#27ffb411 0,transparent 55%),
        radial-gradient(circle at 120% 100%,#00ffc81a 0,transparent 55%);
      opacity:0.85;
      pointer-events:none;
    }
    .swap-inner{
      position:relative;
    }

    .row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .field{
      flex:1;
      background:var(--input-bg);
      border-radius:var(--radius-md);
      padding:8px 11px;
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .field-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .field-label{
      font-size:11px;
      color:var(--muted);
    }
    .field-input{
      border:none;
      background:transparent;
      outline:none;
      color:var(--text);
      font-size:17px;
      font-weight:600;
      width:100%;
    }
    .token-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#061a15;
      border:1px solid rgba(102,190,156,0.5);
      cursor:pointer;
      font-size:13px;
    }
    .token-icon{
      width:16px;height:16px;border-radius:999px;
      background:radial-gradient(circle at 30% 0,#ffffff,#8ee7ff);
      overflow:hidden;
    }
    .token-icon img{width:100%;height:100%;object-fit:cover;}

    .swap-arrow-wrap{
      display:flex;
      justify-content:center;
      margin:10px 0 14px;
    }
    .swap-arrow-btn{
      width:34px;height:34px;border-radius:999px;
      border:1px solid rgba(121,205,170,0.7);
      background:radial-gradient(circle at 30% 0,#1dffb9,#058e69);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(0,0,0,0.8);
    }

    .slip-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0 16px;
      font-size:12px;
      color:var(--muted);
    }
    .slip-input-wrap{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#061713;
      border-radius:999px;
      padding:5px 9px 5px 9px;
      border:1px solid rgba(96,173,142,0.7);
    }
    .slip-input-wrap input{
      width:48px;
      border:none;
      background:transparent;
      color:var(--text);
      font-size:12px;
      text-align:right;
      outline:none;
    }

    .btn-main{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px;
      margin-top:4px;
      font-size:15px;
      font-weight:700;
      letter-spacing:0.1em;
      text-transform:uppercase;
      background:linear-gradient(135deg,#3effc2,#10c98a);
      color:#03110a;
      cursor:pointer;
      box-shadow:0 18px 40px rgba(0,0,0,0.95);
    }
    .btn-main:disabled{
      opacity:.6;cursor:default;
    }

    .hint{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
    }

    /* right panel */
    .metrics{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:4px;
      margin-bottom:14px;
    }
    .metric-card{
      background:#071b16;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      padding:10px 12px;
    }
    .metric-card h4{
      margin:0 0 4px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.12em;
      text-transform:uppercase;
    }
    .metric-val{
      font-size:16px;
      font-weight:600;
    }
    .badge-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(15,181,118,0.12);
      border:1px solid rgba(50,202,140,0.7);
      font-size:11px;
      color:var(--muted);
    }
    .badge-dot{
      width:8px;height:8px;border-radius:999px;background:#1fffaa;
      box-shadow:0 0 10px rgba(31,255,170,0.9);
    }

    /* modal */
    .popup-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.68);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .popup{
      width:min(360px,90%);
      background:#041310;
      border-radius:20px;
      border:1px solid rgba(129,210,181,0.75);
      box-shadow:0 22px 60px rgba(0,0,0,0.9);
      padding:18px 18px 16px;
    }
    .popup-title{
      font-size:14px;
      margin-bottom:7px;
      font-weight:600;
    }
    .popup-body{
      font-size:12px;
      color:var(--muted);
      max-height:230px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .popup-footer{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
    }
    .popup-btn{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:12px;
      font-weight:600;
      background:linear-gradient(135deg,#29f3a9,#0dbb7f);
      color:#02110a;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- top bar -->
    <header class="topbar">
      <div>
        <div class="logo-wrap">
          <div class="logo-circle">G</div>
          <div>
            <div class="logo-text-main">G-DEX</div>
            <div class="logo-text-sub">GLIP eco-friendly dex</div>
          </div>
        </div>
      </div>
      <div class="wallet-pill">
        <div class="wallet-dot" id="walletDot"></div>
        <div class="wallet-addr" id="walletAddr">Not connected</div>
        <button class="btn-connect" id="btnConnect">Connect</button>
      </div>
    </header>

    <!-- main grid -->
    <main class="grid">
      <!-- left: swap -->
      <section class="card swap-card">
        <div class="swap-inner">
          <h2>Swap</h2>

          <!-- sell -->
          <div class="row">
            <div class="field">
              <div class="field-main">
                <div class="field-label">You pay</div>
                <input id="sell" class="field-input" inputmode="decimal" autocomplete="off" />
              </div>
              <button class="token-pill" id="sellTokenBtn">
                <span class="token-icon"><img id="sellIcon" src="" alt=""></span>
                <span id="sellS">ETH</span>
              </button>
            </div>
          </div>

          <!-- arrow -->
          <div class="swap-arrow-wrap">
            <button class="swap-arrow-btn" id="btnFlip" aria-label="Flip tokens">⇅</button>
          </div>

          <!-- buy -->
          <div class="row">
            <div class="field">
              <div class="field-main">
                <div class="field-label">You receive (estimated)</div>
                <input id="buy" class="field-input" readonly />
              </div>
              <button class="token-pill" id="buyTokenBtn">
                <span class="token-icon"><img id="buyIcon" src="" alt=""></span>
                <span id="buyS">USDT</span>
              </button>
            </div>
          </div>

          <!-- slippage -->
          <div class="slip-row">
            <div>Slippage</div>
            <div class="slip-input-wrap">
              <input id="slip" type="number" min="0" step="0.1" value="2" />
              <span>%</span>
            </div>
          </div>

          <button class="btn-main" id="btnSwap">Swap</button>

          <div class="hint">
            • Routes via 0x API across major DEXs (Uniswap, SushiSwap, etc).<br/>
            • This interface does not custody your funds – all swaps happen from your wallet.
          </div>
        </div>
      </section>

      <!-- right panel: status / metrics -->
      <aside class="card">
        <h3>Network & Status</h3>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div class="badge-status">
            <span class="badge-dot"></span>
            <span id="statusText">0x allowance-holder v2</span>
          </div>
          <div style="font-size:11px;color:var(--muted);" id="networkText">Ethereum mainnet</div>
        </div>

        <div class="metrics">
          <div class="metric-card">
            <h4>Sell token</h4>
            <div class="metric-val" id="metricSell">ETH</div>
          </div>
          <div class="metric-card">
            <h4>Buy token</h4>
            <div class="metric-val" id="metricBuy">USDT</div>
          </div>
          <div class="metric-card">
            <h4>Last quote</h4>
            <div class="metric-val" id="metricQuote">—</div>
          </div>
        </div>

        <div style="font-size:11px;color:var(--muted);line-height:1.5;">
          G-DEX uses 0x&apos;s allowance-holder API.  
          When you swap, 0x aggregates liquidity across on-chain pools;  
          you still sign and send the transaction directly from your wallet.
        </div>
      </aside>
    </main>
  </div>

  <!-- popup -->
  <div class="popup-backdrop" id="popupBackdrop">
    <div class="popup">
      <div class="popup-title" id="popupTitle">Message</div>
      <div class="popup-body" id="popupBody"></div>
      <div class="popup-footer">
        <button class="popup-btn" id="popupOk">확인</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------- 설정 -----------------
    const BACKEND_URL = "https://gdex-backend.onrender.com";

    // token list (심볼 / 주소 / decimals / 로고)
    const tokenList = [
      {
        symbol:"ETH",
        name:"Ethereum",
        address:"ETH", // ETH 는 별도 처리
        decimals:18,
        logo:"https://assets.coingecko.com/coins/images/279/standard/ethereum.png"
      },
      {
        symbol:"GLIP",
        name:"GLIP Token",
        address:"0xD0b86b79AE4b8D7bb88b37EBe228ce343D79794e",
        decimals:18,
        logo:"https://cdn.imweb.me/thumbnail/20251023/7c2d51fa8c1bc.png"
      },
      {
        symbol:"USDT",
        name:"Tether USD",
        address:"0xdAC17F958D2ee523a2206206994597C13D831ec7",
        decimals:6,
        logo:"https://assets.coingecko.com/coins/images/325/standard/Tether.png"
      },
      {
        symbol:"USDC",
        name:"USD Coin",
        address:"0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
        decimals:6,
        logo:"https://assets.coingecko.com/coins/images/6319/standard/USD_Coin_icon.png"
      }
    ];

    const ETH_ADDRESS_0X = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";

    let userAddress = null;

    // ----------------- 유틸 -----------------
    function getTokenMeta(symbol){
      return tokenList.find(t => t.symbol === symbol);
    }

    function toBackendTokenAddress(meta){
      if (!meta) return "";
      if (meta.symbol === "ETH" || meta.address === "ETH") return ETH_ADDRESS_0X;
      return meta.address;
    }

    function formatNumber(v, decimals){
      if (!isFinite(v)) return "";
      return Number(v).toLocaleString(undefined,{
        minimumFractionDigits:0,
        maximumFractionDigits:decimals
      });
    }

    function setTokenUI(side, symbol){
      const meta = getTokenMeta(symbol);
      if (!meta) return;
      document.getElementById(side+"S").textContent = meta.symbol;
      const iconEl = document.getElementById(side+"Icon");
      if (iconEl){ iconEl.src = meta.logo; iconEl.alt = meta.symbol; }

      if (side === "sell"){
        document.getElementById("metricSell").textContent = meta.symbol;
      } else {
        document.getElementById("metricBuy").textContent = meta.symbol;
      }
    }

    function showPopup(title, message){
      document.getElementById("popupTitle").textContent = title;
      document.getElementById("popupBody").textContent = message;
      document.getElementById("popupBackdrop").style.display = "flex";
    }
    function hidePopup(){
      document.getElementById("popupBackdrop").style.display = "none";
    }
    document.getElementById("popupOk").addEventListener("click", hidePopup);

    function showErrorPopup(title, msg){
      console.error(title, msg);
      showPopup("gdex-app.com 내용:\n" + title, msg);
    }

    async function postToBackend(path, body){
      try{
        const res = await fetch(BACKEND_URL + path,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(body)
        });
        const text = await res.text();
        let data = {};
        try{ data = text ? JSON.parse(text) : {}; } catch(e){ data = { raw:text }; }
        if(!res.ok){
          const message = (data && data.message) || `Backend error ${res.status}`;
          throw new Error(message);
        }
        return data;
      }catch(err){
        console.error("Backend call error", path, err);
        throw err;
      }
    }

    // ----------------- 가격 미리보기 -----------------
    async function updatePricePreview(){
      const sellInput = document.getElementById("sell");
      const buyInput  = document.getElementById("buy");
      const sellVal   = parseFloat(sellInput.value || "0");

      if (!sellVal || sellVal <= 0){
        buyInput.value = "";
        document.getElementById("metricQuote").textContent = "—";
        return;
      }

      const sellSym = document.getElementById("sellS").textContent;
      const buySym  = document.getElementById("buyS").textContent;

      const sellMeta = getTokenMeta(sellSym);
      const buyMeta  = getTokenMeta(buySym);
      if (!sellMeta || !buyMeta) return;

      // amount → wei 문자열 (단위 변환 1회)
      const sellAmountRaw = BigInt(
        Math.floor(sellVal * 10 ** sellMeta.decimals)
      ).toString();

      const slipInput = document.getElementById("slip");
      const slipPct   = slipInput ? Number(slipInput.value || "0") / 100 : undefined;

      console.log("[quote] sellVal", sellVal, "sellAmountRaw(wei)", sellAmountRaw);

      try{
        const quote = await postToBackend("/quote",{
          sellToken: toBackendTokenAddress(sellMeta),
          buyToken:  toBackendTokenAddress(buyMeta),
          sellAmount: sellAmountRaw,
          slippagePercentage: slipPct
        });

        console.log("[/quote response]", quote);

        if (quote.buyAmount){
          const buyFloat = Number(quote.buyAmount) / 10 ** buyMeta.decimals;
          buyInput.value = formatNumber(buyFloat, 6);
          document.getElementById("metricQuote").textContent =
            `${sellVal} ${sellSym} → ${formatNumber(buyFloat,4)} ${buySym}`;
        }
      }catch(err){
        showErrorPopup("Quote request failed",
          "Network / CORS error when calling backend.\nCheck Render logs & CORS settings.\n" +
          (err.message || "Unknown error"));
      }
    }

    // ----------------- 스왑 실행 -----------------
    async function executeSwap(){
      try{
        if (!userAddress){
          alert("Please connect your wallet first.");
          return;
        }

        const sellVal = parseFloat(document.getElementById("sell").value || "0");
        if (!sellVal || sellVal <= 0){
          alert("Enter an amount to swap.");
          return;
        }

        const sellSym = document.getElementById("sellS").textContent;
        const buySym  = document.getElementById("buyS").textContent;

        const sellMeta = getTokenMeta(sellSym);
        const buyMeta  = getTokenMeta(buySym);
        if (!sellMeta || !buyMeta){
          showErrorPopup("Swap error","Token metadata not found. Please reselect tokens and try again.");
          return;
        }

        // amount → wei 문자열 (단위 변환 1회)
        const sellAmountRaw = BigInt(
          Math.floor(sellVal * 10 ** sellMeta.decimals)
        ).toString();

        const slipInput = document.getElementById("slip");
        const slipPct   = slipInput ? Number(slipInput.value || "0") / 100 : undefined;

        console.log("[swap] sellVal", sellVal, "sellAmountRaw(wei)", sellAmountRaw);

        const swapRes = await postToBackend("/swap",{
          sellToken: toBackendTokenAddress(sellMeta),
          buyToken:  toBackendTokenAddress(buyMeta),
          sellAmount: sellAmountRaw,
          taker: userAddress,
          slippagePercentage: slipPct
        });

        console.log("[/swap raw response]", swapRes);

        const tx = swapRes.tx || swapRes;
        if (!tx || !tx.to || !tx.data){
          showErrorPopup("Swap error","Backend /swap returned malformed tx");
          console.error("Backend /swap returned malformed tx", swapRes);
          return;
        }

        // 백엔드 value(wei, 10진수 문자열) → MetaMask용 hex
        let valueHex = "0x0";
        if (tx.value && tx.value !== "0"){
          try{
            valueHex = "0x" + BigInt(tx.value).toString(16);
          }catch(e){
            console.error("Failed to convert tx.value to hex:", tx.value, e);
            showErrorPopup("Swap error","Failed to build transaction value.");
            return;
          }
        }

        const txParams = {
          from: userAddress,
          to: tx.to,
          data: tx.data,
          value: valueHex
        };

        console.log("[swap-tx] params", txParams);
        console.log("[swap-tx] params going to MetaMask:", txParams);

        const txHash = await window.ethereum.request({
          method:"eth_sendTransaction",
          params:[txParams]
        });

        console.log("Swap sent, txHash:", txHash);
      }catch(err){
        console.error("executeSwap error:", err);
        if (err && err.code === 4001){
          // user rejected
          return;
        }
        showErrorPopup("Swap failed", err.message || "Unknown error");
      }
    }

    // ----------------- 지갑 연결 -----------------
    async function connectWallet(){
      if (!window.ethereum){
        showErrorPopup("Wallet not found","MetaMask or another EVM wallet was not detected.");
        return;
      }
      try{
        const accounts = await window.ethereum.request({
          method:"eth_requestAccounts"
        });
        userAddress = accounts[0];
        document.getElementById("walletAddr").textContent =
          userAddress.slice(0,6) + "…" + userAddress.slice(-4);
        document.getElementById("walletDot").style.background = "#1fffaa";
        document.getElementById("btnConnect").textContent = "Connected";
        document.getElementById("btnConnect").disabled = true;
      }catch(err){
        console.error("Wallet connect error", err);
      }
    }

    // ----------------- 이벤트 바인딩 -----------------
    document.getElementById("btnConnect").addEventListener("click", connectWallet);
    document.getElementById("btnSwap").addEventListener("click", executeSwap);
    document.getElementById("sell").addEventListener("input", updatePricePreview);
    document.getElementById("slip").addEventListener("input", updatePricePreview);

    document.getElementById("btnFlip").addEventListener("click", () => {
      const sellSym = document.getElementById("sellS").textContent;
      const buySym  = document.getElementById("buyS").textContent;
      setTokenUI("sell", buySym);
      setTokenUI("buy", sellSym);
      updatePricePreview();
    });

    // 간단 토큰 선택 (현재는 ETH/USDT/USDC/GLIP 순환)
    function cycleToken(currentSymbol){
      const idx = tokenList.findIndex(t => t.symbol === currentSymbol);
      if (idx === -1) return tokenList[0].symbol;
      return tokenList[(idx + 1) % tokenList.length].symbol;
    }
    document.getElementById("sellTokenBtn").addEventListener("click", () => {
      const cur = document.getElementById("sellS").textContent;
      setTokenUI("sell", cycleToken(cur));
      updatePricePreview();
    });
    document.getElementById("buyTokenBtn").addEventListener("click", () => {
      const cur = document.getElementById("buyS").textContent;
      setTokenUI("buy", cycleToken(cur));
      updatePricePreview();
    });

    // 초기 세팅
    setTokenUI("sell","ETH");
    setTokenUI("buy","USDT");
  </script>
</body>
</html>
