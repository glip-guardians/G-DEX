<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>G-DEX — GLIP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050b0a;
      --panel:#101d1a;
      --panel-soft:#152520;
      --accent:#19e3a3;
      --accent-soft:rgba(25,227,163,0.12);
      --accent-strong:#06c58c;
      --text:#f3faf7;
      --text-soft:#a7c7ba;
      --danger:#ff4d6a;
      --border:#1f3a32;
      --border-strong:#2c5145;
      --shadow:0 18px 45px rgba(0,0,0,.55);
      --radius-xl:22px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Plus Jakarta Sans",-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      background:radial-gradient(1200px 600px at 10% -20%,rgba(60,255,195,0.16),transparent 60%),
                 radial-gradient(1200px 600px at 110% 120%,rgba(11,140,96,0.38),transparent 60%),
                 var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    body{
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:100%;
      max-width:1080px;
      min-height:100%;
      border-radius:28px;
      background:
        linear-gradient(135deg,rgba(255,255,255,.04),transparent 40%),
        linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.5));
      border:1px solid rgba(255,255,255,.04);
      box-shadow:var(--shadow);
      padding:22px 22px 26px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand-badge{
      width:38px;height:38px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#9fffd6,#1ee2a1 40%,#0b7450 75%);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 18px rgba(31,227,163,.7);
      font-weight:800;
      letter-spacing:.02em;
      color:#02110a;
      font-size:18px;
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title h1{
      font-size:20px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .brand-title span{
      font-size:11px;
      color:var(--text-soft);
    }

    .wallet-box{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      background:rgba(7,17,14,.85);
      border-radius:999px;
      border:1px solid var(--border-strong);
    }
    .wallet-status{
      font-size:12px;
      color:var(--text-soft);
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,40,32,.9);
    }
    .btn{
      border:none;
      outline:none;
      cursor:pointer;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
      padding:8px 16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      transition:background .18s ease, transform .08s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#02130d;
      box-shadow:0 0 20px rgba(25,227,163,.55);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 0 26px rgba(25,227,163,.7);}
    .btn-outline{
      background:transparent;
      border:1px solid var(--border-strong);
      color:var(--text);
    }
    .btn-outline:hover{
      border-color:var(--accent);
      background:rgba(9,48,36,.9);
    }

    main{
      display:grid;
      grid-template-columns:minmax(0,2.1fr) minmax(0,1.6fr);
      gap:16px;
    }
    @media (max-width:900px){
      main{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:radial-gradient(circle at 0 -40%,rgba(31,227,163,.16),transparent 55%),
                 radial-gradient(circle at 120% 140%,rgba(9,100,72,.45),transparent 55%),
                 rgba(5,18,14,.96);
      border-radius:var(--radius-xl);
      border:1px solid var(--border);
      box-shadow:0 12px 35px rgba(0,0,0,.65);
      padding:18px 18px 20px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:radial-gradient(circle at 10% -20%,rgba(164,255,214,.12),transparent 55%);
      mix-blend-mode:soft-light;
      opacity:.8;
      pointer-events:none;
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      position:relative;
      z-index:1;
    }
    .card-header h2{
      font-size:16px;
      font-weight:700;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(2,12,10,.95);
      color:var(--text-soft);
    }

    .rows{position:relative;z-index:1;display:flex;flex-direction:column;gap:10px;}

    .row-label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:11px;
      color:var(--text-soft);
      margin-bottom:4px;
    }
    .swap-input{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(9,29,23,.96);
      border-radius:18px;
      border:1px solid var(--border-strong);
      padding:10px 12px;
      gap:10px;
    }
    .swap-input-main{
      flex:1;
    }
    .swap-input-main input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:17px;
      font-weight:600;
    }
    .swap-input-main input::placeholder{
      color:rgba(144,186,170,.6);
    }

    .token-select{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 9px;
      border-radius:999px;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    .token-select span.symbol{
      font-size:13px;
      font-weight:600;
    }
    .token-select select{
      appearance:none;
      background:transparent;
      border:none;
      color:var(--text-soft);
      font-size:11px;
      padding-right:14px;
      outline:none;
    }

    .swap-toggle{
      width:30px;height:30px;
      border-radius:50%;
      background:var(--accent-soft);
      border:1px solid var(--accent);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      margin:2px auto;
    }
    .swap-toggle span{
      display:inline-block;
      transform:rotate(90deg);
      font-size:15px;
    }

    .slippage-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      font-size:11px;
      color:var(--text-soft);
    }
    .slippage-row input{
      width:60px;
      background:rgba(4,19,14,1);
      border-radius:999px;
      border:1px solid var(--border-strong);
      padding:4px 6px;
      color:var(--text);
      font-size:11px;
      text-align:right;
      outline:none;
    }

    .btn-swap{
      width:100%;
      margin-top:13px;
      padding:11px 16px;
      font-size:15px;
      border-radius:16px;
    }

    .notes{
      margin-top:2px;
      font-size:11px;
      color:var(--text-soft);
      line-height:1.5;
    }
    .notes li{margin-bottom:2px;}

    .metrics{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-bottom:12px;
    }
    .metric{
      background:rgba(4,17,13,.95);
      border-radius:16px;
      padding:10px 12px;
      border:1px solid var(--border-strong);
    }
    .metric h4{
      font-size:11px;
      color:var(--text-soft);
      margin-bottom:6px;
    }
    .metric .v{
      font-size:15px;
      font-weight:600;
    }

    .recent{
      margin-top:6px;
      background:rgba(4,17,13,.95);
      border-radius:16px;
      border:1px dashed var(--border-strong);
      padding:9px 11px;
      font-size:11px;
      color:var(--text-soft);
    }

    .error-popup-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .error-popup{
      width:min(440px,90vw);
      background:#080f0d;
      border-radius:20px;
      padding:18px 18px 16px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 18px 45px rgba(0,0,0,.8);
    }
    .error-popup h3{
      font-size:14px;
      font-weight:700;
      margin-bottom:10px;
    }
    .error-popup pre{
      max-height:260px;
      overflow:auto;
      background:rgba(0,0,0,.75);
      border-radius:12px;
      padding:10px 12px;
      font-size:11px;
      color:#e3f4eb;
    }
    .error-popup-footer{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
    }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <div class="brand-badge">G</div>
      <div class="brand-title">
        <h1>G-DEX</h1>
        <span>GLIP eco-friendly DEX · 0x Router</span>
      </div>
    </div>
    <div class="wallet-box">
      <div class="wallet-status" id="walletStatus">Not connected</div>
      <button class="btn btn-primary" id="btnConnect">Connect Wallet</button>
    </div>
  </header>

  <main>
    <!-- Left: metrics & notes -->
    <section class="card">
      <div class="card-header">
        <h2>Overview</h2>
        <span class="pill">Ethereum Mainnet · 0x Aggregator</span>
      </div>
      <div class="rows">
        <div class="metrics">
          <div class="metric">
            <h4>Total Value Locked</h4>
            <div class="v">—</div>
          </div>
          <div class="metric">
            <h4>24h Volume</h4>
            <div class="v">—</div>
          </div>
          <div class="metric">
            <h4>GLIP Price (indicative)</h4>
            <div class="v">—</div>
          </div>
        </div>

        <div class="recent">
          <strong>Recent Transactions</strong><br>
          No recent swaps.<br>
          Only locally stored history.
        </div>

        <ul class="notes">
          <li>GLIP contract: <code>0xD0b86b79AE4b8D7bb88b37EBe228ce343D79794e</code></li>
          <li>Router: 0x API Exchange Proxy (routes via SushiSwap, Uniswap, etc.)</li>
          <li>ERC-20 approvals are handled through your wallet when needed.</li>
        </ul>
      </div>
    </section>

    <!-- Right: Swap -->
    <section class="card">
      <div class="card-header">
        <h2>Swap</h2>
        <span class="pill" id="routerLabel">Router: 0x allowance-holder v2</span>
      </div>

      <div class="rows">

        <!-- From -->
        <div>
          <div class="row-label">
            <span>From</span>
            <span id="fromBalanceLabel">Balance: —</span>
          </div>
          <div class="swap-input">
            <div class="swap-input-main">
              <input id="inputFromAmount" type="number" min="0" step="any" placeholder="0.0" />
            </div>
            <div class="token-select">
              <span class="symbol" id="fromSymbol">ETH</span>
              <select id="fromTokenSelect"></select>
            </div>
          </div>
        </div>

        <!-- Toggle -->
        <button class="swap-toggle" id="btnFlip"><span>⇅</span></button>

        <!-- To -->
        <div>
          <div class="row-label">
            <span>To (estimated)</span>
            <span id="toBalanceLabel"></span>
          </div>
          <div class="swap-input">
            <div class="swap-input-main">
              <input id="inputToAmount" type="text" placeholder="0.0" readonly />
            </div>
            <div class="token-select">
              <span class="symbol" id="toSymbol">GLIP</span>
              <select id="toTokenSelect"></select>
            </div>
          </div>
        </div>

        <!-- Slippage -->
        <div class="slippage-row">
          <span>Slippage tolerance</span>
          <span>
            <input id="inputSlippage" type="number" min="0" step="0.1" value="2" /> %
          </span>
        </div>

        <button class="btn btn-primary btn-swap" id="btnSwap">Swap</button>
      </div>
    </section>
  </main>
</div>

<!-- Error popup container -->
<div id="errorPopupRoot" style="display:none;"></div>

<!-- Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<script>
  /* ===== utils ===== */
  const $ = s => document.querySelector(s);
  const short = a => a ? a.slice(0,6) + "…" + a.slice(-4) : "–";

  // DApp host / backend
  const DAPP_HOST = "gdex-app.com";
  const BACKEND_URL = "https://gdex-backend.onrender.com";

  // 0x ETH sentinel (used by backend; not a direct on-chain address)
  const ETH_ADDRESS_0X = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";

  // ===== 전역 provider / signer / address =====
  let provider = null;
  let signer = null;
  let userAddress = null;

  // ===== 공통 에러 팝업 =====
  function showErrorPopup(title, payload) {
    let msg = "";
    if (payload instanceof Error) {
      msg = payload.message || String(payload);
    } else if (typeof payload === "string") {
      msg = payload;
    } else {
      try {
        msg = JSON.stringify(payload, null, 2);
      } catch (e) {
        msg = String(payload);
      }
    }

    const root = $("#errorPopupRoot");
    root.innerHTML = `
      <div class="error-popup-backdrop">
        <div class="error-popup">
          <h3>${title}</h3>
          <pre>${msg}</pre>
          <div class="error-popup-footer">
            <button class="btn btn-primary" id="btnErrorOk">OK</button>
          </div>
        </div>
      </div>`;
    root.style.display = "block";
    $("#btnErrorOk").onclick = () => {
      root.style.display = "none";
      root.innerHTML = "";
    };
  }

  // ===== 토큰 리스트 =====
  const TOKENS = [
    {
      symbol:"ETH",
      name:"Ether",
      address:ETH_ADDRESS_0X,
      decimals:18
    },
    {
      symbol:"GLIP",
      name:"GLIP Token",
      address:"0xD0b86b79AE4b8D7bb88b37EBe228ce343D79794e",
      decimals:18
    },
    {
      symbol:"USDT",
      name:"Tether USD",
      address:"0xdAC17F958D2ee523a2206206994597C13D831ec7",
      decimals:6
    },
    {
      symbol:"USDC",
      name:"USD Coin",
      address:"0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
      decimals:6
    }
  ];

  function findToken(symbol) {
    return TOKENS.find(t => t.symbol === symbol);
  }

  // ===== 백엔드 호출 =====
  async function postToBackend(path, body) {
    const url = BACKEND_URL + path;
    console.log("[backend] req", path, body);
    const res = await fetch(url, {
      method:"POST",
      headers:{
        "Content-Type":"application/json"
      },
      body:JSON.stringify(body || {})
    });
    const data = await res.json().catch(()=> ({}));
    console.log("[backend res]", path, res.status, data);
    if (!res.ok) {
      const err = new Error(data.message || ("Backend " + path + " returned HTTP " + res.status));
      err.status = res.status;
      err.payload = data;
      throw err;
    }
    return data;
  }

  // ===== 지갑 연결 =====
  async function connectWallet() {
    try {
      if (!window.ethereum) {
        showErrorPopup("Wallet not found", "MetaMask or compatible wallet is required.");
        return;
      }

      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();

      $("#walletStatus").textContent = short(userAddress);
      $("#btnConnect").textContent = "Connected";

      // 나중에 필요하면 잔고 조회 로직 추가 가능
    } catch (err) {
      console.error(err);
      showErrorPopup("Wallet connection failed", err);
    }
  }

  // ===== 슬리피지 가져오기 =====
  function getSlippageDecimal() {
    const v = parseFloat($("#inputSlippage").value || "0");
    if (Number.isNaN(v) || v <= 0) return 0.02;
    return v / 100;
  }

  // ===== From / To 토큰 선택 관련 =====
  function populateTokenSelects() {
    const fromSel = $("#fromTokenSelect");
    const toSel = $("#toTokenSelect");
    fromSel.innerHTML = "";
    toSel.innerHTML = "";

    TOKENS.forEach(t => {
      const opt1 = document.createElement("option");
      opt1.value = t.symbol;
      opt1.textContent = t.symbol + " · " + t.name;
      fromSel.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = t.symbol;
      opt2.textContent = t.symbol + " · " + t.name;
      toSel.appendChild(opt2);
    });

    fromSel.value = "ETH";
    toSel.value = "GLIP";
    $("#fromSymbol").textContent = "ETH";
    $("#toSymbol").textContent = "GLIP";
  }

  function getSelectedTokens() {
    const fromSymbol = $("#fromTokenSelect").value;
    const toSymbol = $("#toTokenSelect").value;
    const fromToken = findToken(fromSymbol);
    const toToken = findToken(toSymbol);
    return {fromToken, toToken};
  }

  // ===== 가격 미리보기 =====
  let quoteTimer = null;

  function scheduleUpdatePricePreview() {
    if (quoteTimer) clearTimeout(quoteTimer);
    quoteTimer = setTimeout(updatePricePreview, 450);
  }

  async function updatePricePreview() {
    const amountStr = $("#inputFromAmount").value.trim();
    if (!amountStr || Number(amountStr) <= 0) {
      $("#inputToAmount").value = "";
      return;
    }

    const {fromToken, toToken} = getSelectedTokens();
    if (!fromToken || !toToken) return;
    if (!BACKEND_URL) return;

    try {
      const sellAmountWei = ethers.utils.parseUnits(amountStr, fromToken.decimals).toString();
      const body = {
        chainId:1,
        sellToken:fromToken.address,
        buyToken:toToken.address,
        sellAmount:sellAmountWei,
        slippagePercentage:getSlippageDecimal()
      };
      if (userAddress) body.taker = userAddress;

      const data = await postToBackend("/quote", body);

      if (data && data.buyAmount && toToken.decimals != null) {
        const buyHuman = ethers.utils.formatUnits(data.buyAmount, toToken.decimals);
        $("#inputToAmount").value = buyHuman;
      } else {
        $("#inputToAmount").value = "";
      }

    } catch (err) {
      console.error(err);
      showErrorPopup("Quote request failed", err.payload || err.message || err);
    }
  }

  // ===== Swap 실행 =====
  async function executeSwap() {
    try {
      if (!provider || !signer || !userAddress) {
        showErrorPopup("Swap failed", "Please connect your wallet first.");
        return;
      }

      const amountStr = $("#inputFromAmount").value.trim();
      if (!amountStr || Number(amountStr) <= 0) {
        showErrorPopup("Swap failed", "Enter an amount to swap.");
        return;
      }

      const {fromToken, toToken} = getSelectedTokens();
      if (!fromToken || !toToken) {
        showErrorPopup("Swap failed", "Token selection invalid.");
        return;
      }

      const sellAmountWei = ethers.utils.parseUnits(amountStr, fromToken.decimals).toString();
      const body = {
        chainId:1,
        sellToken:fromToken.address,
        buyToken:toToken.address,
        sellAmount:sellAmountWei,
        slippagePercentage:getSlippageDecimal(),
        taker:userAddress
      };

      const res = await postToBackend("/swap", body);
      if (!res || !res.tx) {
        showErrorPopup("Swap failed", "Backend /swap did not return valid tx fields");
        return;
      }

      const tx = res.tx;
      if (!tx.to || !tx.data) {
        showErrorPopup("Swap failed", "Backend /swap did not return valid tx fields\n" + JSON.stringify(tx,null,2));
        return;
      }

      const txRequest = {
        to:tx.to,
        data:tx.data
      };
      if (tx.value && tx.value !== "0") {
        txRequest.value = ethers.BigNumber.from(tx.value);
      }

      $("#btnSwap").disabled = true;
      $("#btnSwap").textContent = "Confirm in wallet…";

      const txResponse = await signer.sendTransaction(txRequest);
      console.log("Swap tx sent", txResponse.hash);
      $("#btnSwap").textContent = "Swapping…";

      await txResponse.wait(1);
      $("#btnSwap").textContent = "Swap completed";
      setTimeout(() => {
        $("#btnSwap").textContent = "Swap";
        $("#btnSwap").disabled = false;
      }, 2000);

    } catch (err) {
      console.error(err);
      $("#btnSwap").disabled = false;
      $("#btnSwap").textContent = "Swap";
      showErrorPopup("Swap failed", err.payload || err.message || err);
    }
  }

  // ===== 이벤트 바인딩 =====
  function setupEvents() {
    $("#btnConnect").onclick = connectWallet;
    $("#inputFromAmount").addEventListener("input", scheduleUpdatePricePreview);
    $("#inputSlippage").addEventListener("input", scheduleUpdatePricePreview);

    $("#fromTokenSelect").addEventListener("change", () => {
      $("#fromSymbol").textContent = $("#fromTokenSelect").value;
      scheduleUpdatePricePreview();
    });
    $("#toTokenSelect").addEventListener("change", () => {
      $("#toSymbol").textContent = $("#toTokenSelect").value;
      scheduleUpdatePricePreview();
    });

    $("#btnFlip").onclick = () => {
      const fromSel = $("#fromTokenSelect");
      const toSel = $("#toTokenSelect");
      const tmp = fromSel.value;
      fromSel.value = toSel.value;
      toSel.value = tmp;
      $("#fromSymbol").textContent = fromSel.value;
      $("#toSymbol").textContent = toSel.value;
      scheduleUpdatePricePreview();
    };

    $("#btnSwap").onclick = executeSwap;
  }

  // ===== 초기화 =====
  (function init(){
    populateTokenSelects();
    setupEvents();
  })();
</script>

</body>
</html>
