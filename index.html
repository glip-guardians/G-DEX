<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>G-DEX ‚Äî GLIP</title>

<script>
  const BACKEND_URL = "https://gdex-backend.onrender.com".replace(/\/$/, "");
</script>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="G_DEX_icon.png">
<link rel="apple-touch-icon" href="G_DEX_icon.png">
<meta name="theme-color" content="#050A0C" />

<script>
  const SW_VER = "20260130_darktheme_full_1";
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js?v=' + SW_VER).catch(console.error);
    });
  }
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  /* ===== Dark / Black tone system ===== */
  --bg0:#050A0C;
  --bg1:#071317;
  --bg2:#0A1820;

  --panel:rgba(10,16,22,.68);
  --panel-2:rgba(12,18,26,.76);
  --inner:rgba(14,22,32,.60);

  --text:#EAF7F0;
  --text-2:rgba(234,247,240,.84);
  --muted:rgba(234,247,240,.68);
  --muted2:rgba(234,247,240,.56);

  --accent:#7bb7ff;
  --accent-2:#39d98a;
  --danger:#ff7878;

  --line:rgba(234,247,240,.10);
  --line-2:rgba(234,247,240,.16);

  --shadow:0 18px 44px rgba(0,0,0,.50);
  --shadow-soft:0 12px 30px rgba(0,0,0,.42);

  --r:22px;
}

*{box-sizing:border-box}
html,body{margin:0}
html,body{
  color:var(--text);
  font-family:"Plus Jakarta Sans",Pretendard,system-ui,-apple-system,Roboto,"Segoe UI","Noto Sans KR",sans-serif;
  background:
    radial-gradient(1200px 740px at 18% 0%, rgba(123,183,255,.20), transparent 60%),
    radial-gradient(900px 650px at 82% 10%, rgba(57,217,138,.14), transparent 55%),
    radial-gradient(900px 900px at 50% 110%, rgba(6,12,16,1), rgba(7,19,23,1) 55%, rgba(5,10,12,1) 100%);
}

img{max-width:100%;display:block}
body{position:relative;overflow-x:hidden}

body::before, body::after{
  content:""; pointer-events:none; position:fixed; inset:-60px; z-index:0;
  background-image:
    radial-gradient(circle, rgba(255,255,255,.20) 0, rgba(255,255,255,0) 62%),
    radial-gradient(circle, rgba(255,255,255,.14) 0, rgba(255,255,255,0) 60%),
    radial-gradient(circle, rgba(255,255,255,.16) 0, rgba(255,255,255,0) 62%);
  background-size:360px 360px, 420px 420px, 320px 320px;
  background-position:0 -80px, 120px -140px, -80px 30px;
  animation:snowfall 44s linear infinite;
  opacity:.08; filter:blur(.2px);
}
body::after{animation-duration:64s;background-size:460px 460px, 520px 520px, 420px 420px;opacity:.05;}
@keyframes snowfall{0%{transform:translateY(-40px);}100%{transform:translateY(90px);}}

/* ===== HERO ===== */
.hero{position:relative;height:min(34vh,420px);overflow:hidden;background:linear-gradient(180deg, rgba(123,183,255,.14) 0%, rgba(5,10,12,.78) 55%, rgba(5,10,12,1) 100%);}
.hero::before{ content:none !important; }
.hero::after{
  content:""; position:absolute; inset:0;
  background:
    linear-gradient(180deg, rgba(0,0,0,.35) 0%, rgba(0,0,0,.62) 55%, rgba(0,0,0,.80) 100%),
    url("https://cdn.imweb.me/thumbnail/20251213/39a6c931679b8.png") center center / cover no-repeat;
  filter:saturate(1.05) contrast(1.08) brightness(.86);
  opacity:.96; z-index:0; pointer-events:none;
}
.heroCharacters{display:none !important;}
.heroOverlaySnow{position:absolute; inset:0; pointer-events:none; z-index:2;
  background-image:
    radial-gradient(circle at 18% 18%, rgba(255,255,255,.25) 0, transparent 55%),
    radial-gradient(circle at 78% 22%, rgba(255,255,255,.18) 0, transparent 58%);
  opacity:.10;
}
.heroText{position:absolute; inset:0; display:grid; place-items:center; z-index:3; text-align:center; padding:0 16px;}
.heroText h2{margin:0 0 10px;font:800 clamp(26px,3.6vw,50px)/1.06 "Sora",system-ui;letter-spacing:.12em;text-transform:uppercase;color:#ffffff;
  text-shadow:0 16px 34px rgba(0,0,0,.55), 0 2px 10px rgba(0,0,0,.35); position:relative;}
.heroText h2::after{content:"";display:block;width:168px;height:4px;margin:18px auto 0;border-radius:999px;
  background:linear-gradient(90deg, rgba(255,255,255,.75), rgba(123,183,255,.75), rgba(57,217,138,.65), rgba(255,255,255,.75));
  box-shadow:0 0 18px rgba(123,183,255,.26);}
.heroText p{margin:6px 0 0;color:rgba(255,255,255,.90);font-size:clamp(13px,1.7vw,16px);text-shadow:0 12px 26px rgba(0,0,0,.45);}

/* ===== HERO link bar ===== */
.heroLinks{position:relative;z-index:4;background:rgba(8,14,18,.62);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  border-bottom:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.45);}
.heroLinks-inner{max-width:1280px;margin:0 auto;padding:10px 16px;display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end}
.heroBtn{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;font-size:12px;font-weight:800;text-decoration:none;
  border:1px solid rgba(234,247,240,.12);background:rgba(10,16,22,.68);color:rgba(234,247,240,.92);cursor:pointer;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  box-shadow:0 6px 18px rgba(0,0,0,.42);
  transition:background .18s ease,border-color .18s ease,transform .15s ease,box-shadow .15s ease;}
.heroBtn .icon{font-size:13px;opacity:.88}
.heroBtn:hover{background:rgba(14,22,32,.76);border-color:rgba(123,183,255,.40);transform:translateY(-1px);box-shadow:0 10px 24px rgba(0,0,0,.52);}
@media (max-width:768px){.heroLinks-inner{justify-content:center}}

/* ===== LAYOUT ===== */
.wrapper{width:100%;max-width:1280px;margin:0 auto;padding:0 16px; position:relative; z-index:1;}
.grid{display:grid;gap:24px;grid-template-columns:260px 1fr;align-items:start}

/* LEFT NAV */
.nav{position:relative;background:rgba(10,16,22,.66);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  border-radius:var(--r);padding:16px;border:1px solid var(--line-2);box-shadow:var(--shadow);overflow:hidden;}
.nav::before{content:"";position:absolute;inset:-2px;
  background:radial-gradient(700px 240px at 30% 0%, rgba(123,183,255,.16), transparent 60%),
             radial-gradient(700px 240px at 80% 10%, rgba(57,217,138,.10), transparent 55%);
  opacity:.85;pointer-events:none;}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:12px; position:relative;}
.brand img{width:34px;height:34px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 3px rgba(5,10,12,.95), 0 10px 20px rgba(0,0,0,.55);}
.brand h1{margin:0;font:900 20px/1 "Sora",sans-serif;letter-spacing:.18em;color:rgba(234,247,240,.92);}
.nav a{display:block;padding:12px 14px;border-radius:999px;margin-bottom:10px;text-decoration:none;color:rgba(234,247,240,.92);
  background:rgba(12,18,26,.74);border:1px solid rgba(234,247,240,.12);text-align:center;font-weight:900;
  box-shadow:0 8px 18px rgba(0,0,0,.40);
  transition:transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;position:relative;}
.nav a:is(:hover,:focus){background:rgba(16,24,34,.80);border-color:rgba(123,183,255,.38);transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,.52);}
.nav .note{margin-top:8px;font-size:12px;line-height:1.4;color:var(--muted)}
.install-cta{display:none;min-width:auto;width:100%;margin-top:10px;padding:10px 12px;font-size:13px;justify-content:center}

/* RIGHT CONTENT */
.main{display:grid;gap:24px;
  grid-template-areas:"metrics metrics" "swap recent" "pool pool" "notes notes" "analytics analytics" "stake stake";
  grid-template-columns:1fr 1fr}
.card{position:relative;background:var(--panel-2);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  border-radius:var(--r);padding:16px;border:1px solid var(--line-2);box-shadow:var(--shadow);overflow:hidden;}
.card::before{content:"";position:absolute;inset:-2px;
  background:radial-gradient(700px 240px at 20% 0%, rgba(123,183,255,.12), transparent 60%),
             radial-gradient(700px 240px at 80% 10%, rgba(57,217,138,.08), transparent 55%);
  opacity:.85;pointer-events:none;z-index:0;}
.card > *{position:relative; z-index:1;}
h3{margin:0 0 12px;font:900 20px/1.25 "Sora",sans-serif;color:rgba(234,247,240,.94);letter-spacing:.02em;}
.metrics{grid-area:metrics;display:grid;gap:16px;grid-template-columns:repeat(3,1fr)}
.metric h4{margin:0 0 6px;font-weight:900;color:rgba(234,247,240,.78)}
.metric .v{font-weight:900;font-size:18px;color:rgba(234,247,240,.92);white-space:nowrap}
.pool{grid-area:pool}.swap{grid-area:swap}.recent{grid-area:recent}.notes{grid-area:notes}.analytics{grid-area:analytics}.stake{grid-area:stake}

/* INPUTS & BUTTONS */
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.input{flex:1;display:flex;align-items:flex-end;gap:10px;position:relative;background:rgba(12,18,26,.72);
  border:1px solid rgba(234,247,240,.14);border-radius:18px;padding:22px 12px 10px;margin:10px 0;min-height:66px;
  box-shadow:0 12px 26px rgba(0,0,0,.44);overflow:hidden;}
.balTag{position:absolute;top:8px;left:14px;font-size:12px;font-weight:900;color:rgba(234,247,240,.62);pointer-events:none;white-space:nowrap;
  max-width:calc(100% - 160px);overflow:hidden;text-overflow:ellipsis;}
.input.leftToken .balTag{left:92px;max-width:calc(100% - 240px);}
.input input{flex:1;width:0;min-width:0;background:transparent;border:0;outline:0;color:rgba(234,247,240,.92);
  font-size:clamp(18px, 3.6vw, 22px);font-weight:900;padding:0;z-index:2;}
.input input::placeholder{color:rgba(234,247,240,.40);}
.input input:disabled{opacity:1;color:rgba(234,247,240,.70);}
.maxBtn{flex:0 0 auto;height:40px;padding:0 16px;border:0;border-radius:999px;font-weight:900;font-family:"Sora",sans-serif;
  color:rgba(234,247,240,.92);background:rgba(18,28,40,.80);border:1px solid rgba(234,247,240,.14);
  box-shadow:0 12px 22px rgba(0,0,0,.50);cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;}
.maxBtn:hover{transform:translateY(-1px);border-color:rgba(123,183,255,.38);background:rgba(22,34,48,.82);box-shadow:0 16px 28px rgba(0,0,0,.58);}
.tokenBtn{flex:0 0 auto;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;cursor:pointer;
  background:rgba(18,28,40,.74);border:1px solid rgba(234,247,240,.14);color:rgba(234,247,240,.92);white-space:nowrap;
  box-shadow:0 10px 20px rgba(0,0,0,.44);font-weight:900;
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;max-width:160px;}
.tokenBtn:hover{transform:translateY(-1px);background:rgba(22,34,48,.80);border-color:rgba(123,183,255,.38);box-shadow:0 14px 26px rgba(0,0,0,.54);}
.tokenBtn span{overflow:hidden;text-overflow:ellipsis;max-width:70px;}
.tokenBtn img,#tokList .item img{width:24px;height:24px;border-radius:50%;object-fit:cover;display:block;background:#000;
  box-shadow:0 0 0 2px rgba(5,10,12,.92), 0 8px 16px rgba(0,0,0,.55);flex:0 0 auto;}
.flip{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;border:1px solid rgba(234,247,240,.14);color:rgba(234,247,240,.88);
  cursor:pointer;background:rgba(12,18,26,.74);box-shadow:0 12px 22px rgba(0,0,0,.48);
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;}
.flip:hover{transform:translateY(-1px);border-color:rgba(123,183,255,.38);background:rgba(16,24,34,.78);box-shadow:0 16px 28px rgba(0,0,0,.58);}

.helper{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
.helper input{width:78px;border:1px solid rgba(234,247,240,.16);background:rgba(12,18,26,.72);color:rgba(234,247,240,.92);
  border-radius:10px;padding:7px 8px;outline:0}
.helper input::placeholder{color:rgba(234,247,240,.42);}
.btn{display:inline-block;min-width:140px;text-align:center;padding:14px 18px;border-radius:18px;border:0;cursor:pointer;
  background:linear-gradient(135deg, rgba(123,183,255,.20), rgba(57,217,138,.12));color:rgba(234,247,240,.94);
  font-weight:900;font-family:"Sora",sans-serif;box-shadow:0 16px 30px rgba(0,0,0,.50);border:1px solid rgba(234,247,240,.14);
  transition:transform .15s ease, box-shadow .15s ease, filter .15s ease, border-color .15s ease, background .15s ease;}
.btn:hover{transform:translateY(-1px);filter:brightness(1.03);border-color:rgba(123,183,255,.38);box-shadow:0 20px 36px rgba(0,0,0,.58);}
.btn:disabled{opacity:.65;cursor:not-allowed;transform:none}
.btn.ghost{background:rgba(12,18,26,.60);color:rgba(234,247,240,.90);border:1px solid rgba(234,247,240,.14);box-shadow:0 12px 24px rgba(0,0,0,.44);}
.btn.ghost:hover{background:rgba(16,24,34,.62);}

/* stake: MAX button fixed */
.input--stake{position:relative}
.input--stake input{padding-right:92px}
.input--stake .max{position:absolute;top:50%;right:8px;transform:translateY(-50%);height:40px;padding:0 16px;border:0;border-radius:999px;
  font-weight:900;font-family:"Sora",sans-serif;color:rgba(234,247,240,.92);background:rgba(18,28,40,.80);
  border:1px solid rgba(234,247,240,.14);box-shadow:0 12px 22px rgba(0,0,0,.50);cursor:pointer;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease}
.input--stake .max:hover{transform:translateY(-50%) translateY(-1px);border-color:rgba(123,183,255,.38);background:rgba(22,34,48,.82);box-shadow:0 16px 28px rgba(0,0,0,.58);}

.stake .statGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:10px}
.stake .stat,.stake .amountBox,.kpi,.vizCard{border:1px solid rgba(234,247,240,.14);border-radius:18px;background:rgba(12,18,26,.68);
  box-shadow:0 14px 28px rgba(0,0,0,.46);}
.stake .stat{padding:14px;}
.stake .tabs{display:flex;gap:12px;margin:8px 0 10px}
.stake .amountBox{padding:14px;}
.stake .stake-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.stake .stake-actions .btn{min-width:auto;width:100%}
.stake .claimRow{display:flex;justify-content:flex-end;margin-top:12px}
@media (max-width:560px){.stake .statGrid{grid-template-columns:1fr}.stake .stake-actions{grid-template-columns:1fr}}

/* analytics */
.kpiGrid{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
.kpi{padding:12px;min-height:84px}
.kpi .label{opacity:.90;font-weight:900;margin-bottom:6px;color:rgba(234,247,240,.72)}
.kpi .val{font-weight:900;font-size:22px;color:rgba(234,247,240,.94)}
.kpi .sub{opacity:.72;font-size:12px;margin-top:2px;color:rgba(234,247,240,.58)}
@media (max-width:1000px){.kpiGrid{grid-template-columns:repeat(3,1fr)}}
@media (max-width:700px){.kpiGrid{grid-template-columns:1fr}}
.anaGrid{display:grid;gap:16px;grid-template-columns:2fr 1fr 1fr}
@media (max-width:1000px){.anaGrid{grid-template-columns:1fr}}
.vizCard{padding:14px}
.vizHead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.vizHead .title{font-weight:900;color:rgba(234,247,240,.92)}
.vizHead .hint{opacity:.72;font-size:12px;color:rgba(234,247,240,.60)}
.sparkWrap{height:180px;border-radius:12px;position:relative;overflow:hidden;background:linear-gradient(180deg, rgba(12,18,26,.78), rgba(123,183,255,.10));
  border:1px solid rgba(234,247,240,.10);}
.sparkWrap canvas{width:100%;height:100%}
.donutWrap,.gaugeWrap{height:220px;display:grid;place-items:center;position:relative}
.centerStat{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
.centerStat .big{font:900 26px/1 "Sora",sans-serif;color:rgba(234,247,240,.94)}
.centerStat .cap{opacity:.75;font-size:12px;margin-top:4px;color:rgba(234,247,240,.62)}
.ring{position:relative;width:200px;height:200px}
.ring canvas{width:100%;height:100%}
.gauge{position:relative;width:220px;height:120px}
.gauge canvas{width:100%;height:100%}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.legend .dot{width:10px;height:10px;border-radius:50%}
.legend .item{display:flex;align-items:center;gap:6px;opacity:.90;color:rgba(234,247,240,.78)}
.ribbon{margin-top:12px;border-radius:16px;padding:12px 14px;background:rgba(12,18,26,.66);color:rgba(234,247,240,.84);
  border:1px solid rgba(234,247,240,.12);box-shadow:0 12px 22px rgba(0,0,0,.46);}

/* mobile center fixed */
@media (max-width:768px){
  .wrapper{padding:0}
  .grid{display:flex;flex-direction:column;gap:24px;width:min(92vw,640px);position:relative;left:50%;transform:translateX(-50%)}
  .nav,.main{width:100%;max-width:min(92vw,640px);margin:0 auto}
  .main{display:flex;flex-direction:column;align-items:center;gap:24px}
  .metrics{display:flex;flex-direction:column;gap:16px;width:100%}
  .metrics .card,.main>section,.card{width:100%;margin-left:auto;margin-right:auto}
  .input{min-height:64px; padding:22px 10px 10px; gap:8px}
  .balTag{max-width:calc(100% - 140px)}
  .tokenBtn{max-width:138px;padding:9px 10px}
  .tokenBtn span{max-width:62px}
  .maxBtn{height:38px;padding:0 12px}
  .input.leftToken .balTag{left:86px}
}

/* Notes */
.notes .inner{max-width:100%;overflow:hidden;position:relative;background:rgba(12,18,26,.70) !important;border-radius:18px !important;
  border:1px solid rgba(234,247,240,.12) !important;box-shadow:0 12px 24px rgba(0,0,0,.46);}
.notes .inner::after,.notes .inner::before{display:none !important;}
.notes .inner p{word-break:break-all;overflow-wrap:anywhere;white-space:normal;color:rgba(234,247,240,.86);}

/* Token modal */
#tokModal{border:1px solid rgba(234,247,240,.16);border-radius:20px;background:rgba(10,16,22,.86);backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);color:rgba(234,247,240,.92);max-width:min(560px,92vw);padding:0;box-shadow:0 24px 70px rgba(0,0,0,.72);}
#tokModal::backdrop{background:rgba(0,0,0,.70)}
#tokModal header{padding:14px 16px;border-bottom:1px solid rgba(234,247,240,.10);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:8px;background:rgba(12,18,26,.82);}
#tokSearch{flex:1;background:rgba(12,18,26,.72);border-radius:999px;border:1px solid rgba(234,247,240,.14);color:rgba(234,247,240,.92);padding:7px 12px;font-size:14px;outline:0;}
#tokSearch::placeholder{color:rgba(234,247,240,.45)}
#tokClose{background:transparent;border:0;color:rgba(234,247,240,.86);cursor:pointer;font-size:16px;padding:6px 10px;border-radius:10px}
#tokClose:hover{background:rgba(123,183,255,.12)}
#tokList .item:hover{background:rgba(123,183,255,.08)}
#tokList .item strong{color:rgba(234,247,240,.94)}
#tokList .item span{color:rgba(234,247,240,.78)}

/* TOP button */
#toTop{position:fixed;right:14px;bottom:18px;z-index:9999;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;
  background:rgba(12,18,26,.72);border:1px solid rgba(234,247,240,.14);backdrop-filter:blur(14px);cursor:pointer;opacity:0;pointer-events:none;
  box-shadow:0 18px 30px rgba(0,0,0,.60);transition:opacity .25s ease,transform .25s ease, border-color .25s ease, background .25s ease}
#toTop svg{width:20px;height:20px;fill:rgba(234,247,240,.90)}
#toTop.show{opacity:.92;pointer-events:auto}
#toTop:hover{opacity:1;transform:translateY(-3px); border-color:rgba(123,183,255,.38); background:rgba(16,24,34,.78)}

/* Sushi pools ticker */
.metric .v #poolsTicker,.metric .v .poolsTicker{white-space:normal;}
.poolsTicker{position:relative;overflow:hidden;border-radius:14px;border:1px solid rgba(234,247,240,.12);background:rgba(12,18,26,.62);
  padding:10px 12px;box-shadow:0 12px 24px rgba(0,0,0,.46);min-height:44px;}
.poolsItem{display:flex;align-items:center;justify-content:space-between;gap:12px;text-decoration:none;color:rgba(234,247,240,.92);font-weight:900;}
.poolsItem .pair{flex:1 1 auto;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.poolsItem .meta{flex:0 0 auto;opacity:.78;font-weight:900;font-size:12px;white-space:nowrap;}
.poolsTicker.fadeOut{opacity:0; transform:translateY(4px); transition:opacity .22s ease, transform .22s ease;}
.poolsTicker.fadeIn {opacity:1; transform:translateY(0);  transition:opacity .22s ease, transform .22s ease;}

/* DEXTools embed */
#metricGlipPrice{white-space:normal;}
#metricGlipPrice .chartFrame{border-radius:14px;overflow:hidden;border:1px solid rgba(234,247,240,.12);background:rgba(12,18,26,.62);box-shadow:0 12px 24px rgba(0,0,0,.46);}
#metricGlipPrice iframe{width:100% !important;height:340px;border:0;display:block;}
@media (max-width:768px){ #metricGlipPrice iframe{height:320px;} }
@media (max-width:420px){ #metricGlipPrice iframe{height:300px;} }

/* In-app UI modal */
#uiModal{border:1px solid rgba(234,247,240,.16);border-radius:22px;background:rgba(10,16,22,.90);backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);color:rgba(234,247,240,.92);width:min(680px, 92vw);padding:0;box-shadow:0 26px 84px rgba(0,0,0,.78);}
#uiModal::backdrop{background:rgba(0,0,0,.72)}
#uiModal header{padding:14px 16px;border-bottom:1px solid rgba(234,247,240,.10);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(12,18,26,.86);}
#uiTitle{ font:900 14px/1.1 "Sora",sans-serif; letter-spacing:.02em; color:rgba(234,247,240,.92); }
#uiClose{background:transparent;border:0;color:rgba(234,247,240,.86);cursor:pointer;font-size:16px;padding:6px 10px;border-radius:10px}
#uiClose:hover{background:rgba(123,183,255,.12)}
#uiBody{ padding:14px 16px 4px; }
#uiMessage{margin:0;padding:12px 12px;border-radius:14px;border:1px solid rgba(234,247,240,.12);background:rgba(12,18,26,.72);
  box-shadow:0 14px 26px rgba(0,0,0,.46);max-height:min(52vh, 420px);overflow:auto;white-space:pre-wrap;word-break:break-word;
  font:700 13px/1.45 "Plus Jakarta Sans", system-ui;color:rgba(234,247,240,.90);}
#uiFooter{display:flex;align-items:center;justify-content:flex-end;gap:10px;padding:12px 16px 16px;}
#uiFooter .btn{min-width:auto}
#uiCopy{background:rgba(12,18,26,.60);border:1px solid rgba(234,247,240,.14);}
#uiCopy:hover{border-color:rgba(123,183,255,.38)}
@media (max-width:480px){#uiFooter{flex-wrap:wrap}#uiFooter .btn{width:100%}}

/* swap status line (UPGRADED) */
#swapStatus{
  margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(234,247,240,.12);
  background:rgba(12,18,26,.66);box-shadow:0 12px 22px rgba(0,0,0,.46);
  font-size:12px;line-height:1.45;color:rgba(234,247,240,.76);display:none;
}
#swapStatus[data-kind="success"]{border-color:rgba(57,217,138,.35);background:rgba(57,217,138,.10);color:rgba(234,247,240,.92);}
#swapStatus[data-kind="error"]{border-color:rgba(255,120,120,.35);background:rgba(255,120,120,.10);color:rgba(234,247,240,.92);}
#swapStatus a{color:rgba(234,247,240,.94);font-weight:900;text-decoration:none}
#swapStatus a:hover{text-decoration:underline}
.spin{display:inline-block;animation:spin 1.1s linear infinite;transform-origin:50% 50%}
@keyframes spin{to{transform:rotate(360deg)}}

/* Status Board */
.statusGrid{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr); }
@media (max-width:900px){ .statusGrid{grid-template-columns:1fr;} }
.statusItem{padding:12px; border-radius:18px;border:1px solid rgba(234,247,240,.14);background:rgba(12,18,26,.68);box-shadow:0 14px 28px rgba(0,0,0,.46);}
.statusItem .label{ font-weight:900; color:rgba(234,247,240,.72); font-size:12px; }
.statusItem .val{ margin-top:6px; font-weight:900; color:rgba(234,247,240,.94); word-break:break-word; }
.statusItem .sub{ margin-top:6px; font-size:12px; color:rgba(234,247,240,.60); opacity:.92; }
#txLog{margin-top:12px; padding:12px; border-radius:18px;border:1px solid rgba(234,247,240,.14);background:rgba(12,18,26,.68);
  box-shadow:0 14px 28px rgba(0,0,0,.46);max-height:260px; overflow:auto;font-size:12px; line-height:1.45;color:rgba(234,247,240,.78);}
.txLine{ display:flex; gap:10px; align-items:flex-start; padding:6px 0; border-bottom:1px dashed rgba(234,247,240,.12); }
.txLine:last-child{border-bottom:0}
.txLine .t{opacity:.72; min-width:74px}
.txLine a{color:rgba(234,247,240,.92); font-weight:900; text-decoration:none}
.txLine a:hover{text-decoration:underline}
.smallPill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(234,247,240,.14);
  background:rgba(12,18,26,.62);font-weight:900;font-size:12px;color:rgba(234,247,240,.88);box-shadow:0 12px 22px rgba(0,0,0,.44);}
.smallPill.ok{border-color:rgba(57,217,138,.35)}
.smallPill.bad{border-color:rgba(255,120,120,.35)}

/* Metrics bottom fill */
.metric{display:flex;flex-direction:column}
.metric .v{flex:0 0 auto}
.metricFill{flex:1 1 auto;display:flex;flex-direction:column;justify-content:space-between;gap:12px;margin-top:12px;padding-top:10px;border-top:1px dashed rgba(234,247,240,.14);}
.miniTitleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.miniTitle{font-weight:900;font-size:12px;color:rgba(234,247,240,.78);}
.miniHint{font-size:12px;color:rgba(234,247,240,.58);font-weight:900;white-space:nowrap;opacity:.95;}
.miniList{display:flex;flex-direction:column;gap:8px;}
.miniRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(234,247,240,.12);
  background:rgba(12,18,26,.62);box-shadow:0 12px 22px rgba(0,0,0,.44);text-decoration:none;color:rgba(234,247,240,.92);
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;}
.miniRow:hover{transform:translateY(-1px);background:rgba(16,24,34,.70);border-color:rgba(123,183,255,.32);box-shadow:0 16px 26px rgba(0,0,0,.56);}
.miniRow .l{font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;}
.miniRow .r{font-size:12px;font-weight:900;opacity:.74;white-space:nowrap;}
.miniEmpty{padding:10px 12px;border-radius:14px;border:1px solid rgba(234,247,240,.10);background:rgba(12,18,26,.48);color:rgba(234,247,240,.62);font-size:12px;font-weight:900;}

.priceGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
@media (max-width:520px){ .priceGrid{grid-template-columns:1fr} }
.priceMini{display:block;padding:10px 12px;border-radius:14px;border:1px solid rgba(234,247,240,.12);background:rgba(12,18,26,.62);
  box-shadow:0 12px 22px rgba(0,0,0,.44);text-decoration:none;color:rgba(234,247,240,.92);
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;}
.priceMini:hover{transform:translateY(-1px);background:rgba(16,24,34,.70);border-color:rgba(123,183,255,.32);box-shadow:0 16px 26px rgba(0,0,0,.56);}
.priceMini .sym{font-weight:900; opacity:.92}
.priceMini .price{margin-top:4px; font-weight:900; font-size:13px; opacity:.92}
.priceMini .chg{margin-top:4px;font-size:12px;font-weight:900;opacity:.90;}
.priceMini .chg.up{color:rgba(57,217,138,.92)}
.priceMini .chg.down{color:rgba(255,120,120,.92)}
.miniActions{display:flex;justify-content:space-between;gap:10px;}
.miniBtn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:14px;font-weight:900;font-size:12px;
  border:1px solid rgba(234,247,240,.14);background:rgba(12,18,26,.66);box-shadow:0 12px 22px rgba(0,0,0,.44);color:rgba(234,247,240,.92);
  text-decoration:none;cursor:pointer;min-width:110px;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;}
.miniBtn:hover{transform:translateY(-1px);background:rgba(16,24,34,.72);border-color:rgba(123,183,255,.32);box-shadow:0 16px 26px rgba(0,0,0,.56);}
.miniBtn.ghost{ background:rgba(12,18,26,.52); }
</style>
</head>

<body>
<section class="hero">
  <div class="heroCharacters"><div class="heroSanta">üéÖ</div><div class="heroRudolph">ü¶å</div></div>
  <div class="heroOverlaySnow"></div>
  <div class="heroText"><div><h2>G-DEX </h2><p>Elegant swaps and staking in a frosted, transparent interface.</p></div></div>
</section>

<section class="heroLinks">
  <div class="heroLinks-inner">
    <a class="heroBtn" href="https://t.me/GLIPFoundation" target="_blank" rel="noopener noreferrer"><span class="icon">üí¨</span><span>Telegram</span></a>
    <a class="heroBtn" href="mailto:contact_lounge@glipchain.com"><span class="icon">‚úâÔ∏è</span><span>Email</span></a>
    <a class="heroBtn" href="https://glipchain.com" target="_blank" rel="noopener noreferrer"><span class="icon">üåê</span><span>GLIP Official</span></a>
    <a class="heroBtn" id="btnListing" href="https://glipchain.com/ListingInquiryver01" target="_blank" rel="noopener noreferrer"><span class="icon">üìà</span><span>Listing Inquiry</span></a>
  </div>
</section>

<div class="wrapper" style="padding-top:16px">
  <div class="grid">
    <aside class="nav">
      <div class="brand">
        <img src="https://cdn.imweb.me/thumbnail/20251023/7c2d51fa8c1bc.png" alt="GLIP logo">
        <h1>G-DEX</h1>
      </div>
      <a href="#swap"><span>Swap</span></a>
      <a href="#pool"><span>Pool</span></a>
      <a href="#analytics"><span>Analytics</span></a>
      <a href="#stake"><span>Stake</span></a>
      <div class="note">Direct routing via SushiSwap V2 Router. DYOR ‚Äî not financial advice.</div>
      <button class="btn install-cta" id="installSide" type="button">Install G-DEX App</button>
    </aside>

    <main class="main">
      <section class="metrics">
        <div class="card metric">
          <h4>Recently Created Pools</h4>
          <div class="v" id="metricPoolsText">
            <div class="poolsTicker" id="poolsTicker" aria-label="Sushi pools ticker">
              <a class="poolsItem" id="poolsTickerLink" href="https://www.sushi.com/ethereum/explore/pools" target="_blank" rel="noopener">
                <span class="pair" id="poolsTickerPair">‚Äî</span><span class="meta" id="poolsTickerMeta"></span>
              </a>
            </div>
          </div>
          <div class="metricFill">
            <div class="miniTitleRow"><div class="miniTitle">New pools (preview)</div><div class="miniHint" id="poolsUpdated">Updated ‚Äî</div></div>
            <div class="miniList" id="poolsMiniList" aria-label="Recent pools list"><div class="miniEmpty">Loading‚Ä¶</div></div>
            <div class="miniActions">
              <a class="miniBtn" id="poolsExploreBtn" href="https://www.sushi.com/ethereum/explore/pools" target="_blank" rel="noopener">Explore</a>
              <button class="miniBtn ghost" id="poolsRefreshBtn" type="button">Refresh</button>
            </div>
          </div>
        </div>

        <div class="card metric">
          <h4>Major Coin Prices</h4>
          <div class="v" id="metricPricesText">
            <div class="poolsTicker" id="pricesTicker" aria-label="Major coin prices ticker">
              <a class="poolsItem" id="pricesTickerLink" href="https://www.coingecko.com" target="_blank" rel="noopener">
                <span class="pair" id="pricesTickerPair">‚Äî</span><span class="meta" id="pricesTickerMeta"></span>
              </a>
            </div>
          </div>
          <div class="metricFill">
            <div class="miniTitleRow"><div class="miniTitle">Snapshot</div><div class="miniHint" id="pricesUpdated">Updated ‚Äî</div></div>
            <div class="priceGrid" id="pricesMiniGrid" aria-label="Major coin snapshot grid"><div class="miniEmpty">Loading‚Ä¶</div></div>
            <div class="miniActions">
              <a class="miniBtn" id="pricesOpenBtn" href="https://www.coingecko.com" target="_blank" rel="noopener">Open</a>
              <button class="miniBtn ghost" id="pricesRefreshBtn" type="button">Refresh</button>
            </div>
          </div>
        </div>

        <div class="card metric">
          <h4>GLIP Price</h4>
          <div class="v" id="metricGlipPrice">
            <div class="chartFrame">
              <iframe id="dextools-widget"
        title="DEXTools Trading Chart"
        width="500"
        height="400" src="https://www.dextools.io/widget-chart/en/ether/pe-light/0xd304b9c49f389f27c5e75e1469e903da5320d3b4?theme=dark&chartType=2&chartResolution=30&drawingToolbars=false"></iframe>
            </div>
          </div>
        </div>
      </section>

      <section class="card swap" id="swap">
        <h3>Swap</h3>

        <div class="input" id="swapSellWrap">
          <div class="balTag" id="sellBal">Bal: ‚Äî</div>
          <input id="sell" placeholder="0.0" type="number" min="0" step="any" inputmode="decimal">
          <button class="maxBtn" id="swapMax" type="button">MAX</button>
          <button class="tokenBtn" id="sellBtn" type="button"><img id="sellI" src="" alt=""><span id="sellS" data-address="">ETH</span></button>
        </div>

        <div class="row" style="justify-content:center"><div class="flip" id="flip">‚áÖ</div></div>

        <div class="input" id="swapBuyWrap">
          <div class="balTag" id="buyBal">Bal: ‚Äî</div>
          <input id="buy" placeholder="0.0" type="number" disabled>
          <button class="tokenBtn" id="buyBtn" type="button"><img id="buyI" src="" alt=""><span id="buyS" data-address="">GLIP</span></button>
        </div>

        <div class="helper">
          <div>
            Slippage <input id="slip" type="number" value="2" min="0" max="50" step="0.1"> %
            <span id="slipHint" style="font-size:12px;opacity:.75;margin-left:6px;"></span>
          </div>
          <button class="btn" id="swapConnect" type="button">Connect Wallet</button>
        </div>
        <div style="height:10px"></div>
        <button class="btn" id="swapBtn" type="button" style="width:100%">Swap</button>

        <div id="swapStatus" aria-live="polite"></div>
      </section>

      <section class="card recent" id="status">
        <h3>G-DEX Status Board</h3>
        <div class="statusGrid">
          <div class="statusItem"><div class="label">Boot / UI</div><div class="val" id="stBoot">‚Äî</div><div class="sub" id="stBootSub">‚Äî</div></div>
          <div class="statusItem"><div class="label">Wallet</div><div class="val" id="stWallet">‚Äî</div><div class="sub" id="stWalletSub">‚Äî</div></div>
          <div class="statusItem"><div class="label">Network</div><div class="val" id="stNet">‚Äî</div><div class="sub" id="stNetSub">‚Äî</div></div>
          <div class="statusItem"><div class="label">Routing</div><div class="val" id="stRoute">‚Äî</div><div class="sub" id="stRouteSub">‚Äî</div></div>
          <div class="statusItem"><div class="label">Data Sources</div><div class="val" id="stSources">‚Äî</div><div class="sub" id="stSourcesSub">‚Äî</div></div>
        </div>

        <div class="row" style="justify-content:space-between;margin-top:12px;gap:10px">
          <div class="row" style="gap:8px">
            <span class="smallPill" id="pillWallet">Wallet</span>
            <span class="smallPill" id="pillNet">Mainnet</span>
            <span class="smallPill" id="pillBackend">Backend</span>
            <span class="smallPill" id="pillCG">CoinGecko</span>
          </div>
          <div class="row" style="gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="btnRefreshStatus" type="button" style="min-width:auto;padding:10px 14px">Refresh</button>
            <button class="btn" id="btnCopyDiag" type="button" style="min-width:auto;padding:10px 14px">Copy Diagnostic</button>
          </div>
        </div>

        <div id="txLog" aria-label="Recent TX log"><div style="opacity:.78">No recent transactions yet.</div></div>
      </section>

      <section class="card pool" id="pool">
        <h3>Pool</h3>
        <div style="background:rgba(12,18,26,.66);padding:10px 14px;border-radius:12px;margin-bottom:12px;font-size:13px;line-height:1.5;
          color:rgba(234,247,240,.76);border:1px solid rgba(234,247,240,.12);box-shadow:0 14px 26px rgba(0,0,0,.46);">
          <strong style="font-weight:900;color:rgba(234,247,240,.92);">G-DEX Pool v1 ‚Äî SushiSwap-Based</strong><br>
          Liquidity for GLIP currently operates through the GLIP‚ÄìETH pool on SushiSwap V2.
          The <b>Supply</b> button will redirect you to SushiSwap to add or remove liquidity.
          Pool metrics are manually updated during the early launch phase.
          Regular users typically only need the <b>Swap</b> function.
        </div>

        <div class="row" style="gap:8px;margin-bottom:6px">
          <button class="btn" id="poolAdd" type="button" style="min-width:auto;padding:10px 14px">Add</button>
          <button class="btn ghost" id="poolRemove" type="button" style="min-width:auto;padding:10px 14px">Remove</button>
          <button class="btn ghost" id="poolPositions" type="button" style="min-width:auto;padding:10px 14px">My Positions</button>
        </div>

        <div class="input leftToken" id="pool0Wrap">
          <div class="balTag" id="pBal0">Bal: ‚Äî</div>
          <button class="tokenBtn" id="pT0Btn" type="button"><img id="pT0Img" src="" alt=""><span id="pT0Sym" data-address="">ETH</span></button>
          <input id="pAmt0" placeholder="0.0" type="number" min="0" step="any" inputmode="decimal">
        </div>

        <div class="row" style="justify-content:center"><div class="flip" id="pFlip">‚áÖ</div></div>

        <div class="input leftToken" id="pool1Wrap">
          <div class="balTag" id="pBal1">Bal: ‚Äî</div>
          <button class="tokenBtn" id="pT1Btn" type="button"><img id="pT1Img" src="" alt=""><span id="pT1Sym" data-address="">GLIP</span></button>
          <input id="pAmt1" placeholder="0.0" type="number" min="0" step="any" inputmode="decimal">
        </div>

        <div class="card" style="background:rgba(12,18,26,.66);margin-top:6px;border:1px solid rgba(234,247,240,.12);box-shadow:0 14px 26px rgba(0,0,0,.48)">
          <div class="row" style="justify-content:space-between"><div style="color:rgba(234,247,240,.80);font-weight:900">Price (T1 per T0)</div><div id="pPrice" style="font-weight:900;color:rgba(234,247,240,.92)">1 GLIP ‚âà 0.0000170 ETH</div></div>
          <div class="row" style="justify-content:space-between"><div style="color:rgba(234,247,240,.80);font-weight:900">Share preview</div><div id="pShare" style="color:rgba(234,247,240,.86);font-weight:900">Initial GLIP-ETH pool on SushiSwap V2</div></div>
          <div class="row" style="justify-content:flex-end;margin-top:6px"><div id="pManualNote" style="font-size:12px;opacity:.78;text-align:right;color:rgba(234,247,240,.72)"></div></div>
        </div>

        <div class="helper">
          <div>Slippage <input id="pSlip" type="number" value="2" min="0" max="10" step="0.1"> %</div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn" id="poolConnect" type="button">Connect Wallet</button>
            <button class="btn" id="poolSupply" type="button">Supply</button>
          </div>
        </div>
        <p id="poolFooterNote" style="margin-top:12px;font-size:12px;opacity:.76;color:rgba(234,247,240,.72)"></p>
      </section>

      <section class="card notes">
        <h3>Notes</h3>
        <div class="card inner" style="background:rgba(12,18,26,.70);border:1px solid rgba(234,247,240,.12)">
          <p class="wrap" style="margin:.2rem 0">‚Ä¢ GLIP contract: 0xD0b86b79AE4b8D7bb88b37EBe228ce343D79794e</p>
          <p class="wrap" style="margin:.2rem 0">‚Ä¢ Proxy Router (G-DEX): 0xF89Dc5519C2BfDc3dab5BE2F7803dfb2E16E9E64</p>
          <p class="wrap" style="margin:.2rem 0">‚Ä¢ Underlying Router: SushiSwap V2 ‚Äî 0xd9e1cE17f2641f24aE83637ab66a2cca9C378B9F</p>
          <p class="wrap" style="margin:.2rem 0">‚Ä¢ Fee policy: ETH‚ÜíToken uses % fee; Token swaps may require a flat ETH fee (msg.value).</p>
          <p class="wrap" style="margin:.2rem 0">‚Ä¢ If Proxy Router preflight reverts (e.g., USDT approve edge-case), UI can fall back to Direct Sushi swap.</p>
        </div>
        <button class="btn install-cta" id="installMain" type="button" style="margin-top:12px;">Install G-DEX App</button>
      </section>

      <!-- Analytics / Stake ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú (ÏÉâÏÉÅÎßå Îã§ÌÅ¨ÌÜ§Ïóê ÎßûÏ∂∞ inline Ï°∞Ï†ï) -->
      <section class="card analytics" id="analytics">
        <h3>Analytics ‚Äî ‚ÄúBlockchain that gives back‚Äù</h3>
        <div style="margin-top:6px;margin-bottom:12px;padding:10px 14px;border-radius:12px;border:1px solid rgba(234,247,240,0.12);
          background:rgba(12,18,26,.66);font-size:13px;line-height:1.5;color:rgba(234,247,240,.74);box-shadow:0 14px 26px rgba(0,0,0,.46);">
          <strong style="font-weight:900;color:rgba(234,247,240,.92);">G-DEX Analytics ‚Äî Early Preview</strong><br>
          G-DEX Analytics is in an early preview stage. The metrics shown are demonstration values for UI preview only.
          <ul style="margin:6px 0 4px 18px; padding:0;">
            <li>GLIP staking &amp; treasury contracts</li><li>Quarterly rebate distributions</li><li>ESG vault allocations</li>
            <li>On-chain governance voting results</li><li>Carbon-offset tracking partners</li>
          </ul>
        </div>

        <div class="kpiGrid">
          <div class="kpi"><div class="label">Rebate Rate (R%)</div><div class="val" id="kRebate">‚Äî</div><div class="sub">Governance-set quarterly</div></div>
          <div class="kpi"><div class="label">Returned to Users (QTD)</div><div class="val" id="kReturned">‚Äî</div><div class="sub">Cumulative fee-rebates</div></div>
          <div class="kpi"><div class="label">ESG Vault Accrual (QTD)</div><div class="val" id="kESG">‚Äî</div><div class="sub">Green funds & impact</div></div>
          <div class="kpi"><div class="label">Transparency Index</div><div class="val" id="kTransparency">‚Äî</div><div class="sub">On-chain proof & disclosures</div></div>
          <div class="kpi"><div class="label">Gov. Turnout (last vote)</div><div class="val" id="kTurnout">‚Äî</div><div class="sub">Community participation</div></div>
          <div class="kpi"><div class="label">GLIP Green Score</div><div class="val" id="kGreen">‚Äî</div><div class="sub">Fee impact √ó ESG allocation</div></div>
        </div>

        <div class="anaGrid" style="margin-top:12px">
          <div class="vizCard">
            <div class="vizHead"><div class="title">Returned Value to Users ‚Äî Cumulative</div><div class="hint" id="rvHint">‚Äî</div></div>
            <div class="sparkWrap"><canvas id="spark"></canvas></div>
            <div class="legend"><div class="item"><span class="dot" style="background:#39d98a"></span> Users</div><div class="item" style="opacity:.78">Projection assumes constant R%</div></div>
          </div>
          <div class="vizCard">
            <div class="vizHead"><div class="title">Quarterly Rebate Split</div><div class="hint">Users / ESG / Treasury</div></div>
            <div class="donutWrap">
              <div class="ring"><canvas id="donut"></canvas><div class="centerStat"><div><div class="big" id="donutCenter">‚Äî</div><div class="cap">of Net Fees</div></div></div></div>
            </div>
            <div class="legend" id="donutLegend"></div>
          </div>
          <div class="vizCard">
            <div class="vizHead"><div class="title">Green Impact ‚Äî Carbon Offset (est.)</div><div class="hint" id="giHint">‚Äî</div></div>
            <div class="gaugeWrap"><div class="gauge"><canvas id="gauge"></canvas></div></div>
            <div class="legend"><div class="item"><span class="dot" style="background:#39d98a"></span> ESG-funded offsets</div><div class="item"><span class="dot" style="background:#11c48c"></span> target</div></div>
          </div>
        </div>
        <div class="ribbon" id="esgRibbon"><strong>ESG Contribution:</strong> <span id="esgNote">‚Äî</span></div>
      </section>

      <section class="card stake" id="stake">
        <h3>Stake</h3>
        <div style="background:rgba(12,18,26,.66);padding: 10px 14px;border-radius: 12px;margin-bottom: 14px;font-size: 14px;line-height: 1.45;
          color: rgba(234,247,240,.74);border: 1px solid rgba(234,247,240,0.12);box-shadow:0 14px 26px rgba(0,0,0,.46);">
          <b style="color:rgba(234,247,240,.92)">Staking (v1 Preview)</b><br>
          GLIP staking and reward distribution will be activated in G-DEX v2 after routing is stabilized.<br>
          This section currently displays demonstration values only.
        </div>

        <div class="statGrid">
          <div class="stat"><div style="opacity:.78;font-weight:900">APR</div><div id="apr" style="font-weight:900;font-size:22px;margin-top:4px;color:rgba(234,247,240,.92)">‚Äî</div></div>
          <div class="stat"><div style="opacity:.78;font-weight:900">My Staked</div><div id="myStaked" style="font-weight:900;font-size:22px;margin-top:4px;color:rgba(234,247,240,.92)">‚Äî</div></div>
          <div class="stat"><div style="opacity:.78;font-weight:900">Earned</div><div id="earned" style="font-weight:900;font-size:22px;margin-top:4px;color:rgba(234,247,240,.92)">‚Äî</div></div>
          <div class="stat"><div style="opacity:.78;font-weight:900">Lock</div><div style="font-weight:900;font-size:22px;margin-top:4px;color:rgba(234,247,240,.92)">Flexible</div></div>
        </div>

        <div class="tabs"><button class="btn" id="tabStake" type="button">Stake</button><button class="btn ghost" id="tabUnstake" type="button">Unstake</button></div>

        <div class="amountBox">
          <div class="input input--stake" style="margin:0;">
            <input id="stakeAmt" placeholder="0.0" type="number" min="0" step="any" inputmode="decimal">
            <button class="max" id="stakeMax" type="button">MAX</button>
          </div>
          <div style="margin-top:10px;color:rgba(234,247,240,.86);font-weight:900">Wallet: <span id="wAddr" style="font-weight:900">‚Äî</span></div>
          <div style="margin-top:6px; opacity:.76; font-size:12px;color:rgba(234,247,240,.70)">Wallet balance: <span id="stakeBalText">‚Äî</span></div>

          <div class="stake-actions">
            <button class="btn" id="btnConn" type="button">Connect Wallet</button>
            <button class="btn" id="btnStake" type="button">Stake GLIP</button>
          </div>
          <div style="margin-top:10px;color:rgba(234,247,240,.86);font-weight:900">Est. Rewards (30d): <span id="est30">‚Äî</span></div>
        </div>
        <div class="claimRow"><button class="btn ghost" id="btnClaim" type="button">Claim Rewards</button></div>
        <div style="margin-top:12px;opacity:.78;color:rgba(234,247,240,.72)">Note: Rewards stream per block. (Demo data)</div>
      </section>
    </main>
  </div>
</div>

<button id="toTop" aria-label="Back to top" title="Top">
  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5l7 7-1.4 1.4L13 9.8V20h-2V9.8L6.4 13.4 5 12z"/></svg>
</button>

<dialog id="tokModal">
  <header>
    <input id="tokSearch" type="text" placeholder="Search token by name, symbol, or address" autocomplete="off">
    <button id="tokClose" title="Close" type="button">‚úï</button>
  </header>
  <div class="content" style="padding:16px"><div id="tokList"></div></div>
</dialog>

<dialog id="uiModal">
  <header><div id="uiTitle">Notice</div><button id="uiClose" title="Close" type="button">‚úï</button></header>
  <div id="uiBody"><pre id="uiMessage"></pre></div>
  <div id="uiFooter">
    <button class="btn ghost" id="uiCopy" type="button" style="display:none;">Copy</button>
    <button class="btn ghost" id="uiCancel" type="button" style="display:none;">Cancel</button>
    <button class="btn" id="uiOk" type="button">OK</button>
  </div>
</dialog>

<script id="gdexPoolConfig" type="application/json">
{
  "recentPoolsText": "GLIP‚ÄìETH - SushiSwap V2",
  "volume24hUsd": "$ 10,580.18",
  "glipPriceUsd": "0.0556",
  "poolManualNote": "Manual: 1 GLIP \\u2248 0.000017 ETH\\nInitial GLIP‚ÄìETH pool on SushiSwap V2",
  "poolFooterNote": "G-DEX Pool v1 shows the GLIP‚ÄìETH pool created on SushiSwap V2. Metrics are updated manually during the early launch phase."
}
</script>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
let __bootOk=false, __bootErr=null;

const SWAP_SILENT = true;
const SAFE_GAS_PROXY=650000, SAFE_GAS_DIRECT=450000;
const WALLET_CONFIRM_TIMEOUT_MS=450000;

function withTimeout(promise, ms, tag="timeout"){
  let timer;
  const t=new Promise((_,rej)=>{timer=setTimeout(()=>rej(new Error(tag)),ms);});
  return Promise.race([Promise.resolve(promise).finally(()=>{try{clearTimeout(timer);}catch{}}),t]);
}
const $ = s => document.querySelector(s);
const short = a => a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : '‚Äî';

function fmtAgo(ts){
  try{
    const s=Math.max(0, Math.floor((Date.now()-Number(ts))/1000));
    if(s<10) return "just now";
    if(s<60) return `${s}s ago`;
    const m=Math.floor(s/60);
    if(m<60) return `${m}m ago`;
    const h=Math.floor(m/60);
    if(h<24) return `${h}h ago`;
    const d=Math.floor(h/24);
    return `${d}d ago`;
  }catch{return "‚Äî";}
}

function setSwapStatus(msg, {show=true, kind="info"}={}){
  const el=document.getElementById('swapStatus');
  if(!el) return;
  if(!msg){ el.style.display='none'; el.innerHTML=''; el.dataset.kind='info'; return; }
  el.dataset.kind = kind || "info";
  el.innerHTML = msg;
  el.style.display = show ? 'block' : 'none';
}
function normalizeErr(e){
  const msg = e?.reason || e?.error?.message || e?.data?.message || e?.message || String(e);
  return String(msg);
}
function isUserRejected(e){
  const m = normalizeErr(e).toLowerCase();
  return m.includes("user rejected") || m.includes("rejected") || m.includes("denied transaction") || m.includes("user denied");
}
function showErrorPopup(title, payload){
  let msg="";
  if(payload instanceof Error) msg = payload.message || String(payload);
  else if(typeof payload==="string") msg=payload;
  else msg=JSON.stringify(payload,null,2);
  setSwapStatus("",{show:false});
  uiAlert(title,msg,{copy:true});
}

/* In-app modal */
const uiModal=document.getElementById('uiModal');
const uiTitle=document.getElementById('uiTitle');
const uiMessage=document.getElementById('uiMessage');
const uiOk=document.getElementById('uiOk');
const uiCancel=document.getElementById('uiCancel');
const uiClose=document.getElementById('uiClose');
const uiCopy=document.getElementById('uiCopy');
let __uiResolve=null, __uiMode="alert";
function uiSupported(){return !!(uiModal && typeof uiModal.showModal==="function");}
function _uiOpen({title="Notice", message="", mode="alert", okText="OK", cancelText="Cancel", copy=false}){
  if(!uiSupported()){
    if(mode==="confirm") return Promise.resolve(window.confirm(title+"\n\n"+message));
    window.alert(title+"\n\n"+message); return Promise.resolve(true);
  }
  __uiMode=mode;
  uiTitle.textContent=title||"Notice";
  uiMessage.textContent=String(message??"");
  uiOk.textContent=okText||"OK";
  uiCancel.textContent=cancelText||"Cancel";
  uiCancel.style.display=(mode==="confirm")?"inline-block":"none";
  uiCopy.style.display=copy?"inline-block":"none";
  uiOk.onclick=null; uiCancel.onclick=null;

  return new Promise(resolve=>{
    __uiResolve=resolve;
    uiModal.showModal();
    const cleanup=(val)=>{
      try{uiModal.close();}catch{}
      __uiResolve=null; resolve(val);
    };
    uiOk.onclick=()=>cleanup(true);
    uiCancel.onclick=()=>cleanup(false);
  });
}
function uiAlert(title,message,{copy=false}={}){return _uiOpen({title,message,mode:"alert",okText:"OK",copy});}
function uiConfirm(title,message,{okText="Continue",cancelText="Cancel",copy=false}={}){return _uiOpen({title,message,mode:"confirm",okText,cancelText,copy});}
if(uiSupported()){
  uiClose.onclick=()=>{
    try{uiModal.close();}catch{}
    if(__uiResolve){
      const val=(__uiMode==="confirm")?false:true;
      const r=__uiResolve; __uiResolve=null; r(val);
    }
  };
  uiModal.addEventListener('click',(e)=>{ if(e.target===uiModal){ uiClose.click(); } });
  uiCopy.onclick=async()=>{
    try{
      await navigator.clipboard.writeText(uiMessage.textContent||"");
      uiCopy.textContent="Copied!";
      setTimeout(()=>{ uiCopy.textContent="Copy"; },900);
    }catch{}
  };
}

/* Manual config */
let gdexPoolConfig={};
(function readGdexConfig(){
  const el=document.getElementById('gdexPoolConfig'); if(!el) return;
  try{ const txt=el.textContent.trim(); if(!txt) return; gdexPoolConfig=JSON.parse(txt); }
  catch(e){ console.warn('[G-DEX] invalid gdexPoolConfig JSON', e); }
})();
function applyManualPoolConfig(){
  const cfg=gdexPoolConfig||{};
  const noteEl=document.getElementById('pManualNote');
  const footEl=document.getElementById('poolFooterNote');
  if(noteEl && cfg.poolManualNote) noteEl.textContent=cfg.poolManualNote;
  if(footEl && cfg.poolFooterNote) footEl.textContent=cfg.poolFooterNote;
}
applyManualPoolConfig();

/* Tickers (ÏõêÎ≥∏ Ïú†ÏßÄ) */
let __sushiPools=[], __sushiTickerIdx=0, __sushiTickerTimer=null, __backendOk=null, __backendLastAt=null;
function setPoolsTicker(item){
  const link=document.getElementById('poolsTickerLink');
  const pair=document.getElementById('poolsTickerPair');
  const meta=document.getElementById('poolsTickerMeta');
  if(!link||!pair||!meta) return;
  const feeTxt=(item&&item.feePct!=null)?` ¬∑ ${Number(item.feePct).toFixed(1)}%`:"";
  const tvlTxt=(item&&item.tvlText)?`TVL ${item.tvlText}`:"";
  link.href=(item&&item.url)?item.url:"https://www.sushi.com/ethereum/explore/pools";
  pair.textContent=(item&&item.name)?item.name:"‚Äî";
  meta.textContent=(tvlTxt+feeTxt).trim();
  renderPoolsMiniList();
}
function setPoolsTickerFallbackFromManual(){
  const cfg=gdexPoolConfig||{};
  const name=cfg.recentPoolsText||"GLIP‚ÄìETH - SushiSwap V2";
  setPoolsTicker({name,tvlText:"$‚Äî",feePct:0.3,url:"https://www.sushi.com/ethereum/explore/pools"});
}
async function fetchSushiPools(limit=5){
  const url=`${BACKEND_URL}/sushi/pools?chain=ethereum&limit=${encodeURIComponent(limit)}`;
  const r=await fetch(url,{method:'GET'});
  const j=await r.json().catch(()=> ({}));
  const items=j && Array.isArray(j.items)?j.items:[];
  return items.slice(0,limit);
}
function rotateSushiPools(){
  if(!__sushiPools.length) return;
  const wrap=document.getElementById('poolsTicker'); if(!wrap) return;
  wrap.classList.remove('fadeIn'); wrap.classList.add('fadeOut');
  setTimeout(()=>{
    __sushiTickerIdx=(__sushiTickerIdx+1)%__sushiPools.length;
    setPoolsTicker(__sushiPools[__sushiTickerIdx]);
    wrap.classList.remove('fadeOut'); wrap.classList.add('fadeIn');
  },220);
}
async function bootSushiPoolsTicker(){
  const wrap=document.getElementById('poolsTicker'); if(!wrap) return;
  try{
    __sushiPools=await fetchSushiPools(5);
    __backendOk=true; __backendLastAt=Date.now();
    if(!__sushiPools.length){ setPoolsTickerFallbackFromManual(); return; }
    __sushiTickerIdx=0; setPoolsTicker(__sushiPools[0]);
    if(__sushiTickerTimer) clearInterval(__sushiTickerTimer);
    __sushiTickerTimer=setInterval(rotateSushiPools,3500);

    setInterval(async()=>{
      try{
        const fresh=await fetchSushiPools(5);
        __backendOk=true; __backendLastAt=Date.now();
        if(Array.isArray(fresh)&&fresh.length){
          __sushiPools=fresh; __sushiTickerIdx=0; setPoolsTicker(__sushiPools[0]);
        }
      }catch(e){ __backendOk=false; console.warn('[sushi ticker refresh] failed',e); }
      finally{ updateStatusBoard(); }
    },60000);
  }catch(e){
    __backendOk=false; console.warn('[bootSushiPoolsTicker] failed',e);
    setPoolsTickerFallbackFromManual();
  }finally{ updateStatusBoard(); }
}
function renderPoolsMiniList(){
  const box=document.getElementById("poolsMiniList");
  const upd=document.getElementById("poolsUpdated");
  if(!box) return;
  const items=(Array.isArray(__sushiPools)&&__sushiPools.length)?__sushiPools.slice(0,3):[{
    name:(gdexPoolConfig?.recentPoolsText||"GLIP‚ÄìETH - SushiSwap V2"),tvlText:"$‚Äî",url:"https://www.sushi.com/ethereum/explore/pools"
  }];
  box.innerHTML=items.map(it=>`
    <a class="miniRow" href="${it.url||"https://www.sushi.com/ethereum/explore/pools"}" target="_blank" rel="noopener">
      <span class="l">${(it.name||"‚Äî")}</span>
      <span class="r">${it.tvlText?("TVL "+it.tvlText):""}</span>
    </a>`).join("");
  if(upd){ upd.textContent=__backendLastAt?(`Updated ${fmtAgo(__backendLastAt)}`):"Updated ‚Äî"; }
}

/* Major prices */
let __pricesItems=[], __pricesIdx=0, __pricesTimer=null, __cgOk=null, __cgLastAt=null;
function setPricesTicker(item){
  const link=document.getElementById('pricesTickerLink');
  const pair=document.getElementById('pricesTickerPair');
  const meta=document.getElementById('pricesTickerMeta');
  if(!link||!pair||!meta) return;
  link.href=item?.url||"https://www.coingecko.com";
  pair.textContent=item?.label||"‚Äî";
  meta.textContent=item?.meta||"";
  renderPricesMiniGrid();
}
function formatUSD(n){
  if(n==null||!Number.isFinite(Number(n))) return "‚Äî";
  const v=Number(n);
  const opt=v>=1000?{maximumFractionDigits:2}:v>=1?{maximumFractionDigits:4}:{maximumFractionDigits:8};
  return "$ "+v.toLocaleString(undefined,opt);
}
function formatPct(p){
  if(p==null||!Number.isFinite(Number(p))) return "";
  const v=Number(p); const sign=v>=0?"+":"";
  return `${sign}${v.toFixed(2)}%`;
}
const PRICE_TICKER_COINS=[
  { id:"bitcoin",  sym:"BTC", url:"https://www.coingecko.com/en/coins/bitcoin" },
  { id:"ethereum", sym:"ETH", url:"https://www.coingecko.com/en/coins/ethereum" },
  { id:"tether",   sym:"USDT",url:"https://www.coingecko.com/en/coins/tether" },
  { id:"usd-coin", sym:"USDC",url:"https://www.coingecko.com/en/coins/usd-coin" },
  { id:"solana",   sym:"SOL", url:"https://www.coingecko.com/en/coins/solana" },
  { id:"ripple",   sym:"XRP", url:"https://www.coingecko.com/en/coins/xrp" }
];
async function fetchMajorCoinPrices(){
  const ids=PRICE_TICKER_COINS.map(x=>x.id).join(",");
  const url=`https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=usd&include_24hr_change=true`;
  const r=await fetch(url,{method:"GET"});
  const j=await r.json().catch(()=> ({}));
  const items=[];
  for(const c of PRICE_TICKER_COINS){
    const row=j?.[c.id];
    items.push({label:`${c.sym} ¬∑ ${formatUSD(row?.usd)}`, meta:`24h ${formatPct(row?.usd_24h_change)}`, url:c.url});
  }
  return items.filter(x=>x && x.label);
}
function rotatePricesTicker(){
  if(!__pricesItems.length) return;
  const wrap=document.getElementById('pricesTicker'); if(!wrap) return;
  wrap.classList.remove('fadeIn'); wrap.classList.add('fadeOut');
  setTimeout(()=>{
    __pricesIdx=(__pricesIdx+1)%__pricesItems.length;
    setPricesTicker(__pricesItems[__pricesIdx]);
    wrap.classList.remove('fadeOut'); wrap.classList.add('fadeIn');
  },220);
}
function setPricesFallback(){
  __pricesItems=[
    { label:"BTC ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com" },
    { label:"ETH ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com" },
    { label:"USDT ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com" }
  ];
  __pricesIdx=0; setPricesTicker(__pricesItems[0]);
}
function renderPricesMiniGrid(){
  const box=document.getElementById("pricesMiniGrid");
  const upd=document.getElementById("pricesUpdated");
  if(!box) return;
  const items=(Array.isArray(__pricesItems)&&__pricesItems.length)?__pricesItems.slice(0,4):[
    { label:"BTC ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com/en/coins/bitcoin" },
    { label:"ETH ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com/en/coins/ethereum" },
    { label:"USDT ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com/en/coins/tether" },
    { label:"SOL ¬∑ ‚Äî", meta:"24h ‚Äî", url:"https://www.coingecko.com/en/coins/solana" },
  ];
  box.innerHTML=items.map(it=>{
    const parts=String(it.label||"‚Äî").split("¬∑").map(s=>s.trim());
    const sym=parts[0]||"‚Äî";
    const price=parts[1]||"‚Äî";
    const ch=String(it.meta||"").replace("24h","").trim();
    const isUp=ch && !ch.startsWith("-");
    return `
      <a class="priceMini" href="${it.url||"https://www.coingecko.com"}" target="_blank" rel="noopener">
        <div class="sym">${sym}</div><div class="price">${price}</div>
        <div class="chg ${isUp ? "up":"down"}">${ch||"‚Äî"}</div>
      </a>`;
  }).join("");
  if(upd){ upd.textContent=__cgLastAt?(`Updated ${fmtAgo(__cgLastAt)}`):"Updated ‚Äî"; }
}
async function bootMajorCoinPricesTicker(){
  const wrap=document.getElementById('pricesTicker'); if(!wrap) return;
  try{
    const items=await fetchMajorCoinPrices();
    __cgOk=true; __cgLastAt=Date.now();
    if(items && items.length){
      __pricesItems=items; __pricesIdx=0; setPricesTicker(__pricesItems[0]);
      if(__pricesTimer) clearInterval(__pricesTimer);
      __pricesTimer=setInterval(rotatePricesTicker,3000);

      setInterval(async()=>{
        try{
          const fresh=await fetchMajorCoinPrices();
          __cgOk=true; __cgLastAt=Date.now();
          if(fresh && fresh.length){
            __pricesItems=fresh; __pricesIdx=0; setPricesTicker(__pricesItems[0]);
          }
        }catch{ __cgOk=false; }
        finally{ updateStatusBoard(); }
      },60000);
      return;
    }
    setPricesFallback();
  }catch{ __cgOk=false; setPricesFallback(); }
  finally{ updateStatusBoard(); }
}
function bindMetricFillActions(){
  const pr=document.getElementById("poolsRefreshBtn");
  if(pr) pr.addEventListener("click", async ()=>{
    try{
      const fresh=await fetchSushiPools(5);
      __backendOk=true; __backendLastAt=Date.now();
      if(Array.isArray(fresh)&&fresh.length){ __sushiPools=fresh; __sushiTickerIdx=0; setPoolsTicker(__sushiPools[0]); }
    }catch{ __backendOk=false; }
    finally{ renderPoolsMiniList(); updateStatusBoard(); }
  });
  const cr=document.getElementById("pricesRefreshBtn");
  if(cr) cr.addEventListener("click", async ()=>{
    try{
      const fresh=await fetchMajorCoinPrices();
      __cgOk=true; __cgLastAt=Date.now();
      if(Array.isArray(fresh)&&fresh.length){ __pricesItems=fresh; __pricesIdx=0; setPricesTicker(__pricesItems[0]); }
    }catch{ __cgOk=false; }
    finally{ renderPricesMiniGrid(); updateStatusBoard(); }
  });
}

/* DApp / addresses */
const DAPP_HOST='gdex-app.com';
const GLIP_TOKEN_ADDRESS='0xD0b86b79AE4b8D7bb88b37EBe228ce343D79794e';
const SUSHI_ETHEREUM_POOL_BASE='https://www.sushi.com/ethereum/pool';
const SUSHI_ROUTER_V2="0xd9e1cE17f2641f24aE83637ab66a2cca9C378B9F";
const SUSHI_FACTORY_V2="0xC0AEe478e3658e2610c5F7A4A2E1777cE9e4f2Ac";
const WETH_MAINNET="0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2";
const GDEX_PROXY_ROUTER="0xF89Dc5519C2BfDc3dab5BE2F7803dfb2E16E9E64";
const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function openMetaMaskDeepLink(){
  const dappUrl=`https://${DAPP_HOST}`;
  const target=dappUrl.replace(/^https?:\/\//,'');
  window.location.href=`https://metamask.app.link/dapp/${target}`;
}

/* Token list (ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú) */
const tokenList = [
  {symbol:"ETH", name:"Ethereum", address:"ETH", decimals:18, logo:"https://assets.coingecko.com/coins/images/279/standard/ethereum.png"},
  {symbol:"GLIP", name:"GLIP Token", address:GLIP_TOKEN_ADDRESS, decimals:18, logo:"https://cdn.imweb.me/thumbnail/20251023/7c2d51fa8c1bc.png"},
  {symbol:"USDT", name:"Tether USD", address:"0xdAC17F958D2ee523a2206206994597C13D831ec7", decimals:6, logo:"https://assets.coingecko.com/coins/images/325/standard/Tether.png"},
  {symbol:"USDC", name:"USD Coin", address:"0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", decimals:6, logo:"https://info-blog.to/wp-content/uploads/2025/05/usdc-coin-wallpaper.png"},
  {symbol:"DAI", name:"Dai", address:"0x6B175474E89094C44Da98b954EedeAC495271d0F", decimals:18, logo:"https://images.saymedia-content.com/.image/t_share/MTgyNTk1NDg5MDc2Njg0MTI4/maker-protokoll-dai-stablecoin-and-mkr-token-explained.png"},
  {symbol:"FRAX", name:"Frax", address:"0x853d955aCEf822Db058eb8505911ED77F175b99e", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/13422/large/LFRAX.png?1751911193"},
  {symbol:"WBTC", name:"Wrapped BTC", address:"0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599", decimals:8, logo:"https://assets.coingecko.com/coins/images/7598/standard/wrapped_bitcoin_wbtc.png"},
  {symbol:"MATIC", name:"Polygon", address:"0x7D1AfA7B718fb893dB30A3aBc0Cfc608AaCfeBB0", decimals:18, logo:"https://assets.coingecko.com/coins/images/4713/standard/polygon.png"},
  {symbol:"BNB", name:"BNB", address:"0xB8c77482e45F1F44De1745F52C74426C631bDD52", decimals:18, logo:"https://assets.coingecko.com/coins/images/825/standard/bnb-icon2_2x.png"},
  {symbol:"XRP", name:"XRP (ERC20-wrap)", address:"0x1D2F0da169ceB9fC7C8A636a7fB3b73bEccFFa75", decimals:6, logo:"https://assets.coingecko.com/coins/images/44/standard/xrp-symbol-white-128.png"},
  {symbol:"LINK", name:"Chainlink", address:"0x514910771AF9Ca656af840dff83E8264EcF986CA", decimals:18, logo:"https://assets.coingecko.com/coins/images/877/standard/chainlink-new-logo.png"},
  {symbol:"UNI",  name:"Uniswap", address:"0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984", decimals:18, logo:"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984/logo.png"},
  {symbol:"AAVE", name:"Aave", address:"0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9", decimals:18, logo:"https://assets.coingecko.com/coins/images/12645/standard/AAVE.png"},
  {symbol:"LDO", name:"Lido DAO", address:"0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32", decimals:18, logo:"https://assets.coingecko.com/coins/images/13573/standard/Lido_DAO.png"},
  {symbol:"SNX", name:"Synthetix", address:"0xC011A72400E58ecD99Ee497CF89E3775d4bd732F", decimals:18, logo:"https://assets.coingecko.com/coins/images/3406/standard/SNX.png"},
  {symbol:"CRV", name:"Curve DAO", address:"0xD533a949740bb3306d119CC777fa900bA034cd52", decimals:18, logo:"https://assets.coingecko.com/coins/images/12124/standard/Curve.png"},
  {symbol:"COMP", name:"Compound", address:"0xc00e94Cb662C3520282E6f5717214004A7f26888", decimals:18, logo:"https://assets.coingecko.com/coins/images/10775/standard/COMP.png"},
  {symbol:"MKR", name:"Maker", address:"0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2", decimals:18, logo:"https://assets.coingecko.com/coins/images/1364/standard/Mark_Maker.png"},
  {symbol:"YFI", name:"yearn.finance", address:"0x0bc529c00C6401aEF6D220BE8C6Ea1667F6Ad93e", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/11849/large/yearn.jpg"},
  {symbol:"SUSHI", name:"Sushi", address:"0x6B3595068778DD592e39A122f4f5a5CF09C90fE2", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/12271/large/512x512_Logo_no_chop.png"},
  {symbol:"BAL", name:"Balancer", address:"0xba100000625a3754423978a60c9317c58a424e3D", decimals:18, logo:"https://assets.coingecko.com/coins/images/11683/standard/Balancer.png"},
  {symbol:"1INCH", name:"1inch", address:"0x111111111117dC0aa78b770fA6A738034120C302", decimals:18, logo:"https://assets.coingecko.com/coins/images/13469/standard/1inch-token.png"},
  {symbol:"ENS", name:"Ethereum Name Service", address:"0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/19785/large/ENS.jpg"},
  {symbol:"OP", name:"Optimism", address:"0x4200000000000000000000000000000000000042", decimals:18, logo:"https://assets.coingecko.com/coins/images/25244/standard/Optimism.png"},
  {symbol:"ARB", name:"Arbitrum", address:"0x912CE59144191C1204E64559FE8253a0e49E6548", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/16547/large/arb.jpg"},
  {symbol:"PEPE", name:"Pepe", address:"0x6982508145454Ce325dDbE47a25d4ec3d2311933", decimals:18, logo:"https://assets.coingecko.com/coins/images/29850/standard/pepe-token.jpeg"},
  {symbol:"SHIB", name:"Shiba Inu", address:"0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE", decimals:18, logo:"https://assets.coingecko.com/coins/images/11939/standard/shiba.png"},
  {symbol:"DOGE", name:"Dogecoin (ERC20 wrap)", address:"0x4206931337dc273a630d328da6441786bfad668f", decimals:8, logo:"https://assets.coingecko.com/coins/images/5/standard/dogecoin.png"},
  {symbol:"BAT", name:"Basic Attention", address:"0x0D8775F648430679A709E98d2b0Cb6250d2887EF", decimals:18, logo:"https://assets.coingecko.com/coins/images/677/standard/basic-attention-token.png"},
  {symbol:"MANA", name:"Decentraland", address:"0x0F5D2fB29fb7d3CFeE444a200298f468908cC942", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/878/large/decentraland-mana.png"},
  {symbol:"SAND", name:"The Sandbox", address:"0x3845badAde8e6DFF049820680d1F14bD3903a5d0", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/12129/large/sandbox_logo.jpg"},
  {symbol:"AXS", name:"Axie Infinity", address:"0xBB0E17EF65F82Ab018d8EDd776e8DD940327B28b", decimals:18, logo:"https://assets.coingecko.com/coins/images/13029/standard/axie_infinity_logo.png"},
  {symbol:"GRT", name:"The Graph", address:"0xc944E90C64B2c07662A292be6244BDf05Cda44a7", decimals:18, logo:"https://assets.coingecko.com/coins/images/13397/standard/Graph_Token.png"},
  {symbol:"FTM", name:"Fantom", address:"0x4e15361FD6b4BB609Fa63C81A2be19d873717870", decimals:18, logo:"https://coin-images.coingecko.com/coins/images/16036/large/Fantom.png"},
  {symbol:"NEAR", name:"NEAR (ERC20)", address:"0x85F17Cf997934a597031b2E18a9aB6ebD4B9f6a4", decimals:24, logo:"https://coin-images.coingecko.com/coins/images/10365/large/near.jpg"},
  {symbol:"ANKR", name:"Ankr", address:"0x8290333ceF9e6D528dD5618Fb97a76f268f3EDD4", decimals:18, logo:"https://assets.coingecko.com/coins/images/4324/standard/U85xTl2.png"}
];

function getTokenMeta(symbolOrAddress){
  return tokenList.find(t=>t.symbol===symbolOrAddress || t.address?.toLowerCase()===symbolOrAddress?.toLowerCase());
}
function metaIsETH(meta){ return !!meta && (meta.symbol==="ETH" || meta.address==="ETH"); }
function getSelectedMeta(symEl){
  if(!symEl) return null;
  const sym=String(symEl.textContent||"").trim();
  const addr=String(symEl.dataset.address||"").trim();
  if(addr){ const byAddr=getTokenMeta(addr); if(byAddr) return byAddr; }
  const bySym=getTokenMeta(sym); if(bySym) return bySym;
  return null;
}
function safeSetImg(imgEl, src){
  if(!imgEl) return;
  imgEl.onerror=()=>{ imgEl.src="G_DEX_icon.png"; };
  imgEl.src=src||"G_DEX_icon.png";
}
function initDefaults(){
  const ETH=tokenList.find(t=>t.symbol==="ETH");
  const GLIP=getTokenMeta("GLIP");
  safeSetImg($('#sellI'), ETH?.logo);  $('#sellS').textContent="ETH";  $('#sellS').dataset.address="ETH";
  safeSetImg($('#buyI'),  GLIP?.logo); $('#buyS').textContent="GLIP";  $('#buyS').dataset.address=GLIP?.address||GLIP_TOKEN_ADDRESS;
  safeSetImg($('#pT0Img'), ETH?.logo);  $('#pT0Sym').textContent="ETH"; $('#pT0Sym').dataset.address="ETH";
  safeSetImg($('#pT1Img'), GLIP?.logo); $('#pT1Sym').textContent="GLIP"; $('#pT1Sym').dataset.address=GLIP?.address||GLIP_TOKEN_ADDRESS;
}

/* Token modal */
const dlg=document.getElementById('tokModal');
const list=document.getElementById('tokList');
const tokSearchInput=document.getElementById('tokSearch');
let target=null;
function dialogSupported(d){return !!(d && typeof d.showModal==="function");}
function renderTokenList(query=""){
  const q=query.trim().toLowerCase();
  const filtered=!q?tokenList:tokenList.filter(t=>
    t.symbol.toLowerCase().includes(q) || t.name.toLowerCase().includes(q) || (t.address && t.address.toLowerCase().includes(q))
  );
  if(!filtered.length){ list.innerHTML=`<div style="padding:6px 0;opacity:.8;font-size:13px;color:rgba(234,247,240,.74)">No tokens match.</div>`; return; }
  list.innerHTML=filtered.map(t=>`
    <div class="item" data-sym="${t.symbol}" style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer">
      <img src="${t.logo}" onerror="this.src='G_DEX_icon.png'" alt="">
      <strong>${t.symbol}</strong>
      <span style="margin-left:6px;opacity:.85">${t.name}</span>
      <span style="margin-left:auto;opacity:.72">${t.address==="ETH"?"ETH":t.address.slice(0,6)+"‚Ä¶"+t.address.slice(-4)}</span>
    </div>`).join('');
}
function openFor(imgEl, symEl){
  target={imgEl,symEl};
  if(tokSearchInput) tokSearchInput.value="";
  renderTokenList("");
  if(dialogSupported(dlg)){
    dlg.showModal();
    setTimeout(()=>{ tokSearchInput && tokSearchInput.focus(); },10);
  }else{
    uiAlert("Token selector","Your browser does not support <dialog>. Please open on a modern browser.",{copy:false});
  }
}
if(list){
  list.onclick=async e=>{
    const row=e.target.closest('.item'); if(!row||!target) return;
    const t=tokenList.find(x=>x.symbol===row.dataset.sym); if(!t) return;
    safeSetImg(target.imgEl, t.logo);
    target.symEl.textContent=t.symbol;
    target.symEl.dataset.address=t.address;
    try{ dlg.close(); }catch{}
    setTimeout(()=>{ updatePricePreview(); refreshAllBalances(); updateStatusBoard(); },50);
  };
}
const tokCloseBtn=document.getElementById('tokClose');
if(tokCloseBtn) tokCloseBtn.onclick=()=>{ try{ dlg.close(); }catch{} };
if(dlg) dlg.addEventListener('click',e=>{ if(e.target===dlg){ try{ dlg.close(); }catch{} } });
if(tokSearchInput) tokSearchInput.addEventListener('input', e=> renderTokenList(e.target.value));
function bindTokenButtons(){
  const sellBtn=document.getElementById('sellBtn');
  const buyBtn=document.getElementById('buyBtn');
  const pT0Btn=document.getElementById('pT0Btn');
  const pT1Btn=document.getElementById('pT1Btn');
  if(sellBtn) sellBtn.addEventListener('click', ()=>openFor($('#sellI'), $('#sellS')));
  if(buyBtn)  buyBtn.addEventListener('click',  ()=>openFor($('#buyI'),  $('#buyS')));
  if(pT0Btn)  pT0Btn.addEventListener('click',  ()=>openFor($('#pT0Img'),$('#pT0Sym')));
  if(pT1Btn)  pT1Btn.addEventListener('click',  ()=>openFor($('#pT1Img'),$('#pT1Sym')));
}

/* Flip */
function flipTokenMeta(imgA,symA,imgB,symB){
  const s=imgA.src; imgA.src=imgB.src; imgB.src=s;
  const t=symA.textContent; symA.textContent=symB.textContent; symB.textContent=t;
  const a=symA.dataset.address,b=symB.dataset.address; symA.dataset.address=b||""; symB.dataset.address=a||"";
}
function bindFlip(){
  const flipBtn=document.getElementById('flip');
  const pFlipBtn=document.getElementById('pFlip');
  if(flipBtn) flipBtn.addEventListener('click', ()=>{
    flipTokenMeta($('#sellI'),$('#sellS'),$('#buyI'),$('#buyS'));
    setTimeout(()=>{ updatePricePreview(); refreshAllBalances(); updateStatusBoard(); },50);
  });
  if(pFlipBtn) pFlipBtn.addEventListener('click', ()=>{
    flipTokenMeta($('#pT0Img'),$('#pT0Sym'),$('#pT1Img'),$('#pT1Sym'));
    setTimeout(()=>{ refreshAllBalances(); updateStatusBoard(); },50);
  });
}

/* Web3 / contracts */
let userAddress=null, provider=null, signer=null;
let sushiRouterRO=null, sushiRouterRW=null, factory=null, proxyRouter=null;
let __proxyFeeLoaded=false, __proxyPERCENT_BPS=0, __proxyFlatFeeWei=null, __proxyFeeWallet=null;
let __lastSwapMode="‚Äî";

const SUSHI_ROUTER_RO_ABI=["function getAmountsOut(uint amountIn, address[] memory path) view returns (uint[] memory amounts)"];
const SUSHI_ROUTER_RW_ABI=[
  "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable",
  "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)",
  "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)"
];
const FACTORY_ABI=["function getPair(address tokenA, address tokenB) view returns (address pair)"];
const PAIR_ABI=[
  "function token0() view returns (address)","function token1() view returns (address)",
  "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)"
];
const ERC20_ABI=[
  "function decimals() view returns (uint8)","function symbol() view returns (string)",
  "function balanceOf(address owner) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
const PROXY_ABI=[
  "function BPS_DENOM() view returns (uint16)",
  "function PERCENT_BPS() view returns (uint16)",
  "function flatFeeWei() view returns (uint256)",
  "function WETH() view returns (address)",
  "function feeRecipient() view returns (address)",
  "function sushiRouter() view returns (address)",
  "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint256 amountOutMin, address[] path, address to, uint256 deadline) payable",
  "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint256 amountIn, uint256 amountOutMin, address[] path, address to, uint256 deadline) payable",
  "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint256 amountIn, uint256 amountOutMin, address[] path, address to, uint256 deadline) payable",
  "event FeeTaken(address indexed payer, address indexed token, uint256 amount, uint16 bps)",
  "event Forwarded(address indexed sushiRouter, address indexed user, uint8 swapType)"
];

function ensureWeb3(){
  if(!window.ethereum) throw new Error("No wallet detected.");
  if(!window.ethers) throw new Error("ethers.js failed to load.");
  if(!provider) provider=new ethers.providers.Web3Provider(window.ethereum,"any");
  if(!signer) signer=provider.getSigner();
  if(!sushiRouterRO) sushiRouterRO=new ethers.Contract(SUSHI_ROUTER_V2,SUSHI_ROUTER_RO_ABI,provider);
  if(!sushiRouterRW) sushiRouterRW=new ethers.Contract(SUSHI_ROUTER_V2,SUSHI_ROUTER_RW_ABI,signer);
  if(!factory) factory=new ethers.Contract(SUSHI_FACTORY_V2,FACTORY_ABI,provider);
  if(!proxyRouter) proxyRouter=new ethers.Contract(GDEX_PROXY_ROUTER,PROXY_ABI,signer);
}
async function ensureMainnet(){
  ensureWeb3();
  const net=await provider.getNetwork();
  if(!net || net.chainId!==1) throw new Error(`Wrong network detected (chainId=${net?.chainId}). Please switch to Ethereum Mainnet.`);
}
async function loadProxyFeeParams(){
  try{
    ensureWeb3();
    const feeWallet=await proxyRouter.feeRecipient();
    const PERCENT_BPSBN=await proxyRouter.PERCENT_BPS();
    const flatFee=await proxyRouter.flatFeeWei();
    __proxyFeeWallet=feeWallet;
    __proxyPERCENT_BPS=Number(PERCENT_BPSBN.toString());
    __proxyFlatFeeWei=flatFee;
    __proxyFeeLoaded=true;
  }catch(e){
    console.warn('[proxy fee params] failed',e);
    try{
      __proxyPERCENT_BPS=(__proxyPERCENT_BPS||30);
      __proxyFlatFeeWei=(__proxyFlatFeeWei||ethers.utils.parseEther("0"));
    }catch{}
    __proxyFeeLoaded=false;
  }finally{ updateStatusBoard(); }
}

/* Connect */
async function connectWallet(){
  try{
    if(typeof window.ethereum==='undefined'){
      if(isMobile){ openMetaMaskDeepLink(); return; }
      await uiAlert("No wallet detected","‚Ä¢ Mobile: open this site in MetaMask in-app browser.\n‚Ä¢ Desktop: install MetaMask extension.");
      return;
    }
    ensureWeb3();
    const accounts=await window.ethereum.request({method:'eth_requestAccounts'});
    if(!accounts || !accounts.length) throw new Error('No accounts returned');
    userAddress=accounts[0];
    const wAddrEl=document.getElementById('wAddr');
    if(wAddrEl) wAddrEl.textContent=short(userAddress);
    ['poolConnect','btnConn','swapConnect'].forEach(id=>{
      const el=document.getElementById(id);
      if(el){ el.textContent='Connected'; el.classList.add('ghost'); }
    });

    await ensureMainnet();
    await loadProxyFeeParams();
    await refreshAllBalances();
    updatePricePreview();
    updateStatusBoard();

    if(window.ethereum.on){
      window.ethereum.on('accountsChanged', async acc=>{
        userAddress = acc && acc.length ? acc[0] : null;
        const wAddrEl2=document.getElementById('wAddr');
        if(wAddrEl2) wAddrEl2.textContent=short(userAddress);
        __proxyFeeLoaded=false;
        await loadProxyFeeParams();
        await refreshAllBalances();
        updatePricePreview();
        updateStatusBoard();
      });
      window.ethereum.on('chainChanged', _=> location.reload());
    }
  }catch(e){
    console.error('[connectWallet]',e);
    await uiAlert('Wallet connection failed', (e?.message||'Please check MetaMask and try again.'), {copy:true});
  }finally{ updateStatusBoard(); }
}

/* Pool ‚Üí Sushi */
function openSushiGlipEthPool(){
  const url=`${SUSHI_ETHEREUM_POOL_BASE}?token0=NATIVE&token1=${GLIP_TOKEN_ADDRESS}`;
  window.open(url,'_blank','noopener');
}
function bindPoolSupplyButton(){
  const btn=document.getElementById('poolSupply');
  if(btn) btn.addEventListener('click', openSushiGlipEthPool);
}
function bindPoolQuickButtons(){
  const add=document.getElementById("poolAdd");
  const rm=document.getElementById("poolRemove");
  const pos=document.getElementById("poolPositions");
  const go=()=>openSushiGlipEthPool();
  if(add) add.addEventListener("click",go);
  if(rm) rm.addEventListener("click",go);
  if(pos) pos.addEventListener("click",go);
}

/* TOP */
function bindTop(){
  const toTop=document.getElementById('toTop');
  function toggleTop(){ (window.scrollY>200)?toTop.classList.add('show'):toTop.classList.remove('show'); }
  toggleTop(); window.addEventListener('scroll',toggleTop);
  toTop.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
}

/* PWA install */
let deferredPrompt=null;
const isIos=/iphone|ipad|ipod/i.test(navigator.userAgent);
function isStandaloneMode(){ return matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true; }
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault(); deferredPrompt=e;
  document.querySelectorAll('.install-cta').forEach(b=>b.style.display='inline-flex');
});
window.addEventListener('appinstalled', ()=>{ document.querySelectorAll('.install-cta').forEach(b=>b.style.display='none'); });
async function handleInstallClick(){
  if(isStandaloneMode()){ await uiAlert('Install','G-DEX is already installed.'); return; }
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.finally(()=>{
      deferredPrompt=null; document.querySelectorAll('.install-cta').forEach(b=>b.style.display='none');
    });
    return;
  }
  if(isIos){ await uiAlert('Install on iOS','In Safari: share ‚Üí "Add to Home Screen".'); return; }
  await uiAlert('Install','Use browser menu ‚Üí "Add to home screen".');
}

/* Analytics demo (ÏõêÎ≥∏ Ïú†ÏßÄ) */
const demoAnalytics={rebateRate:12,feeNet:420000,split:{users:0.70,esg:0.20,treasury:0.10},
  returnedSeries:[1200,3400,5600,8300,12000,16200,21000,27900,35000,43600,52000,61500,72000,84500,98000,112000,127800,145200,163500,182400],
  turnout:38,transparency:92,co2:{current:152,target:220}};
function fillKpis(d){
  const {rebateRate,feeNet,split,turnout,transparency}=d;
  const returned=feeNet*(rebateRate/100)*split.users;
  const esgAccrual=feeNet*(rebateRate/100)*split.esg;
  document.getElementById('kRebate').textContent=rebateRate.toFixed(0)+"%";
  document.getElementById('kReturned').textContent="$ "+Math.round(returned).toLocaleString();
  document.getElementById('kESG').textContent="$ "+Math.round(esgAccrual).toLocaleString();
  document.getElementById('kTransparency').textContent=transparency.toFixed(0)+"%";
  document.getElementById('kTurnout').textContent=turnout.toFixed(0)+"%";
  const greenScore=Math.round((transparency/100)*(split.esg*rebateRate)*10);
  document.getElementById('kGreen').textContent=greenScore;
  document.getElementById('rvHint').textContent="Net Fees $"+feeNet.toLocaleString()+" ¬∑ R% "+rebateRate+"%";
  document.getElementById('esgNote').textContent=`Current quarter alloc: Users ${(split.users*100).toFixed(0)}% ¬∑ ESG ${(split.esg*100).toFixed(0)}% ¬∑ Treasury ${(split.treasury*100).toFixed(0)}%.`;
  document.getElementById('giHint').textContent=`tCO‚ÇÇe offset est. ${d.co2.current}/${d.co2.target}`;
}
function drawSpark(d){
  const el=document.getElementById('spark'); const ctx=el.getContext('2d');
  const DPR=window.devicePixelRatio||1;
  const w=el.clientWidth*DPR, h=el.clientHeight*DPR;
  el.width=w; el.height=h;
  const data=d.returnedSeries;
  const min=Math.min(...data), max=Math.max(...data);
  const padX=20*DPR, padY=16*DPR;
  const x=i=>padX+(i/(data.length-1))*(w-padX*2);
  const y=v=>{ const t=(v-min)/(max-min||1); return h-padY-t*(h-padY*2); };
  const grad=ctx.createLinearGradient(0,y(max),0,h-padY);
  grad.addColorStop(0,"rgba(123,183,255,.35)");
  grad.addColorStop(1,"rgba(0,0,0,0)");
  ctx.beginPath(); ctx.moveTo(x(0),y(data[0]));
  data.forEach((v,i)=>ctx.lineTo(x(i),y(v)));
  ctx.lineTo(x(data.length-1),h-padY); ctx.lineTo(x(0),h-padY); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();
  ctx.beginPath(); ctx.moveTo(x(0),y(data[0]));
  data.forEach((v,i)=>ctx.lineTo(x(i),y(v)));
  ctx.lineWidth=2.5*DPR; ctx.strokeStyle="#7bb7ff"; ctx.stroke();
}
function drawDonut(d){
  const canvas=document.getElementById('donut'); const ctx=canvas.getContext('2d');
  const DPR=window.devicePixelRatio||1;
  const size=canvas.parentElement.clientWidth;
  const dim=Math.min(200,size);
  canvas.width=dim*DPR; canvas.height=dim*DPR;
  const cx=canvas.width/2, cy=canvas.height/2;
  const rOuter=(dim*DPR)/2-6*DPR;
  const rInner=rOuter*0.62;
  const parts=[
    {key:"Users",val:d.split.users,color:"#7bb7ff"},
    {key:"ESG",val:d.split.esg,color:"#39d98a"},
    {key:"Treasury",val:d.split.treasury,color:"rgba(234,247,240,.35)"}
  ];
  let start=-Math.PI/2;
  parts.forEach(p=>{
    const arc=p.val*Math.PI*2;
    ctx.beginPath();
    ctx.arc(cx,cy,rOuter,start,start+arc);
    ctx.arc(cx,cy,rInner,start+arc,start,true);
    ctx.closePath();
    ctx.fillStyle=p.color; ctx.fill();
    start+=arc;
  });
  document.getElementById('donutCenter').textContent=d.rebateRate+"%";
  const leg=document.getElementById('donutLegend');
  leg.innerHTML=parts.map(p=>`<div class="item"><span class="dot" style="background:${p.color}"></span>${p.key} ${(p.val*100).toFixed(0)}%</div>`).join("");
}
function drawGauge(d){
  const canvas=document.getElementById('gauge'); const ctx=canvas.getContext('2d');
  const DPR=window.devicePixelRatio||1;
  const w=canvas.parentElement.clientWidth, h=120;
  canvas.width=w*DPR; canvas.height=h*DPR;
  const cx=canvas.width/2, cy=canvas.height*0.95;
  const r=Math.min(w*DPR*0.42,h*DPR*0.9);
  ctx.lineWidth=16*DPR; ctx.lineCap="round";
  ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,Math.PI*2);
  ctx.strokeStyle="rgba(234,247,240,.12)"; ctx.stroke();
  const pct=Math.max(0,Math.min(1,d.co2.current/d.co2.target));
  ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,Math.PI+pct*Math.PI);
  ctx.strokeStyle="#7bb7ff"; ctx.stroke();
}

/* Balances (RAW Ï†ÄÏû• + Ï¥àÏÜåÏï° ÌëúÏãú Í∞úÏÑ†) */
function hexToBigInt(hex){ return (!hex)?0n:BigInt(hex); }
function formatUnitsBigIntFull(bn, decimals){
  const d=BigInt(decimals);
  const base=10n**d;
  const whole=bn/base;
  let frac=(bn%base).toString().padStart(Number(d),'0');
  frac=frac.replace(/0+$/,'');
  return frac ? `${whole.toString()}.${frac}` : whole.toString();
}
function pad32(addr){ return addr.toLowerCase().replace(/^0x/,'').padStart(64,'0'); }
async function ethGetBalance(addr){
  const hex=await ethereum.request({method:'eth_getBalance', params:[addr,'latest']});
  return hexToBigInt(hex);
}
async function erc20BalanceOf(tokenAddr, owner){
  const data="0x70a08231"+pad32(owner);
  const hex=await ethereum.request({method:'eth_call', params:[{to:tokenAddr,data},'latest']});
  return hexToBigInt(hex);
}
async function fetchTokenBalanceString(meta){
  try{
    if(!userAddress||!window.ethereum) return null;
    if(!meta) return null;
    if(metaIsETH(meta)){
      const bn=await ethGetBalance(userAddress);
      return formatUnitsBigIntFull(bn,18);
    }else{
      const bn=await erc20BalanceOf(meta.address,userAddress);
      return formatUnitsBigIntFull(bn,meta.decimals ?? 18);
    }
  }catch(e){ console.warn('[balance] fail',e); return null; }
}
function setBalText(elId, sym, rawStr){
  const el=document.getElementById(elId);
  if(!el) return;
  el.dataset.sym = sym || "";
  el.dataset.raw = rawStr || "";
  if(!rawStr){ el.textContent=`Bal: ‚Äî`; return; }

  const n=Number(rawStr);
  let pretty=rawStr;
  if(Number.isFinite(n)){
    if(n>0 && n<0.000001) pretty="<0.000001";
    else if(n>=1000000) pretty=n.toLocaleString(undefined,{maximumFractionDigits:2});
    else pretty=n.toLocaleString(undefined,{maximumFractionDigits:6});
  }
  el.textContent=`Bal: ${pretty} ${sym}`;
}
async function refreshAllBalances(){
  if(!userAddress){
    setBalText('sellBal',$('#sellS')?.textContent||'',null);
    setBalText('buyBal',$('#buyS')?.textContent||'',null);
    setBalText('pBal0',$('#pT0Sym')?.textContent||'',null);
    setBalText('pBal1',$('#pT1Sym')?.textContent||'',null);
    const sb=document.getElementById('stakeBalText'); if(sb){ sb.textContent='‚Äî'; sb.dataset.raw=""; }
    updateStatusBoard(); return;
  }
  const sellMeta=getSelectedMeta(document.getElementById('sellS'));
  const buyMeta=getSelectedMeta(document.getElementById('buyS'));
  const sellSym=document.getElementById('sellS').textContent;
  const buySym=document.getElementById('buyS').textContent;

  const sellBalStr=await fetchTokenBalanceString(sellMeta);
  const buyBalStr=await fetchTokenBalanceString(buyMeta);
  setBalText('sellBal',sellSym,sellBalStr);
  setBalText('buyBal',buySym,buyBalStr);

  const p0Meta=getSelectedMeta(document.getElementById('pT0Sym'));
  const p1Meta=getSelectedMeta(document.getElementById('pT1Sym'));
  const p0Sym=document.getElementById('pT0Sym').textContent;
  const p1Sym=document.getElementById('pT1Sym').textContent;
  const p0BalStr=await fetchTokenBalanceString(p0Meta);
  const p1BalStr=await fetchTokenBalanceString(p1Meta);
  setBalText('pBal0',p0Sym,p0BalStr);
  setBalText('pBal1',p1Sym,p1BalStr);

  const glip=getTokenMeta("GLIP");
  const glipBalStr=await fetchTokenBalanceString(glip);
  const sb=document.getElementById('stakeBalText');
  if(sb){
    sb.dataset.raw = glipBalStr || "";
    sb.textContent = (!glipBalStr) ? '‚Äî'
      : `${Number(glipBalStr).toLocaleString(undefined,{maximumFractionDigits:6})} GLIP`;
  }
  updateStatusBoard();
}

/* Routing helpers */
function addrForPath(meta){ return metaIsETH(meta) ? WETH_MAINNET : meta.address; }
const __pairCache=new Map();
async function getPairAddressCached(a,b){
  const A=a.toLowerCase(), B=b.toLowerCase();
  const key=(A<B)?`${A}-${B}`:`${B}-${A}`;
  if(__pairCache.has(key)) return __pairCache.get(key);
  const p=await factory.getPair(a,b);
  __pairCache.set(key,p); return p;
}
async function hasPair(a,b){
  try{ const p=await getPairAddressCached(a,b); return !!p && p!==ethers.constants.AddressZero; }
  catch{ return false; }
}
function uniqPaths(paths){
  const seen=new Set(), out=[];
  for(const p of paths){
    const k=p.map(x=>x.toLowerCase()).join('>');
    if(seen.has(k)) continue;
    seen.add(k); out.push(p);
  }
  return out;
}
async function getPathCandidates(tokenIn, tokenOut){
  if(!tokenIn || !tokenOut) return [];
  const A=tokenIn.toLowerCase(), B=tokenOut.toLowerCase();
  if(A===B) return [[tokenIn, tokenOut]];
  if(A===WETH_MAINNET.toLowerCase() || B===WETH_MAINNET.toLowerCase()) return [[tokenIn, tokenOut]];
  const paths=[];
  if(await hasPair(tokenIn,tokenOut)) paths.push([tokenIn,tokenOut]);
  paths.push([tokenIn,WETH_MAINNET,tokenOut]);
  return uniqPaths(paths);
}
async function getEthReserveIfWethInvolved(path){
  try{
    const idx=path.findIndex(a=>a.toLowerCase()===WETH_MAINNET.toLowerCase());
    if(idx<0) return null;
    const other=(idx===0)?path[1]:path[idx-1];
    const pairAddr=await getPairAddressCached(WETH_MAINNET,other);
    if(!pairAddr || pairAddr===ethers.constants.AddressZero) return null;
    const pair=new ethers.Contract(pairAddr,PAIR_ABI,provider);
    const [r0,r1]=await pair.getReserves();
    const t0=(await pair.token0()).toLowerCase();
    const wethIs0=(t0===WETH_MAINNET.toLowerCase());
    const wethReserve=wethIs0 ? r0 : r1;
    return Number(ethers.utils.formatUnits(wethReserve,18));
  }catch{ return null; }
}
function recommendedSlippagePctByEthReserve(ethReserve){
  if(ethReserve==null) return null;
  if(ethReserve<0.2) return 25;
  if(ethReserve<0.5) return 15;
  if(ethReserve<1.0) return 10;
  if(ethReserve<2.0) return 6;
  return 3;
}
function bnFromInput(valStr, decimals){
  if(!valStr || Number(valStr)<=0) return ethers.constants.Zero;
  return ethers.utils.parseUnits(String(valStr), decimals);
}
function getSlipPct(){
  const slipInput=document.getElementById("slip");
  const v=slipInput ? Number(slipInput.value||"0") : 0;
  return Math.max(0,Math.min(95,v));
}
function calcOutMin(outBN, slipPct){
  const bp=Math.max(0,Math.min(9500,Math.floor(slipPct*100)));
  return outBN.mul(10000-bp).div(10000);
}
function feePctText(){
  const pct=(__proxyPERCENT_BPS||0)/100;
  return `Fee: ${pct.toFixed(2)}%`;
}
function flatFeeText(){
  try{
    const flat=__proxyFlatFeeWei || ethers.constants.Zero;
    return `Flat fee: ${ethers.utils.formatEther(flat)} ETH`;
  }catch{return `Flat fee: ‚Äî`;}
}
function applyPctFeeToEthAmount(amountInBN){
  const bps=Math.max(0,Number(__proxyPERCENT_BPS||0));
  if(!bps) return amountInBN;
  const feeBN=amountInBN.mul(bps).div(10000);
  if(amountInBN.lte(feeBN)) return ethers.constants.Zero;
  return amountInBN.sub(feeBN);
}

/* Quote preview */
let __quoteTimer=null;
async function updatePricePreview(){
  if(__quoteTimer) clearTimeout(__quoteTimer);
  __quoteTimer=setTimeout(async()=>{
    const sellInput=document.getElementById("sell");
    const buyInput=document.getElementById("buy");
    const sellValStr=(sellInput.value||"").trim();
    const hint=document.getElementById('slipHint');

    if(!sellValStr || Number(sellValStr)<=0){
      buyInput.value=""; if(hint) hint.textContent=""; return;
    }
    const sellMeta=getSelectedMeta(document.getElementById("sellS"));
    const buyMeta=getSelectedMeta(document.getElementById("buyS"));
    if(!sellMeta || !buyMeta) return;

    try{
      ensureWeb3(); await loadProxyFeeParams();
      const sellIsEth=metaIsETH(sellMeta), buyIsEth=metaIsETH(buyMeta);
      const amountInBN_raw=bnFromInput(sellValStr, sellMeta.decimals ?? 18);
      if(amountInBN_raw.lte(0)){ buyInput.value=""; return; }
      if(sellIsEth && buyIsEth){ buyInput.value=""; if(hint) hint.textContent="ETH ‚Üí ETH not supported"; return; }

      const tokenIn=addrForPath(sellMeta);
      const tokenOut=addrForPath(buyMeta);
      const paths=await getPathCandidates(tokenIn, tokenOut);
      if(!paths.length) throw new Error("No route candidates.");

      const amountForQuoteBN=sellIsEth ? applyPctFeeToEthAmount(amountInBN_raw) : amountInBN_raw;
      if(amountForQuoteBN.lte(0)){
        buyInput.value="";
        const feeTxt=sellIsEth?feePctText():flatFeeText();
        if(hint) hint.textContent=feeTxt;
        return;
      }

      let best=null;
      for(const path of paths){
        try{
          if(sellIsEth && path[0].toLowerCase()!==WETH_MAINNET.toLowerCase()) continue;
          const amounts=await sushiRouterRO.getAmountsOut(amountForQuoteBN, path);
          const out=amounts[amounts.length-1];
          if(!best || out.gt(best.out)) best={path,out};
        }catch{}
      }
      if(!best) throw new Error("No quote route found (liquidity).");
      const outStr=ethers.utils.formatUnits(best.out, buyMeta.decimals ?? 18);
      const outNum=Number(outStr);
      buyInput.value = Number.isFinite(outNum) ? (outNum>=1? outNum.toFixed(6) : outNum.toPrecision(6)) : outStr;

      const ethReserve=await getEthReserveIfWethInvolved(best.path);
      const rec=recommendedSlippagePctByEthReserve(ethReserve);
      const recTxt=(rec!=null)?`Recommended ~ ${rec}%`:"";
      const feeTxt=sellIsEth?feePctText():flatFeeText();
      if(hint) hint.textContent=[recTxt, feeTxt].filter(Boolean).join(" ¬∑ ");
    }catch(err){
      console.warn("[quote] failed",err);
      buyInput.value=""; if(hint) hint.textContent="";
    }finally{ updateStatusBoard(); }
  },120);
}

/* Approvals */
async function ensureAllowance(tokenMeta, amountInBN, spender){
  if(metaIsETH(tokenMeta)) return;
  if(!userAddress) throw new Error("Wallet not connected");
  const token=new ethers.Contract(tokenMeta.address, ERC20_ABI, signer);
  const allowance=await token.allowance(userAddress, spender);
  if(allowance.gte(amountInBN)) return;
  if(allowance.gt(0)){
    const tx0=await token.approve(spender, 0);
    await tx0.wait(1);
  }
  const tx=await token.approve(spender, ethers.constants.MaxUint256);
  await tx.wait(1);
}
async function ensureSufficientTokenBalance(tokenMeta, amountInBN){
  if(metaIsETH(tokenMeta)) return;
  const bn=await (new ethers.Contract(tokenMeta.address, ERC20_ABI, provider)).balanceOf(userAddress);
  if(bn.lt(amountInBN)){
    throw new Error(
      `Insufficient ${tokenMeta.symbol} balance.\n\nRequired: ${ethers.utils.formatUnits(amountInBN, tokenMeta.decimals ?? 18)}\nBalance: ${ethers.utils.formatUnits(bn, tokenMeta.decimals ?? 18)}`
    );
  }
}

function setSwapBusy(isBusy){
  const btn=document.getElementById("swapBtn");
  const conn=document.getElementById("swapConnect");
  if(btn){
    btn.disabled=!!isBusy;
    btn.style.opacity=isBusy?".75":"1";
    btn.textContent=isBusy?"Processing‚Ä¶":"Swap";
  }
  if(conn) conn.disabled=!!isBusy;
}

/* Tx log */
const __txLog=[];
function addTxLog(line){
  __txLog.unshift({t:Date.now(),...line});
  while(__txLog.length>30) __txLog.pop();
  renderTxLog();
}
function renderTxLog(){
  const box=document.getElementById("txLog"); if(!box) return;
  if(!__txLog.length){ box.innerHTML=`<div style="opacity:.78">No recent transactions yet.</div>`; return; }
  box.innerHTML=__txLog.map(x=>{
    const when=fmtAgo(x.t);
    const href=x.hash?`https://etherscan.io/tx/${x.hash}`:"";
    const title=x.title||"TX";
    const mode=x.mode?` ¬∑ ${x.mode}`:"";
    return `
      <div class="txLine">
        <div class="t">${when}</div>
        <div style="flex:1">
          <div style="font-weight:900;color:rgba(234,247,240,.92)">${title}${mode}</div>
          ${href ? `<a href="${href}" target="_blank" rel="noopener">${x.hash.slice(0,10)}‚Ä¶</a>` : `<div style="opacity:.74">${x.msg||""}</div>`}
        </div>
      </div>`;
  }).join("");
}

/* Swap execution */
function getDeadlineSeconds(){ return Math.floor(Date.now()/1000) + 60*20; }
function isEstimateOrRevert(e){
  const m=normalizeErr(e).toLowerCase();
  return m.includes("cannot estimate gas") || m.includes("unpredictable_gas_limit") || m.includes("execution reverted") || m.includes("revert");
}
async function chooseBestRoute(amountInBNForQuote, pathCandidates){
  let best=null;
  for(const path of pathCandidates){
    try{
      const amounts=await sushiRouterRO.getAmountsOut(amountInBNForQuote, path);
      const out=amounts[amounts.length-1];
      if(!best || out.gt(best.out)) best={path,out};
    }catch{}
  }
  return best;
}
async function ensureSufficientEthForValue(callValue, txReq=null){
  const bal=await provider.getBalance(userAddress);
  let need=callValue ?? ethers.constants.Zero;
  if(txReq){
    try{
      const gas=await provider.estimateGas({from:userAddress,...txReq,value:callValue});
      const gp=await provider.getGasPrice();
      need=need.add(gas.mul(gp));
    }catch{}
  }
  if(bal.lt(need)){
    throw new Error(`Insufficient ETH for fees.\n\nNeed (est): ${ethers.utils.formatEther(need)} ETH\nBalance: ${ethers.utils.formatEther(bal)} ETH`);
  }
}
async function swapViaDirect({sellMeta,buyMeta,amountInBN_raw,amountOutMinBN,path}){
  __lastSwapMode="Direct";
  const sellIsEth=metaIsETH(sellMeta);
  const buyIsEth=metaIsETH(buyMeta);
  const deadline=getDeadlineSeconds();

  if(!sellIsEth){
    await ensureSufficientTokenBalance(sellMeta, amountInBN_raw);
    await ensureAllowance(sellMeta, amountInBN_raw, SUSHI_ROUTER_V2);
  }

  if(sellIsEth){
    const overrides={value:amountInBN_raw};
    try{ overrides.gasLimit=await sushiRouterRW.estimateGas.swapExactETHForTokensSupportingFeeOnTransferTokens(amountOutMinBN,path,userAddress,deadline,overrides); }
    catch{ overrides.gasLimit=SAFE_GAS_DIRECT; }
    await ensureSufficientEthForValue(amountInBN_raw,null);
    return await withTimeout(
      sushiRouterRW.swapExactETHForTokensSupportingFeeOnTransferTokens(amountOutMinBN,path,userAddress,deadline,overrides),
      WALLET_CONFIRM_TIMEOUT_MS,"wallet_confirm_timeout"
    );
  }

  if(buyIsEth){
    const overrides={};
    try{ overrides.gasLimit=await sushiRouterRW.estimateGas.swapExactTokensForETHSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides); }
    catch{ overrides.gasLimit=SAFE_GAS_DIRECT; }
    return await withTimeout(
      sushiRouterRW.swapExactTokensForETHSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides),
      WALLET_CONFIRM_TIMEOUT_MS,"wallet_confirm_timeout"
    );
  }

  const overrides={};
  try{ overrides.gasLimit=await sushiRouterRW.estimateGas.swapExactTokensForTokensSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides); }
  catch{ overrides.gasLimit=SAFE_GAS_DIRECT; }
  return await withTimeout(
    sushiRouterRW.swapExactTokensForTokensSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides),
    WALLET_CONFIRM_TIMEOUT_MS,"wallet_confirm_timeout"
  );
}
async function swapViaProxy({sellMeta,buyMeta,amountInBN_raw,amountOutMinBN,path}){
  __lastSwapMode="Proxy";
  const sellIsEth=metaIsETH(sellMeta);
  const buyIsEth=metaIsETH(buyMeta);
  const deadline=getDeadlineSeconds();

  if(!sellIsEth){
    await ensureSufficientTokenBalance(sellMeta, amountInBN_raw);
    await ensureAllowance(sellMeta, amountInBN_raw, GDEX_PROXY_ROUTER);
  }

  const flat=(__proxyFlatFeeWei && ethers.BigNumber.isBigNumber(__proxyFlatFeeWei)) ? __proxyFlatFeeWei : ethers.constants.Zero;

  if(sellIsEth){
    const overrides={value:amountInBN_raw};
    try{ overrides.gasLimit=await proxyRouter.estimateGas.swapExactETHForTokensSupportingFeeOnTransferTokens(amountOutMinBN,path,userAddress,deadline,overrides); }
    catch{ overrides.gasLimit=SAFE_GAS_PROXY; }
    await ensureSufficientEthForValue(amountInBN_raw,null);
    return await withTimeout(
      proxyRouter.swapExactETHForTokensSupportingFeeOnTransferTokens(amountOutMinBN,path,userAddress,deadline,overrides),
      WALLET_CONFIRM_TIMEOUT_MS,"wallet_confirm_timeout"
    );
  }

  const overrides={value:flat};
  await ensureSufficientEthForValue(flat,null);

  if(buyIsEth){
    try{ overrides.gasLimit=await proxyRouter.estimateGas.swapExactTokensForETHSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides); }
    catch{ overrides.gasLimit=SAFE_GAS_PROXY; }
    return await withTimeout(
      proxyRouter.swapExactTokensForETHSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides),
      WALLET_CONFIRM_TIMEOUT_MS,"wallet_confirm_timeout"
    );
  }

  try{ overrides.gasLimit=await proxyRouter.estimateGas.swapExactTokensForTokensSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides); }
  catch{ overrides.gasLimit=SAFE_GAS_PROXY; }
  return await withTimeout(
    proxyRouter.swapExactTokensForTokensSupportingFeeOnTransferTokens(amountInBN_raw,amountOutMinBN,path,userAddress,deadline,overrides),
    WALLET_CONFIRM_TIMEOUT_MS,"wallet_confirm_timeout"
  );
}

/* (2)(3) ÏôÑÎ£åÏãú Î¶¨ÏÖã + ÏßÑÌñâÎ¨∏Íµ¨ Í∞ïÌôî */
function resetSwapForm(){
  const sell=document.getElementById("sell");
  const buy=document.getElementById("buy");
  const hint=document.getElementById("slipHint");
  if(sell) sell.value="";
  if(buy) buy.value="";
  if(hint) hint.textContent="";
  // ÏÉÅÌÉúÏ∞ΩÏùÄ Ïú†ÏßÄ (ÏôÑÎ£å ÏïàÎÇ¥ ÎÇ®ÍπÄ)
}
async function executeSwap(){
  let used="‚Äî", tx=null;
  try{
    setSwapBusy(true);
    setSwapStatus(`1/5 Preparing‚Ä¶ (checking wallet, network, and fees)`,{show:true,kind:"info"});

    if(!userAddress){ setSwapStatus(`1/5 Connecting wallet‚Ä¶`,{show:true,kind:"info"}); await connectWallet(); }
    await ensureMainnet();
    ensureWeb3();
    await loadProxyFeeParams();

    const sellInput=document.getElementById("sell");
    const sellValStr=(sellInput.value||"").trim();
    if(!sellValStr || Number(sellValStr)<=0) throw new Error("Enter an amount to swap.");

    const sellMeta=getSelectedMeta(document.getElementById("sellS"));
    const buyMeta=getSelectedMeta(document.getElementById("buyS"));
    if(!sellMeta || !buyMeta) throw new Error("Token selection error.");

    const sellIsEth=metaIsETH(sellMeta);
    const buyIsEth=metaIsETH(buyMeta);
    if(sellIsEth && buyIsEth) throw new Error("ETH ‚Üí ETH not supported.");

    const amountInBN_raw=bnFromInput(sellValStr, sellMeta.decimals ?? 18);
    if(amountInBN_raw.lte(0)) throw new Error("Invalid amount.");

    const tokenIn=addrForPath(sellMeta);
    const tokenOut=addrForPath(buyMeta);
    const paths=await getPathCandidates(tokenIn, tokenOut);
    if(!paths.length) throw new Error("No route candidates.");

    const amountForQuoteBN=sellIsEth ? applyPctFeeToEthAmount(amountInBN_raw) : amountInBN_raw;
    if(amountForQuoteBN.lte(0)) throw new Error("Amount too small after fee.");

    setSwapStatus(`2/5 Calculating route‚Ä¶`,{show:true,kind:"info"});
    const best=await chooseBestRoute(amountForQuoteBN, paths);
    if(!best) throw new Error("No quote route found (liquidity).");

    const slip=getSlipPct();
    const amountOutMinBN=calcOutMin(best.out, slip);
    const path=best.path;

    setSwapStatus(`3/5 Please confirm the transaction in your wallet‚Ä¶`,{show:true,kind:"info"});

    // Try Proxy first
    used="Proxy";
    try{
      if(SWAP_SILENT) setSwapStatus(`3/5 Trying proxy route‚Ä¶ (will auto-switch to direct if unavailable)`,{show:true,kind:"info"});
      tx=await swapViaProxy({sellMeta,buyMeta,amountInBN_raw,amountOutMinBN,path});
    }catch(e){
      used="Direct"; __lastSwapMode="Direct";
      if(SWAP_SILENT || isEstimateOrRevert(e)){
        setSwapStatus(`Proxy route unavailable ‚Üí switching to Sushi direct route‚Ä¶`,{show:true,kind:"info"});
        tx=await swapViaDirect({sellMeta,buyMeta,amountInBN_raw,amountOutMinBN,path});
      }else{
        const ok=await uiConfirm("Proxy route failed",`Proxy failed with:\n${normalizeErr(e)}\n\nTry Direct Sushi route instead?`,{okText:"Try Direct",cancelText:"Cancel",copy:true});
        if(!ok) throw e;
        tx=await swapViaDirect({sellMeta,buyMeta,amountInBN_raw,amountOutMinBN,path});
      }
    }

    if(!tx || !tx.hash) throw new Error("Transaction not created.");

    addTxLog({title:"Swap sent",hash:tx.hash,mode:used});
    setSwapStatus(`4/5 Transaction sent. Waiting for confirmation‚Ä¶ <span class="spin">‚è≥</span><br>
      ‚Ä¢ Route: <b>${used}</b><br>
      ‚Ä¢ TX: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener">View on Etherscan</a>`,
      {show:true,kind:"info"}
    );

    const receipt=await tx.wait(1).catch(()=>null);

    if(receipt && receipt.status===0){
      addTxLog({title:"Swap reverted",hash:tx.hash,mode:used});
      setSwapStatus(`Swap could not be completed (reverted).<br>
        ‚Ä¢ Route: <b>${used}</b><br>
        ‚Ä¢ TX: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener">View on Etherscan</a>`,
        {show:true,kind:"error"}
      );
      return;
    }

    addTxLog({title:"Swap confirmed",hash:tx.hash,mode:used});
    setSwapStatus(`5/5 Swap confirmed ‚úÖ<br>
      ‚Ä¢ Route: <b>${used}</b><br>
      ‚Ä¢ TX: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener">View on Etherscan</a>`,
      {show:true,kind:"success"}
    );

    resetSwapForm();
    await refreshAllBalances();
    updatePricePreview();
  }catch(e){
    console.error('[executeSwap]',e);
    if(isUserRejected(e)){
      setSwapStatus(`Canceled in wallet. No changes were made.`,{show:true,kind:"error"});
    }else{
      setSwapStatus(`Swap failed.<br><span style="opacity:.9">${normalizeErr(e)}</span>`,{show:true,kind:"error"});
      showErrorPopup("Swap failed", e);
    }
  }finally{
    setSwapBusy(false);
    updateStatusBoard();
  }
}

/* MAX buttons */
function setInputValue(el, v){
  if(!el) return;
  el.value = v;
  el.dispatchEvent(new Event('input',{bubbles:true}));
  el.dispatchEvent(new Event('change',{bubbles:true}));
}
function bindMax(){
  const swapMax=document.getElementById("swapMax");
  if(swapMax) swapMax.addEventListener("click", ()=>{
    const sellMeta=getSelectedMeta(document.getElementById("sellS"));
    const balEl=document.getElementById("sellBal");
    const raw=balEl?.dataset?.raw || "";
    if(!raw || !sellMeta) return;
    // ETHÎäî Í∞ÄÏä§ Ïó¨Ïú† ÎÇ®Í∏∞Í∏∞ (0.002 ETH)
    let val=Number(raw);
    if(metaIsETH(sellMeta)) val=Math.max(0, val-0.002);
    if(!Number.isFinite(val) || val<=0) return;
    setInputValue(document.getElementById("sell"), String(val));
    updatePricePreview();
  });

  const stakeMax=document.getElementById("stakeMax");
  if(stakeMax) stakeMax.addEventListener("click", ()=>{
    const sb=document.getElementById("stakeBalText");
    const raw=sb?.dataset?.raw || "";
    const v=Number(raw);
    if(!Number.isFinite(v) || v<=0) return;
    setInputValue(document.getElementById("stakeAmt"), String(v));
  });
}

/* Status board */
function setPill(el, ok, text){
  if(!el) return;
  el.textContent=text;
  el.classList.remove('ok','bad');
  el.classList.add(ok?'ok':'bad');
}
function updateStatusBoard(){
  const stBoot=$("#stBoot"), stBootSub=$("#stBootSub");
  const stWallet=$("#stWallet"), stWalletSub=$("#stWalletSub");
  const stNet=$("#stNet"), stNetSub=$("#stNetSub");
  const stRoute=$("#stRoute"), stRouteSub=$("#stRouteSub");
  const stSources=$("#stSources"), stSourcesSub=$("#stSourcesSub");

  const pillWallet=$("#pillWallet"), pillNet=$("#pillNet"), pillBackend=$("#pillBackend"), pillCG=$("#pillCG");

  // Boot
  const bootOk=__bootOk && !__bootErr;
  if(stBoot) stBoot.textContent=bootOk ? "OK" : "Check";
  if(stBootSub) stBootSub.textContent=bootOk ? "UI loaded" : (__bootErr ? normalizeErr(__bootErr) : "Initializing‚Ä¶");

  // Wallet
  const hasWallet=!!window.ethereum;
  const connected=!!userAddress;
  if(stWallet) stWallet.textContent=hasWallet ? (connected ? "Connected" : "Detected") : "Not found";
  if(stWalletSub) stWalletSub.textContent=hasWallet ? (connected ? short(userAddress) : "Connect to trade") : (isMobile ? "Use MetaMask in-app browser" : "Install MetaMask");
  if(pillWallet) setPill(pillWallet, hasWallet && connected, connected ? "Wallet: Connected" : (hasWallet ? "Wallet: Detected" : "Wallet: Missing"));

  // Network
  let netOk=false;
  if(provider && connected){
    provider.getNetwork().then(net=>{
      netOk = (net && net.chainId===1);
      if(stNet) stNet.textContent=netOk ? "Ethereum Mainnet" : `Wrong (${net?.chainId||"‚Äî"})`;
      if(stNetSub) stNetSub.textContent=netOk ? "Ready" : "Please switch to Mainnet";
      if(pillNet) setPill(pillNet, netOk, netOk ? "Mainnet" : "Wrong network");
    }).catch(()=>{
      if(stNet) stNet.textContent="‚Äî";
      if(stNetSub) stNetSub.textContent="‚Äî";
      if(pillNet) setPill(pillNet, false, "Network");
    });
  }else{
    if(stNet) stNet.textContent="‚Äî";
    if(stNetSub) stNetSub.textContent="Connect wallet";
    if(pillNet) setPill(pillNet, false, "Network");
  }

  // Routing (proxy fee loaded?)
  const routeOk = !!proxyRouter;
  if(stRoute) stRoute.textContent = routeOk ? "Ready" : "‚Äî";
  if(stRouteSub) stRouteSub.textContent = __proxyFeeLoaded ? (`Proxy fee loaded ¬∑ ${feePctText()}`) : "Proxy fee params: pending";
  // Sources
  const backendOk = (__backendOk!==false);
  const cgOk = (__cgOk!==false);
  if(stSources) stSources.textContent = (backendOk && cgOk) ? "OK" : "Partial";
  if(stSourcesSub) stSourcesSub.textContent = `Backend: ${backendOk?"OK":"Fail"} ¬∑ CoinGecko: ${cgOk?"OK":"Fail"}`;
  if(pillBackend) setPill(pillBackend, backendOk, backendOk ? "Backend OK" : "Backend Fail");
  if(pillCG) setPill(pillCG, cgOk, cgOk ? "CoinGecko OK" : "CoinGecko Fail");
}
function buildDiagnostic(){
  const lines=[];
  lines.push("G-DEX Diagnostic");
  lines.push("‚Äî");
  lines.push(`Host: ${location.host}`);
  lines.push(`UA: ${navigator.userAgent}`);
  lines.push(`Wallet detected: ${!!window.ethereum}`);
  lines.push(`Connected: ${!!userAddress} ${userAddress?("(" + userAddress + ")"):""}`);
  lines.push(`Last route: ${__lastSwapMode}`);
  lines.push(`Proxy fee loaded: ${__proxyFeeLoaded}`);
  if(__proxyFeeLoaded){
    lines.push(`PERCENT_BPS: ${__proxyPERCENT_BPS}`);
    try{ lines.push(`flatFeeWei: ${ethers.utils.formatEther(__proxyFlatFeeWei||ethers.constants.Zero)} ETH`); }catch{}
    lines.push(`feeRecipient: ${__proxyFeeWallet||"‚Äî"}`);
  }
  lines.push(`Backend OK: ${__backendOk}`);
  lines.push(`CoinGecko OK: ${__cgOk}`);
  lines.push(`Backend last: ${__backendLastAt? new Date(__backendLastAt).toISOString() : "‚Äî"}`);
  lines.push(`CG last: ${__cgLastAt? new Date(__cgLastAt).toISOString() : "‚Äî"}`);
  return lines.join("\n");
}

/* Bindings */
function bindButtons(){
  const swapConnect=$("#swapConnect");
  const poolConnect=$("#poolConnect");
  const btnConn=$("#btnConn");
  const btnSwap=$("#swapBtn");

  if(swapConnect) swapConnect.addEventListener("click", connectWallet);
  if(poolConnect) poolConnect.addEventListener("click", connectWallet);
  if(btnConn) btnConn.addEventListener("click", connectWallet);

  if(btnSwap) btnSwap.addEventListener("click", executeSwap);

  const sell=$("#sell");
  const slip=$("#slip");
  if(sell) sell.addEventListener("input", updatePricePreview);
  if(slip) slip.addEventListener("input", updatePricePreview);

  const installSide=$("#installSide");
  const installMain=$("#installMain");
  if(installSide) installSide.addEventListener("click", handleInstallClick);
  if(installMain) installMain.addEventListener("click", handleInstallClick);

  const btnRefresh=$("#btnRefreshStatus");
  if(btnRefresh) btnRefresh.addEventListener("click", async ()=>{
    await refreshAllBalances();
    await loadProxyFeeParams();
    updatePricePreview();
    updateStatusBoard();
    uiAlert("Status refreshed","Balances, fee params, and tickers were refreshed.");
  });

  const btnCopy=$("#btnCopyDiag");
  if(btnCopy) btnCopy.addEventListener("click", async ()=>{
    const txt=buildDiagnostic();
    try{
      await navigator.clipboard.writeText(txt);
      uiAlert("Copied","Diagnostic copied to clipboard.");
    }catch{
      uiAlert("Diagnostic",txt,{copy:true});
    }
  });

  // Stake demo buttons
  const btnStake=$("#btnStake"), btnClaim=$("#btnClaim"), tabStake=$("#tabStake"), tabUnstake=$("#tabUnstake");
  if(tabStake) tabStake.addEventListener("click", ()=>uiAlert("Stake","Staking is in preview mode (demo)."));
  if(tabUnstake) tabUnstake.addEventListener("click", ()=>uiAlert("Unstake","Unstaking is in preview mode (demo)."));
  if(btnStake) btnStake.addEventListener("click", ()=>uiAlert("Stake (Demo)","Staking will be enabled in G-DEX v2 after routing is stabilized."));
  if(btnClaim) btnClaim.addEventListener("click", ()=>uiAlert("Claim (Demo)","Rewards claiming will be enabled in G-DEX v2."));
}

/* Boot */
async function boot(){
  try{
    initDefaults();
    renderTokenList("");
    bindTokenButtons();
    bindFlip();
    bindPoolSupplyButton();
    bindPoolQuickButtons();
    bindTop();
    bindMetricFillActions();
    bindButtons();
    bindMax();

    // Analytics demo render
    fillKpis(demoAnalytics);
    drawSpark(demoAnalytics);
    drawDonut(demoAnalytics);
    drawGauge(demoAnalytics);

    // Tickers
    bootSushiPoolsTicker();
    bootMajorCoinPricesTicker();

    __bootOk=true;
  }catch(e){
    __bootOk=false; __bootErr=e;
    console.error("[boot]",e);
  }finally{
    updateStatusBoard();
  }
}

boot();
</script>
</body>
</html>
<br><br>



